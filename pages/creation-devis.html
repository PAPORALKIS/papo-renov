<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Création devis – Papo Rénov</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/papo-renov/style.css">
</head>
<body>
  <header class="pr-header">
    <div class="brand">
      <img class="logo" src="/papo-renov/logo.png" alt="Logo Papo Rénov">
      <h1>Espace privé – Papo Rénov</h1>
    </div>
    <nav>
      <a href="../index.html">← Retour au site</a>
    </nav>
  </header>
  <div class="private-root">
    <div class="modal-new-client show" style="position: static; inset: auto; padding-top: 0; background: none;">
      <div class="modal-panel">
        <h3>Nouveau devis</h3>
        <form id="form-devis" autocomplete="off">
          <div class="modal-grid">
            <div>
              <label for="client">Client</label>
              <input id="client" name="client" type="text" placeholder="Nom du client / Entreprise" required>
            </div>
            <div>
              <label for="date">Date</label>
              <input id="date" name="date_devis" type="date">
            </div>
          </div>
          <div>
            <label for="adresse">Adresse / Contexte</label>
            <textarea id="adresse" name="commentaire" placeholder="Adresse du projet, informations complémentaires…"></textarea>
          </div>
          <br>
          <table id="lines-table">
            <thead>
              <tr>
                <th>Tâche</th>
                <th>Qté</th>
                <th>Prix&nbsp;HT</th>
              </tr>
            </thead>
            <tbody id="lines-body">
              <!-- Lignes du devis insérées ici -->
            </tbody>
          </table>
          <button type="button" class="btn-secondary" id="btn-add-line">+ Ajouter une ligne</button>
          <div style="margin-top: 12px; text-align: right;">
            <p>Total HT : <span id="total-ht">0.00</span> €</p>
            <p>TVA (20%) : <span id="total-tva">0.00</span> €</p>
            <p>Total TTC : <span id="total-ttc">0.00</span> €</p>
          </div>
          <div id="devis-message"></div>
          <div class="modal-actions">
            <button type="submit" class="btn-primary" id="btn-save-devis">Enregistrer le devis</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyemfjgPUxJhhYPkGvf4WGtCogUJgDW1ZfmPdZ3KTvf0b-9QpjQAqUjYzCQKQW6MOsg/exec";
    let tasksList = [];

    // Fonction pour charger les tâches disponibles via l'API Apps Script
    async function fetchTasks() {
      try {
        const response = await fetch(`${WEB_APP_URL}?path=bo&resource=tarifs`);
        const data = await response.json();
        if (!data.ok) {
          throw new Error("Erreur lors du chargement des tâches");
        }
        // Récupère la liste des tâches (tableau d'objets)
        tasksList = data.rows || data;
        // Ajoute une première ligne de devis par défaut
        addLine();
      } catch (err) {
        console.error(err);
      }
    }

    // Ajoute une ligne de devis au tableau (avec menu déroulant des tâches)
    function addLine() {
      if (!tasksList || tasksList.length === 0) return;
      const tbody = document.getElementById('lines-body');
      // Crée la ligne (tr)
      const tr = document.createElement('tr');
      // Colonne "Tâche" (sélection)
      const tdTask = document.createElement('td');
      const select = document.createElement('select');
      select.name = "tache";
      // Option par défaut vide
      const defaultOption = document.createElement('option');
      defaultOption.value = "";
      defaultOption.textContent = "-- Choisir une tâche --";
      select.appendChild(defaultOption);
      // Remplit le select avec les tâches disponibles
      if (tasksList.length > 0) {
        // Détecte les propriétés de nom et de prix dans l'objet tâche
        const sample = tasksList[0];
        const keys = Object.keys(sample);
        let nameKey = keys.find(k => /tâche|tache|libellé|libelle|nom/i.test(k)) || keys[0];
        let priceKey = keys.find(k => /prix|tarif|price/i.test(k));
        if (!priceKey) {
          // Si aucune clé "prix" trouvée, utilise la seconde clé à défaut
          priceKey = keys[1] || keys[0];
        }
        tasksList.forEach(task => {
          const opt = document.createElement('option');
          opt.value = task[nameKey] || "";
          opt.textContent = task[nameKey] || "";
          if (task[priceKey] !== undefined) {
            opt.dataset.prix = task[priceKey];
          }
          select.appendChild(opt);
        });
      }
      tdTask.appendChild(select);
      tr.appendChild(tdTask);
      // Colonne "Qté" (input nombre)
      const tdQty = document.createElement('td');
      const inputQty = document.createElement('input');
      inputQty.name = "qte";
      inputQty.type = "number";
      inputQty.min = "0";
      inputQty.value = "1";
      tdQty.appendChild(inputQty);
      tr.appendChild(tdQty);
      // Colonne "Prix" (input nombre)
      const tdPrice = document.createElement('td');
      const inputPrice = document.createElement('input');
      inputPrice.name = "prix";
      inputPrice.type = "number";
      inputPrice.step = "0.01";
      inputPrice.value = "";
      tdPrice.appendChild(inputPrice);
      tr.appendChild(tdPrice);
      // Ajoute la ligne au tableau
      tbody.appendChild(tr);
      // Événements pour recalculer le total quand Qté ou Prix changent
      inputQty.addEventListener('input', calculateTotals);
      inputPrice.addEventListener('input', calculateTotals);
      // Événement pour mettre à jour le prix lors de la sélection d'une tâche
      select.addEventListener('change', function() {
        if (this.selectedIndex > 0) {
          const prix = this.selectedOptions[0].dataset.prix || "";
          inputPrice.value = prix;
        } else {
          inputPrice.value = "";
        }
        calculateTotals();
      });
    }

    // Calcule et met à jour les totaux HT, TVA et TTC
    function calculateTotals() {
      let totalHT = 0;
      document.querySelectorAll('#lines-body tr').forEach(row => {
        const qty = parseFloat(row.querySelector('input[name="qte"]').value) || 0;
        const price = parseFloat(row.querySelector('input[name="prix"]').value) || 0;
        totalHT += qty * price;
      });
      // Arrondi à 2 décimales
      totalHT = Math.round(totalHT * 100) / 100;
      const totalTVA = Math.round(totalHT * 0.20 * 100) / 100;
      const totalTTC = Math.round((totalHT + totalTVA) * 100) / 100;
      document.getElementById('total-ht').textContent = totalHT.toFixed(2);
      document.getElementById('total-tva').textContent = totalTVA.toFixed(2);
      document.getElementById('total-ttc').textContent = totalTTC.toFixed(2);
    }

    // Soumission du formulaire "Enregistrer le devis"
    async function saveDevis(event) {
      event.preventDefault();
      const saveBtn = document.getElementById('btn-save-devis');
      saveBtn.disabled = true;
      // Récupère les champs principaux
      const client = document.getElementById('client').value.trim();
      const date = document.getElementById('date').value;
      const adresse = document.getElementById('adresse').value.trim();
      // Prépare les paramètres de la requête POST
      const params = new URLSearchParams();
      params.append('path', 'bo');
      params.append('action', 'create_devis');
      if (client) params.append('client', client);
      if (date) params.append('date_devis', date);
      params.append('montant_ht', document.getElementById('total-ht').textContent.replace(',', '.'));
      params.append('montant_ttc', document.getElementById('total-ttc').textContent.replace(',', '.'));
      if (adresse) params.append('commentaire', adresse);
      // Ajoute les lignes du devis au paramètre (sous forme de JSON)
      const lines = [];
      document.querySelectorAll('#lines-body tr').forEach(row => {
        const task = row.querySelector('select[name="tache"]').value;
        const qty = parseFloat(row.querySelector('input[name="qte"]').value) || 0;
        const price = parseFloat(row.querySelector('input[name="prix"]').value) || 0;
        if (task && qty && price) {
          lines.push({ tache: task, qte: qty, prix: price });
        }
      });
      if (lines.length > 0) {
        params.append('lignes', JSON.stringify(lines));
      }
      try {
        const resp = await fetch(WEB_APP_URL, { method: 'POST', body: params });
        const result = await resp.json();
        if (result.ok) {
          document.getElementById('devis-message').style.color = '#22c55e';
          document.getElementById('devis-message').textContent = '✅ Devis enregistré (ID: ' + (result.id_devis || '') + ')';
          // Réinitialise le formulaire après succès
          document.getElementById('form-devis').reset();
          document.getElementById('lines-body').innerHTML = '';
          calculateTotals();
        } else {
          throw new Error(result.error || "Une erreur est survenue lors de l'enregistrement.");
        }
      } catch (err) {
        console.error(err);
        document.getElementById('devis-message').style.color = '#ef4444';
        document.getElementById('devis-message').textContent = 'Erreur : ' + err.message;
      } finally {
        saveBtn.disabled = false;
      }
    }

    // Initialisation au chargement de la page
    window.addEventListener('DOMContentLoaded', () => {
      // Date du jour par défaut
      const dateField = document.getElementById('date');
      if (dateField) {
        dateField.value = new Date().toISOString().split('T')[0];
      }
      // Charge les tâches et prépare les événements
      fetchTasks();
      document.getElementById('btn-add-line').addEventListener('click', addLine);
      document.getElementById('form-devis').addEventListener('submit', saveDevis);
    });
  </script>
</body>
</html>
