<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grille Tarifaire Professionnelle - Papo R√©nov</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* =============== Reset & Variables =============== */
:root{
  --primary:#0a1f44;
  --secondary:#ffc107;
  --bg:#f4f7fa;
  --panel:#fff;
  --muted:#6c757d;
  --ok:#28a745;
  --border:#e9ecef;
  --shadow:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
html,body{overflow-x:hidden}
body{
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:#111;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* =============== HEADER (identique aux autres pages) =============== */
header{
  background:#fff;
  padding:10px 20px;
  box-shadow:0 2px 4px rgba(0,0,0,.16);
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  position:sticky; top:0; z-index:50;
}
.logo img{max-height:50px;width:auto}
header nav{ flex:1 1 auto; min-width:0; }
nav ul{
  list-style:none; margin:0; padding:0;
  display:flex; gap:20px;
  overflow-x:auto;
  -ms-overflow-style:none; scrollbar-width:none;
  white-space:nowrap;
  -webkit-overflow-scrolling:touch;
}
nav ul::-webkit-scrollbar{display:none}
nav ul li a{
  text-decoration:none;
  color:#003366;
  font-weight:600;
  white-space:nowrap;
  padding:5px 0;
  transition:color .25s;
}
nav ul li a:hover{color:var(--primary)}
nav ul li a.active{color:#007bff; font-weight:700; text-decoration:underline}

/* =============== Carte / Contenu =============== */
.card{
  width:min(1200px,100%);
  background:var(--panel);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  margin:20px auto 30px;
}

/* =============== En-t√™te panneau PRO =============== */
.header{
  display:flex; justify-content:space-between; align-items:center; gap:12px;
  padding:20px 24px; border-bottom:2px solid var(--primary);
  background:var(--primary); color:#fff;
}
.header-left{display:flex; align-items:center; gap:12px; min-width:0}
.header img{height:45px; filter:brightness(0) invert(1); flex-shrink:0}
.header h1{
  font-size:clamp(1.15rem,1.6vw,1.5rem);
  margin:0; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.badge{background:var(--secondary); color:#000; padding:5px 10px; border-radius:6px; font-weight:700}

/* =============== Zone s√©curis√©e =============== */
.secure-area{padding:22px}
.notice{color:var(--muted); text-align:center; margin:0 0 16px}
.form{display:flex; gap:10px; justify-content:center; margin:8px 0 22px; flex-wrap:wrap}
.form input{
  flex:1 1 260px; max-width:320px; padding:12px 14px;
  border:1px solid var(--border); border-radius:12px; font-size:1rem;
}
.form input:focus{border-color:var(--primary); outline:none}
.form button{
  padding:12px 16px; border-radius:12px; border:none;
  background:var(--secondary); color:var(--primary); font-weight:700; cursor:pointer;
  min-width:160px;
}
.form button:hover{background:#ffda6a}
.error{color:#dc3545; text-align:center; min-height:20px; margin-bottom:10px}

/* =============== Tabs & contenu =============== */
#partner-content{padding-top:10px; display:none}
.tab-nav{
  display:flex; justify-content:center; gap:6px; margin-bottom:16px;
  border-bottom:1px solid var(--border); padding:0 10px 6px;
  overflow-x:auto; scrollbar-width:none;
}
.tab-nav::-webkit-scrollbar{display:none}
.tab-nav button{
  background:none; border:none; padding:10px 14px; cursor:pointer;
  font-size:.98rem; font-weight:600; color:var(--muted);
  border-bottom:3px solid transparent; white-space:nowrap;
}
.tab-nav button.active{color:var(--primary); border-bottom-color:var(--primary)}
.tab-content{padding:0 10px 10px}

/* ======== Promo & Compteur Partenaire ======== */
.promo-banner{
  background:linear-gradient(135deg,var(--secondary),#ffd65a);
  color:#111; border:2px dashed var(--primary); border-radius:14px;
  padding:12px 16px; margin:8px 10px 16px; box-shadow:var(--shadow);
  display:flex; align-items:center; gap:12px; flex-wrap:wrap
}
.promo-banner b{color:#0a1f44}
.promo-banner small{opacity:.9}

.partner-kpis{
  display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:12px; padding:0 10px 12px;
}
.kpi{
  background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
}
.kpi h4{margin:0 0 6px; font-size:1rem; color:var(--primary)}
.kpi .val{font:700 1.6rem/1 'Roboto Mono',monospace; color:#0a1f44}
.kpi .sub{font-size:.85rem; color:var(--muted)}

.partner-ops{
  display:flex; flex-wrap:wrap; gap:10px; padding:0 10px 14px
}
.partner-ops input[type="text"]{
  flex:1 1 260px; max-width:340px; padding:10px 12px; border:1px solid var(--border);
  border-radius:10px; font-size:.98rem
}
.partner-ops button{
  padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; border:1px solid var(--primary);
  background:#fff; color:var(--primary)
}
.partner-ops button.primary{background:var(--primary); color:#fff; border:none}
.partner-ops button.warn{border-color:#dc3545; color:#dc3545}
.partner-ops .hint{font-size:.9rem; color:var(--muted)}

/* =============== Grilles de tarifs (cards) =============== */
.sheets{
  /* Utilisation de CSS Columns pour un effet ma√ßonnerie (pas de blanc). */
  -webkit-column-width: 320px; /* Safari/Chrome */
  -moz-column-width: 320px;    /* Firefox */
  column-width: 320px; /* Largeur minimale de la carte/colonne (pour avoir de grandes fiches) */
  column-gap: 22px; /* Espace entre les colonnes/cartes */
  margin-bottom: 0; 
  padding: 0 10px;
  width: 100%; 
  max-width: 100%;
}
.sheet{
  background:var(--panel); border:1px solid var(--border); border-radius:14px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  padding:16px; display:flex; flex-direction:column;
  /* PROPRI√âT√âS CL√âS POUR MA√áONNERIE */
  break-inside: avoid; 
  page-break-inside: avoid; /* Double protection pour le flux */
  margin-bottom: 22px; /* Ajoute l'espacement vertical (qui √©tait le gap du grid) */
  width: 100%; /* La carte occupe toute la largeur de sa colonne */
  /* --- */
  transform-style:none; perspective:none;
  transition:transform .3s ease, box-shadow .3s ease;
  border-top: 4px solid var(--primary); /* Ligne d'accentuation en haut */
}
.sheet:hover{
  /* Effet de survol plus propre (l√©ger soul√®vement) */
  transform:translateY(-5px);
  box-shadow:0 20px 40px rgba(0,0,0,.15);
}
/* Style pour mettre une carte en avant */
.sheet.featured{
    border-top: 6px solid var(--secondary); /* Accentuation jaune pour la carte en vedette */
    transform: scale(1.02);
}
.sheet.featured:hover{
    transform: translateY(-6px) scale(1.02);
    box-shadow: 0 25px 50px rgba(0,0,0,.2);
}
.sheet .head{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px}
.sheet h3{font-size:1.1rem; margin:0; color:var(--primary)}
.sheet p{color:var(--muted); font-size:.9rem; margin:4px 0 10px}
/* Am√©lioration de la pr√©sentation du prix "√Ä partir de" */
.sheet .from{
  font-size:1.25rem; font-weight:800; color:var(--primary); /* Augment√© en taille et couleur */
  margin-bottom:12px; padding-bottom:10px;
  border-bottom:2px solid var(--border); /* Ligne de s√©paration plus marqu√©e */
}
.list{list-style:none; padding:0; margin:0; flex-grow:1}
.list li{
  /* Grille principale 2 colonnes (Nom | Wrapper Prix/Qt√©) */
  display:grid; grid-template-columns:1fr auto; 
  align-items:center; gap:15px; 
  font-size:.95rem; padding:10px 0; border-bottom:1px dashed var(--border);
}
.list li:last-child{border-bottom:none}
.list li strong{
    /* Price element styling */
    font-family:'Roboto Mono',monospace; font-weight:700; color:var(--primary); white-space:nowrap;
    text-align: right;
}

/* === Champs quantit√© + bouton global === */
.qty-wrap{
    /* Affichage interne du wrapper pour aligner Prix et Input */
    display:flex; align-items:center; gap:15px; /* Espace entre Prix et Input */
}
.qty-input{
  width:74px; padding:6px 8px; border:1px solid #ccc; border-radius:6px; 
  font-family:'Roboto Mono',monospace; text-align:right;
  background: var(--bg); 
}
.bulk-add{
  display:flex; justify-content:flex-end; padding:6px 2px 0;
}
#btn-add-selected{
  padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700;
  background:var(--primary); color:#fff;
}
#btn-add-selected:hover{background:#17386b}

/* =============== Devis rapide =============== */
#devis-rapide-tab{padding:16px 8px 20px}

.devis-header{
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
  border-bottom:2px solid var(--primary); padding-bottom:10px; margin-bottom:14px;
}

#partner-logo-preview{max-height:46px; max-width:160px; display:none}

.devis-actions{display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px}
.devis-actions button, .devis-actions input[type="file"] + label{
  padding:10px 14px; border-radius:8px; font-weight:600; cursor:pointer; border:1px solid var(--primary)
}
#print-devis,#clear-devis{background:var(--primary); color:#fff; border:none}
input[type="file"]{display:none}
.file-upload-label{background:#fff; color:var(--primary); display:inline-block}

/* Table responsive : scroll interne uniquement */
.table-responsive{
  width:100%;
  overflow-x:auto; -webkit-overflow-scrolling:touch;
  border:1px solid var(--border); border-radius:8px; background:#fff;
}
.devis-table{width:100%; border-collapse:collapse; min-width:720px}
.devis-table th,.devis-table td{border-bottom:1px solid var(--border); padding:10px; text-align:left; vertical-align:middle}
.devis-table th{background:#e9eff6; font-weight:600; color:var(--primary)}
.devis-table input[type="number"]{width:70px; padding:6px 8px; border:1px solid var(--border); border-radius:6px; text-align:right; font-family:'Roboto Mono',monospace}
.devis-table .unit-price{text-align:right; font-family:'Roboto Mono',monospace; font-weight:600; white-space:nowrap}
.devis-table .total-row,.devis-table .subtotal-cell{text-align:right; font-family:'Roboto Mono',monospace; font-weight:600}
.devis-table .subtotal-cell{background:#f7f7f7}

/* Totaux */
.devis-totals{display:flex; justify-content:flex-end; padding:8px 0}
.totals-box{width:100%; max-width:420px; border:2px solid var(--primary); border-radius:8px; padding:12px; background:#fff}
.totals-box p{display:flex; justify-content:space-between; margin:8px 0; font-size:1rem}
.totals-box .final{font-size:1.2rem; font-weight:700; color:var(--primary); border-top:1px solid var(--border); padding-top:8px; margin-top:8px}

/* Footer */
.footer{
  padding:12px 18px; border-top:1px solid var(--border); background:#fcfcfc;
  display:flex; justify-content:space-between; align-items:center; gap:10px; font-size:.92rem; flex-wrap:wrap
}
.footer a{color:var(--primary); font-weight:600; text-decoration:none}
.footer a:hover{color:var(--secondary)}

/* =============== Media queries (Responsiveness) =============== */
@media (max-width:992px){
  /* Ajuste la largeur minimale des colonnes pour les tablettes */
  .sheets{
    -webkit-column-width: 300px;
    -moz-column-width: 300px;
    column-width: 300px; 
    column-gap: 18px; 
    padding: 0 10px;
  }
  .sheet{padding:14px; margin-bottom: 18px;}
  .header{padding:16px}
}

@media (max-width:768px){
  nav ul{
    flex-wrap:nowrap;
  } 
  nav ul li a{font-size:.9rem}
  .card{margin:10px auto 15px}
  .header{padding:16px 20px}
  .header h1{font-size:1.3rem}
  /* R√©duit la largeur minimale des colonnes sur mobile/petit √©cran */
  .sheets{
    -webkit-column-width: 280px;
    -moz-column-width: 280px;
    column-width: 280px; 
    column-gap: 16px; 
    padding: 0 10px;
  }
  .sheet{margin-bottom: 16px;}
  .header-left h1{white-space:normal}
  .form{gap:8px}
  .form button{width:100%}
  .bulk-add{justify-content:center}
  
  /* Ajustement du filtre sur mobile */
  #filter-container{
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
  }
  #category-checkboxes{
      width: 100%;
      padding: 8px;
  }
}

/* NOUVEAU: R√©activit√© pour les listes de tarifs sur petits √©crans */
@media (max-width:450px){
    /* Le li devient une seule colonne (Service Name | Qty/Price Wrapper) */
    .list li{
        grid-template-columns: 1fr; 
        gap: 4px;
        padding: 10px 0 14px; 
    }
    /* Le wrapper Prix/Quantit√© s'√©tend sur toute la largeur et espace ses enfants */
    .qty-wrap{
        justify-content: space-between; /* Pour s√©parer le Prix et l'Input */
        width: 100%;
        gap: 10px; 
    }
  .header{flex-direction:column; align-items:flex-start; gap:8px}
  .badge{align-self:flex-end}
  .devis-actions button,.file-upload-label{flex:1 1 160px; text-align:center}
  .totals-box{max-width:100%}
  .form input{min-width:0; width:100%}
  .header img{height:36px}
}

@media (max-width:600px){
  .header{flex-direction:column; align-items:flex-start; gap:8px}
  .badge{align-self:flex-end}
  .devis-actions button,.file-upload-label{flex:1 1 160px; text-align:center}
  .totals-box{max-width:100%}
}
@media (max-width:420px){
  .form input{min-width:0; width:100%}
  .header img{height:36px}
}

/* =============== Impression =============== */
@media print{
  header,.header,.tab-nav,.footer,.devis-actions,.list li .qty-wrap,.secure-area>.notice,.secure-area>.form,.secure-area>.error,
  .devis-table input,.devis-table button, #filter-container{display:none !important}
  /* >>> AJOUT : ne jamais imprimer l'offre partenaire ni le compteur <<< */
  .promo-banner,.partner-ops,.partner-kpis{display:none !important;}

  .card{width:100%; box-shadow:none; margin:0; border-radius:0}
  .client-fields{display:none !important;}
  .table-responsive{overflow: visible !important; border: 1px solid #ccc !important;}
  .devis-table{
    width: 100% !important; min-width: 0 !important; table-layout: auto !important; border-collapse: collapse !important;
  }
  .devis-table thead{ display: table-header-group !important; }
  .devis-table tfoot{ display: table-footer-group !important; }
  .devis-table tr{ break-inside: avoid !important; page-break-inside: avoid !important; }
  .devis-table th, .devis-table td{ white-space: normal !important; word-break: break-word !important; }
  .devis-table thead th:last-child,
  .devis-table tbody td:last-child,
  .devis-table tfoot td:last-child{ display: none !important; }
  #devis-rapide-tab{padding:0}
  #partner-content{display:block !important; padding-top:0}
  .devis-table th,.devis-table td{border-color:#ccc !important}

  /* Logo + titres impression */
  #partner-logo-preview {max-height: 100px !important; max-width: 300px !important; display: block !important; margin: 0 auto 10px auto !important; text-align: center;}
  .devis-header {display: block !important; text-align: center !important;}
  .devis-header .devis-titles {display: block !important; margin-top: 6px !important;}
  .devis-header h3.devis-rapide-title {font-size: 1.2rem !important; margin: 0 !important; color: #000 !important; text-transform: uppercase;}
  #partner-info-print {display: block !important; text-align: center !important; margin-top: 8px !important; font-size: 0.95rem !important; line-height: 1.4; color: #333 !important;}
}

/* --- D√©tails de prestation (notes) --- */
/* (AJOUT 1/3) */
.list li.has-notes { cursor: pointer; }
.list li.has-notes .task-line { display:flex; align-items:flex-start; gap:8px; }
.list li .note {
  display:none;
  grid-column: 1 / -1;
  margin-top:8px;
  padding:10px 12px;
  border-left:3px solid var(--primary);
  background:#f8f9fb;
  color:#333;
  border-radius:6px;
  font-size:.92rem;
}
.list li.open .note { display:block; }
.list li.has-notes .task-label::after{ content:" ‚ñæ"; font-weight:700; color:var(--primary); }
.list li.open .task-label::after{ content:" ‚ñ¥"; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="../img/logo.png" alt="Logo Papo R√©nov">
  </div>
  <nav>
    <ul>
      <li><a href="../index.html">Accueil</a></li>
      <li><a href="devis.html">Demande de devis</a></li>
      <li><a href="realisations.html">Mes r√©alisations</a></li>
      <li><a href="tarifs.html">Tarifs</a></li>
      <li><a href="planning.html">Planning</a></li>
      <li><a class="active" href="tarifs-partenaire.html">Espace PRO</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="avis.html">Avis clients</a></li>
      <li><a href="courtage-cuisine.html">Courtage Cuisine</a></li>
    </ul>
  </nav>
</header>
<!-- =========================================== -->

<div class="card">
  <div class="header">
    <div class="header-left">
      <img src="../img/logo.png" alt="Papo R√©nov">
      <h1>Grille Tarifaire Professionnelle</h1>
    </div>
    <span class="badge">Acc√®s Partenaire PRO</span>
    <span id="data-source-badge" class="badge" style="background:#e9ecef;color:#0a1f44;">Source: ‚Äî</span>
  </div>

  <div class="secure-area">
    <p class="notice">Veuillez entrer le <strong>code d‚Äôacc√®s professionnel</strong> pour consulter l'int√©gralit√© des tarifs et outils d√©di√©s.</p>
    <div class="form">
      <input id="code" type="password" placeholder="Code d‚Äôacc√®s PRO" autocomplete="off" required>
      <button id="enter">Acc√©der</button>
    </div>
    <div id="error" class="error"></div>

    <div id="partner-content" style="display:none">

      <!-- ===== Pancarte Promo Partenaire ===== -->
      <div class="promo-banner" id="promo-banner" style="display:none;">
        <span style="font-size:1.4rem;">üéØ</span>
        <div>
          <div><b>OFFRE PARTENAIRE :</b> <b>1 jour de pose OFFERT</b> toutes les <b>5 poses r√©alis√©es sans SAV</b>. <b>Cumulable.</b></div>
          <small>La journ√©e offerte s‚Äôapplique sur une pose planifi√©e d‚Äô1 jour. Conditions d√©taill√©es sur bon d‚Äôintervention.</small>
        </div>
      </div>

      <!-- ===== Compteur Par Partenaire ===== -->
      <div class="partner-ops" id="partner-ops" style="display:none;">
        <input id="partner-id" type="text" placeholder="Identifiant partenaire (ex. nom, email, code)" />
        <button class="primary" id="btn-load-partner">Charger / Cr√©er</button>
        <button id="btn-add-assigned">+ 1 pose attribu√©e</button>
        <button id="btn-add-done-nosav">+ 1 pose r√©alis√©e SANS SAV</button>
        <button class="warn" id="btn-undo">Annuler la derni√®re action</button>
        <span class="hint">Astuce : l‚ÄôID sert de cl√© (statistiques locales par partenaire).</span>
      </div>

      <div class="partner-kpis" id="partner-kpis" style="display:none;">
        <div class="kpi">
          <h4>Poses attribu√©es</h4>
          <div class="val" id="kpi-assigned">0</div>
          <div class="sub">Cumul depuis l‚Äôactivation</div>
        </div>
        <div class="kpi">
          <h4>R√©alis√©es SANS SAV</h4>
          <div class="val" id="kpi-nosav">0</div>
          <div class="sub">Cl√¥tur√©es sans retour SAV</div>
        </div>
        <div class="kpi">
          <h4>Jours offerts</h4>
          <div class="val" id="kpi-rewards">0</div>
          <div class="sub">1 jour offert / 5 poses sans SAV ‚Äî cumulable</div>
        </div>
        <div class="kpi">
          <h4>Prochain palier</h4>
          <div class="val"><span id="kpi-next">5</span> restantes</div>
          <div class="sub">Avant le prochain jour offert</div>
        </div>
      </div>

      <div class="tab-nav">
        <button class="tab-btn active" data-tab="tarifs-pro-tab">Grille Tarifaire D√©taill√©e</button>
        <button class="tab-btn" data-tab="devis-rapide-tab">G√©n√©rateur de Devis Rapide</button>
      </div>

      <div class="tab-content">
        <!-- ===== Onglet Tarifs ===== -->
        <div id="tarifs-pro-tab" class="tab-pane active">
          <p class="notice" style="margin-bottom:18px;">
            <strong>Tarifs Partenaires NETS (Hors Taxes)</strong> ‚Äî Valables sur volume et r√©currence. Mat√©riaux non inclus (sauf mention F+M.O.).
          </p>

          <div id="filter-container" style="display:none; flex-direction:column; margin-bottom:16px; padding:0 10px;">
            <p style="margin:0 0 8px; font-weight:600;">Filtrer les fiches (S√©lection multiple) :</p>
            <div id="category-checkboxes" style="display:flex; flex-wrap:wrap; gap:12px 18px; padding:10px; border:1px solid var(--border); border-radius:8px; background:#f8f9fa;">
                </div>
          </div>
          
          <div class="sheets" id="partner-sheets">
            <!-- Inject√© dynamiquement depuis API Sheets ou JSON local -->
          </div>

          <div class="bulk-add">
            <button id="btn-add-selected">‚ûï Ajouter au devis</button>
          </div>
        </div>

        <!-- ===== Onglet Devis ===== -->
        <div id="devis-rapide-tab" class="tab-pane" style="display:none;">
          <div class="devis-header">
            <img id="partner-logo-preview" src="" alt="Logo Partenaire" />
            <div class="devis-titles">
               <h3 class="devis-rapide-title">DEVIS ESTIMATIF - <span id="partner-name-display">Votre Client</span></h3>
            </div>
          </div>

          <!-- Saisie coordonn√©es client (√©cran) -->
          <div class="client-fields" style="display:block; margin:12px 0;">
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;">
              <input id="client-nom" type="text" placeholder="Nom / Soci√©t√© du client">
              <input id="client-email" type="email" placeholder="Email du client">
              <input id="client-tel" type="text" placeholder="T√©l√©phone du client">
              <input id="client-adresse" type="text" placeholder="Adresse du client">
            </div>
          </div>

          <!-- Bloc impression -->
          <div id="partner-info-print" style="display:none;">
            <div style="margin-top:6px;">
              <div><strong>Client :</strong> <span id="print-client-nom">‚Äî</span></div>
              <div><strong>Email :</strong> <span id="print-client-email">‚Äî</span></div>
              <div><strong>T√©l√©phone :</strong> <span id="print-client-tel">‚Äî</span></div>
              <div><strong>Adresse :</strong> <span id="print-client-adresse">‚Äî</span></div>
            </div>
          </div>

          <div class="devis-actions">
            <button id="print-devis">üñ®Ô∏è Imprimer / Enregistrer en PDF</button>
            <button id="clear-devis">üóëÔ∏è Vider le Devis</button>
            <input type="file" id="logo-upload" accept="image/*">
            <label for="logo-upload" class="file-upload-label">üîó Ajouter votre Logo</label>
          </div>

          <div class="table-responsive">
            <table class="devis-table">
              <thead>
                <tr>
                  <th>Prestation</th>
                  <th>Quantit√©</th>
                  <th>Prix Unitaire HT (‚Ç¨)</th>
                  <th>Unit√©</th>
                  <th>Total HT</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="devis-lines"></tbody>
              <tfoot>
                <tr id="devis-subtotal-row" style="display:none;">
                  <td colspan="4" style="text-align:right;"><strong>Sous-Total HT (M.O. Estim√©e) :</strong></td>
                  <td class="subtotal-cell"><span id="subtotal">0.00 ‚Ç¨</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="devis-totals">
            <div class="totals-box">
              <p>Sous-Total (HT) : <span id="total-mo">0.00 ‚Ç¨</span></p>
              <p>Total HT : <span id="total-ht">0.00 ‚Ç¨</span></p>
              <p>TVA (20%) : <span id="tva">0.00 ‚Ç¨</span></p>
              <p class="final">TOTAL TTC : <span id="total-ttc">0.00 ‚Ç¨</span></p>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <a href="tarifs.html">‚Üê Retour Tarifs Publics</a>
        <span>Documentation PRO et Mat√©riaux : Acc√®s ici</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const ACCESS_CODE = "PROPAPO2025!";

/* === URL de l‚ÄôAPI Apps Script (ton d√©ploiement WebApp) === */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbww7_mLiUesnyQQHbQjwto1XsbtePXVW0UHU_sLYFLqCOFd0diTanXBWJVCqpePADzwow/exec';

/* ================== DOM HOOKS ================== */
const inputCode = document.getElementById('code');
const btnEnter = document.getElementById('btn-enter') || document.getElementById('enter');
const errorDiv = document.getElementById('error');
const partnerContent = document.getElementById('partner-content');
const noticeText = document.querySelector('.secure-area > .notice');
const secureForm = document.querySelector('.form');
const tabButtons = document.querySelectorAll('.tab-btn');
const tabPanes = document.querySelectorAll('.tab-pane');

const devisLines = document.getElementById('devis-lines');
const subtotalSpan = document.getElementById('subtotal');
const totalMOEl = document.getElementById('total-mo');
const totalHTEl = document.getElementById('total-ht');
const tvaEl = document.getElementById('tva');
const totalTTCEl = document.getElementById('total-ttc');
const printButton = document.getElementById('print-devis');
const clearButton = document.getElementById('clear-devis');
const logoUpload = document.getElementById('logo-upload');
const logoPreview = document.getElementById('partner-logo-preview');

/* Filtres */
const categoryCheckboxes = document.getElementById('category-checkboxes');
const filterContainer = document.getElementById('filter-container');
const dataSourceBadge = document.getElementById('data-source-badge');

/* ================== STATE ================== */
let devisCart = [];
const TVA_RATE = 0.20;
let UNIQUE_CATEGORIES = [];

/* ================== ACCESS & INITIAL LOAD ================== */
async function handleAccess(){
  const val = (inputCode.value||'').trim();
  if(!val){ errorDiv.textContent="Veuillez saisir le code d‚Äôacc√®s professionnel."; return; }
  if(val === ACCESS_CODE){
    errorDiv.textContent="";
    partnerContent.style.display='block';
    secureForm.style.display='none';
    noticeText.textContent="ACC√àS PRO CONFIRM√â ‚Äî Bienvenue Partenaire !";
    noticeText.style.color='var(--primary)';
    noticeText.style.fontWeight='600';
    document.getElementById('tarifs-pro-tab').style.display='block';
    await loadTarifs();
    showPartnerPromoIfOpen();
  }else{
    errorDiv.textContent="Code PRO invalide. Veuillez v√©rifier vos identifiants.";
  }
}

/* ================== TABS ================== */
function switchTab(targetId){
  tabPanes.forEach(p=>{p.style.display='none'; p.classList.remove('active');});
  tabButtons.forEach(b=>b.classList.remove('active'));
  const pane=document.getElementById(targetId);
  if(pane){ pane.style.display='block'; pane.classList.add('active'); }
  const btn=document.querySelector(`.tab-btn[data-tab="${targetId}"]`);
  if(btn) btn.classList.add('active');

  const ids = ['promo-banner','partner-ops','partner-kpis'];
  if(targetId==='devis-rapide-tab'){
    ids.forEach(id=>{
      const el=document.getElementById(id);
      if(el){
        el.dataset.prevDisplay = el.dataset.prevDisplay ?? (el.style.display || '');
        el.style.display='none';
      }
    });
    // Cache le filtre quand on est sur l'onglet devis
    filterContainer.style.display = 'none';
  } else {
    ids.forEach(id=>{
      const el=document.getElementById(id);
      if(el && el.dataset.prevDisplay!==undefined){
        el.style.display = el.dataset.prevDisplay;
        delete el.dataset.prevDisplay;
      }
    });
    // Affiche le filtre (si des cat√©gories existent) quand on revient aux tarifs
    if(UNIQUE_CATEGORIES.length > 0) filterContainer.style.display = 'flex';
  }
}

/* ================== RENDER TARIFS (depuis API / JSON) ================== */
function euro(x){
  if(x===null || x===undefined || isNaN(x)) return '‚Äî';
  return (parseFloat(x).toFixed(2)+' ‚Ç¨').replace('.00','');
}
function inferUnit(u, label){
  const t=(u||'').toLowerCase();
  if(t) return t;
  const L=(label||'').toLowerCase();
  if(L.includes('m¬≤')||L.includes('m2')) return 'm¬≤';
  if(L.includes('/u')||L.includes('unit√©')||L.includes('unite')||L.includes('u.')) return 'u';
  if(L.includes('jr')||L.includes('jour')) return 'jr';
  return 'forfait';
}
function cleanTask(t){
  return (t||'').replace(/\s*\((M\.O\.|F\+M\.O\.|M\.O\.\/\s*\S+)\s*\)/gi,'').trim();
}

function setDataSourceBadge(txt){
  if(dataSourceBadge) dataSourceBadge.textContent = txt;
}

/* ======== Charge API puis fallback JSON local ======== */
async function loadTarifs(){
  let dataObj = null;

  /* 1) API dynamique */
  if (WEB_APP_URL && WEB_APP_URL.startsWith('http')) {
    try{
      const r = await fetch(`${WEB_APP_URL}?path=tarifs`, { cache:'no-store' });
      if(r.ok){
        const j = await r.json();
        const arr = Array.isArray(j) ? j : (j.tarifs || []);
        if (arr.length){
          const grouped = {};
          arr.forEach(t=>{
            const cat = (t.categorie || 'Autres').toString();
            if(!grouped[cat]) grouped[cat] = [];
            grouped[cat].push({
              task: t.tache || '',
              price_min: (typeof t.prix_min === 'number') ? t.prix_min : (t.prix_min ? parseFloat(String(t.prix_min).replace(',','.')) : null),
              unit: t.unite || '',
              notes: t.notes || ''
            });
          });
          dataObj = grouped;
          setDataSourceBadge(`Source: API Sheets (${Object.keys(grouped).length} cat√©gories)`);
        }
      }
    }catch(e){
      console.warn('API dynamique indisponible ‚Üí on tente le JSON local.', e);
    }
  }

  /* 2) Fallback : JSON statique */
  if(!dataObj){
    const candidates = [
      './PAPORENOV-Tarifs.json',
      'PAPORENOV-Tarifs.json'
    ];
    for(const url of candidates){
      try{
        const r = await fetch(url, {cache:'no-store'});
        if(r.ok){
          const data = await r.json();
          dataObj = Array.isArray(data) ? { 'Tarifs': data } : data;
          if (dataObj){
            setDataSourceBadge(`Source: JSON local (${Object.keys(dataObj).length} cat√©gories)`);
            break;
          }
        }
      }catch(e){}
    }
  }

  /* 3) Rien trouv√© */
  if(!dataObj){
    document.getElementById('partner-sheets').innerHTML =
      `<div style="padding:14px; border:1px dashed var(--border); border-radius:10px; background:#fff;">
        Impossible de charger <code>PAPORENOV-Tarifs.json</code> / API Sheets.<br>
        Place le fichier JSON √† c√¥t√© de cette page ou v√©rifie le d√©ploiement.
      </div>`;
    filterContainer.style.display = 'none';
    setDataSourceBadge('Source: ‚ùå Aucune (API/JSON)');
    return;
  }
  
  // Cat√©gories + rendu
  UNIQUE_CATEGORIES = Object.keys(dataObj);
  populateFilter(UNIQUE_CATEGORIES);
  renderSheets(dataObj);
}

function renderSheets(data){
  const container = document.getElementById('partner-sheets');
  container.innerHTML = '';

  Object.keys(data).forEach(sheetName=>{
    const items = (data[sheetName]||[]).filter(x=>x && x.task);
    if(!items.length) return;

    const mins = items.map(x=> typeof x.price_min==='number' ? x.price_min : null).filter(x=>x!==null);
    const from = mins.length ? Math.min(...mins) : null;

    const art = document.createElement('article');
    art.className = 'sheet';
    art.dataset.category = sheetName;

    const head = document.createElement('div');
    head.className = 'head';
    head.innerHTML = `<h3>${sheetName}</h3>`;
    art.appendChild(head);

    const p = document.createElement('p');
    p.textContent = 'Main d‚Äô≈ìuvre (M.O.) | R√©f√©rence: prix min par prestation';
    art.appendChild(p);

    const fromEl = document.createElement('div');
    fromEl.className = 'from';
    fromEl.textContent = from !== null ? `√Ä partir de ${euro(from)} HT` : `Tarifs sur devis`;
    art.appendChild(fromEl);

    const ul = document.createElement('ul');
    ul.className = 'list';

    /* ---- Rendu de chaque ligne avec notes repli√©es (AJOUT 2/3) ---- */
    items.forEach(it=>{
      const name = cleanTask(it.task);
      const pu = (typeof it.price_min==='number') ? it.price_min : null;
      const unit = inferUnit(it.unit, it.task);
      const notes = (it.notes || '').trim();

      const li = document.createElement('li');
      li.dataset.presta = name;

      const headLine = document.createElement('div');
      headLine.className = 'task-line';

      const left = document.createElement('span');
      left.className = 'task-label';
      left.textContent = name;

      const qtyWrap = document.createElement('div');
      qtyWrap.className = 'qty-wrap';

      const strong = document.createElement('strong');
      strong.textContent = pu!==null ? `${euro(pu)}/${unit}` : `P.U. ‚Äî`;

      const input = document.createElement('input');
      input.type='number'; input.min='0'; input.placeholder='0';
      input.className='qty-input';
      input.dataset.price = (pu!==null ? pu : 0);
      input.dataset.unit = unit;

      qtyWrap.appendChild(strong);
      qtyWrap.appendChild(input);

      headLine.appendChild(left);
      headLine.appendChild(qtyWrap);
      li.appendChild(headLine);

      if (notes){
        li.classList.add('has-notes');
        const note = document.createElement('div');
        note.className = 'note';
        note.textContent = notes;
        li.appendChild(note);
      }

      ul.appendChild(li);
    });
    /* ---- Fin AJOUT 2/3 ---- */

    art.appendChild(ul);
    container.appendChild(art);
  });
  
  applyFilter();
}

/* ================== FILTERS ================== */
function populateFilter(categories){
    if(categories.length > 0) {
        filterContainer.style.display = 'flex';
        categoryCheckboxes.innerHTML = '';

        const allToggle = document.createElement('label');
        allToggle.innerHTML = `<input type="checkbox" id="check-all-categories" checked> <strong>Toutes</strong>`;
        allToggle.style.marginRight = '20px';
        categoryCheckboxes.appendChild(allToggle);
        
        categories.sort().forEach(cat => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" class="category-filter-checkbox" value="${cat}" checked> ${cat}`;
            categoryCheckboxes.appendChild(label);
        });

        // 3. √âv√©nements
        document.getElementById('check-all-categories').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.category-filter-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });
            applyFilter();
        });
        
        document.querySelectorAll('.category-filter-checkbox').forEach(cb => {
            cb.addEventListener('change', () => {
                // Si on d√©coche une case, d√©s√©lectionner "Toutes"
                if (!cb.checked) {
                    document.getElementById('check-all-categories').checked = false;
                }
                // Si toutes les cases sont coch√©es, cocher "Toutes"
                const allChecked = Array.from(document.querySelectorAll('.category-filter-checkbox')).every(c => c.checked);
                if (allChecked) {
                    document.getElementById('check-all-categories').checked = true;
                }
                applyFilter();
            });
        });
    } else {
        filterContainer.style.display = 'none';
    }
}

function applyFilter(){
    // R√©cup√®re toutes les cat√©gories dont la case est coch√©e
    const selectedCategories = Array.from(document.querySelectorAll('.category-filter-checkbox:checked')).map(cb => cb.value);
    
    const sheets = document.querySelectorAll('#partner-sheets .sheet');
    
    // Si aucune cat√©gorie n'est s√©lectionn√©e, tout cacher
    if (selectedCategories.length === 0) {
        sheets.forEach(sheet => sheet.style.display = 'none');
        return;
    }

    sheets.forEach(sheet => {
        const sheetCategory = sheet.dataset.category;
        
        // Affiche la fiche si sa cat√©gorie est dans la liste des cat√©gories s√©lectionn√©es
        if (selectedCategories.includes(sheetCategory)) {
            sheet.style.display = 'flex'; 
        } else {
            sheet.style.display = 'none'; 
        }
    });
}

/* ================== AJOUT GLOBAL AU DEVIS ================== */
function addSelectedPrestations(){
  const inputs = document.querySelectorAll('#tarifs-pro-tab .qty-input');
  let addedCount = 0;
  inputs.forEach(inp=>{
    const qty = parseFloat(inp.value || '0');
    if(!qty || qty <= 0) return;
    const li = inp.closest('li'); if(!li) return;
    const nameRaw = li.dataset.presta || (li.querySelector('span')?.textContent || '').trim();
    const name = nameRaw.replace(/\s\(M\.O\.\s*\/\s*\S+\)|\s\(M\.O\.\)|\s\(F\+M\.O\.\)/g,'').trim();
    const unitPrice = parseFloat(inp.dataset.price || '0') || 0;
    const unit = (inp.dataset.unit || 'forfait');
    const existing = devisCart.find(i=>i.name===name && i.unit===unit && i.unitPrice===parseFloat(unitPrice.toFixed(2)));
    if(existing){ existing.quantity += qty; }
    else{
      devisCart.push({ name, quantity: qty, unitPrice: parseFloat(unitPrice.toFixed(2)), unit });
    }
    inp.value = ''; addedCount++;
  });
  if(addedCount===0){ alert("Aucune quantit√© renseign√©e. Indique au moins 1 ligne avec une quantit√© > 0."); return; }
  renderDevis();
  switchTab('devis-rapide-tab');
}

/* ================== DEVIS RENDER ================== */
function updateQuantity(el,i){
  let q=parseFloat(el.value);
  if(isNaN(q)||q<0){ q=0; el.value=0; }
  if(q===0){ removePrestation(i); } else { devisCart[i].quantity=q; renderDevis(); }
}
function updateUnitPrice(el,i){
  let p=parseFloat(el.value);
  if(isNaN(p)||p<0){ p=devisCart[i].unitPrice; el.value=p.toFixed(2); }
  devisCart[i].unitPrice=parseFloat(p.toFixed(2));
  renderDevis();
}
function removePrestation(i){ devisCart.splice(i,1); renderDevis(); }

function renderDevis(){
  const tbody=devisLines; tbody.innerHTML='';
  let subtotal=0;
  if(devisCart.length===0){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center; color:var(--muted);">Aucune prestation ajout√©e. Ajoutez des quantit√©s dans la Grille Tarifaire puis cliquez ‚ÄúAjouter au devis‚Äù.</td></tr>';
  }
  devisCart.forEach((it,i)=>{
    const total=it.quantity*it.unitPrice; subtotal+=total;
    const row=tbody.insertRow();
    row.innerHTML=`
      <td>${it.name}</td>
      <td><input type="number" min="0" step="0.01" value="${it.quantity}" onchange="updateQuantity(this,${i})"></td>
      <td class="unit-price"><input type="number" min="0" step="0.01" value="${it.unitPrice.toFixed(2)}" onchange="updateUnitPrice(this,${i})"></td>
      <td>${it.unit}</td>
      <td class="total-row">${total.toFixed(2)} ‚Ç¨</td>
      <td><button style="color:#dc3545; border:1px solid #dc3545; background:transparent; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="removePrestation(${i})">Supprimer</button></td>
    `;
  });
  const tva=subtotal*TVA_RATE, ttc=subtotal+tva;
  subtotalSpan.textContent=subtotal.toFixed(2)+' ‚Ç¨';
  totalMOEl.textContent=subtotal.toFixed(2)+' ‚Ç¨';
  totalHTEl.textContent=subtotal.toFixed(2)+' ‚Ç¨';
  tvaEl.textContent=tva.toFixed(2)+' ‚Ç¨';
  totalTTCEl.textContent=ttc.toFixed(2)+' ‚Ç¨';
}

/* ================== MISC ================== */
function clearDevis(){
  if(confirm("√ätes-vous s√ªr de vouloir vider le devis ? Cette action est irr√©versible.")){
    devisCart=[]; renderDevis();
    logoPreview.src=''; logoPreview.style.display='none';
    document.getElementById('logo-upload').value='';
    alert("Le devis a √©t√© vid√©.");
  }
}
function handleLogoUpload(e){
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ logoPreview.src=ev.target.result; logoPreview.style.display='block'; };
  r.readAsDataURL(f);
}
function showPartnerPromoIfOpen(){
  const pc = document.getElementById('partner-content');
  if (pc && pc.style.display === 'block') {
    document.getElementById('promo-banner').style.display = 'flex';
    document.getElementById('partner-ops').style.display = 'flex';
  }
}

/* ================== Events ================== */
btnEnter?.addEventListener('click', handleAccess);
inputCode.addEventListener('keydown', e=>{ if(e.key==='Enter') handleAccess(); });
tabButtons.forEach(b=>b.addEventListener('click', e=>switchTab(e.currentTarget.dataset.tab)));
document.getElementById('btn-add-selected')?.addEventListener('click', addSelectedPrestations);
printButton?.addEventListener('click', ()=>window.print());
clearButton?.addEventListener('click', clearDevis);
logoUpload?.addEventListener('change', handleLogoUpload);
document.addEventListener('DOMContentLoaded', renderDevis);

/* Expose pour inline events */
window.updateQuantity=updateQuantity;
window.updateUnitPrice=updateUnitPrice;
window.removePrestation=removePrestation;
window.clearDevis=clearDevis;
</script>

<script>
// Champs client ‚Üí impression + titre
const clientNomEl = document.getElementById('client-nom');
const clientEmailEl = document.getElementById('client-email');
const clientTelEl = document.getElementById('client-tel');
const clientAdresseEl = document.getElementById('client-adresse');

// Hooks affichage impression + titre
const printNom = document.getElementById('print-client-nom');
const printEmail = document.getElementById('print-client-email');
const printTel = document.getElementById('print-client-tel');
const printAdr = document.getElementById('print-client-adresse');
const partnerNameDisplay = document.getElementById('partner-name-display');

function syncClientFields(){
  const nom = (clientNomEl?.value || '').trim();
  const email = (clientEmailEl?.value || '').trim();
  const tel = (clientTelEl?.value || '').trim();
  const adr = (clientAdresseEl?.value || '').trim();

  if (printNom)   printNom.textContent   = nom || '‚Äî';
  if (printEmail) printEmail.textContent = email || '‚Äî';
  if (printTel)   printTel.textContent   = tel || '‚Äî';
  if (printAdr)   printAdr.textContent   = adr || '‚Äî';

  if (partnerNameDisplay) partnerNameDisplay.textContent = nom || 'Votre Client';
}

[clientNomEl, clientEmailEl, clientTelEl, clientAdresseEl].forEach(el=>{
  el && el.addEventListener('input', syncClientFields);
});
document.addEventListener('DOMContentLoaded', syncClientFields);
</script>

<script>
/* ======== Compteur Partenaire (localStorage) ======== */
const PROMO_THRESHOLD = 5; // 1 jour offert toutes les 5 poses SANS SAV
const partnerBanner = document.getElementById('promo-banner');
const partnerOps = document.getElementById('partner-ops');
const partnerKpis = document.getElementById('partner-kpis');
const partnerIdInput = document.getElementById('partner-id');
const btnLoadPartner = document.getElementById('btn-load-partner');
const btnAddAssigned = document.getElementById('btn-add-assigned');
const btnAddDoneNoSav = document.getElementById('btn-add-done-nosav');
const btnUndo = document.getElementById('btn-undo');

const kpiAssigned = document.getElementById('kpi-assigned');
const kpiNoSav = document.getElementById('kpi-nosav');
const kpiRewards = document.getElementById('kpi-rewards');
const kpiNext = document.getElementById('kpi-next');

let CURRENT_PARTNER = null;
let LAST_ACTION_STACK = []; // pour undo (pile simple)

function storageKey(pid){ return `partnerStats::${pid}`; }
function defaultStats(){ return { assigned:0, doneNoSav:0, history:[] }; }
function loadStats(pid){ const raw = localStorage.getItem(storageKey(pid)); return raw ? JSON.parse(raw) : defaultStats(); }
function saveStats(pid, stats){ localStorage.setItem(storageKey(pid), JSON.stringify(stats)); }

function computeRewards(doneNoSav){
  const rewards = Math.floor(doneNoSav / PROMO_THRESHOLD);
  const next = PROMO_THRESHOLD - (doneNoSav % PROMO_THRESHOLD || 0);
  return { rewards, toNext: (doneNoSav % PROMO_THRESHOLD === 0) ? PROMO_THRESHOLD : next };
}

async function refreshUI(){
  const visible = !!CURRENT_PARTNER;
  partnerOps.style.display   = visible ? 'flex' : 'none';
  partnerKpis.style.display  = visible ? 'grid' : 'none';
  partnerBanner.style.display= visible ? 'flex' : 'none';
  if(!visible) return;

  try{
    const r = await fetch(`${WEB_APP_URL}?path=partner_get&pid=${encodeURIComponent(CURRENT_PARTNER)}`, { cache:'no-store' });
    const j = await r.json();
    const s = j.ok ? (j.stats || {assigned:0,doneNoSav:0}) : {assigned:0,doneNoSav:0};

    // m√™mes calculs qu‚Äôavant, mais sur les donn√©es serveur
    const rewards = Math.floor(s.doneNoSav / PROMO_THRESHOLD);
    const toNext  = PROMO_THRESHOLD - (s.doneNoSav % PROMO_THRESHOLD || 0);

    kpiAssigned.textContent = s.assigned;
    kpiNoSav.textContent    = s.doneNoSav;
    kpiRewards.textContent  = rewards;
    kpiNext.textContent     = (s.doneNoSav % PROMO_THRESHOLD === 0) ? PROMO_THRESHOLD : toNext;

    partnerBanner.style.borderColor = (toNext === PROMO_THRESHOLD) ? 'var(--ok)' : 'var(--primary)';
  }catch(e){
    // silencieux si l'API tombe ‚Äî on ne casse rien en UI
  }
}


async function ensurePartner(){
  const pid = (partnerIdInput.value||'').trim();
  if(!pid){ alert("Renseigne l‚Äôidentifiant partenaire (nom, email ou code)."); return; }

  const base = WEB_APP_URL; // d√©j√† d√©fini chez toi
  // cr√©e si absent (idempotent), sinon ne fait rien
  await fetch(`${base}?path=partner_create&pid=${encodeURIComponent(pid)}`, { cache:'no-store' });

  // charge les stats
  const r = await fetch(`${base}?path=partner_get&pid=${encodeURIComponent(pid)}`, { cache:'no-store' });
  const j = await r.json();
  if(!j.ok){ alert("Impossible de charger le profil partenaire."); return; }

  CURRENT_PARTNER = pid;
  const s = j.stats||{assigned:0,doneNoSav:0};
  kpiAssigned.textContent = s.assigned;
  kpiNoSav.textContent    = s.doneNoSav;

  const rewards = Math.floor(s.doneNoSav / PROMO_THRESHOLD);
  const toNext  = PROMO_THRESHOLD - (s.doneNoSav % PROMO_THRESHOLD || 0);
  kpiRewards.textContent = rewards;
  kpiNext.textContent    = (s.doneNoSav % PROMO_THRESHOLD === 0) ? PROMO_THRESHOLD : toNext;

  document.getElementById('partner-kpis').style.display='grid';
}


async function addAssigned(){
  const pid = CURRENT_PARTNER || (partnerIdInput.value||'').trim();
  if(!pid){ alert("Charge d‚Äôabord un partenaire."); return; }
  const admin = prompt("Code admin (obligatoire) :","");
  if(!admin){ alert("Action r√©serv√©e √† l‚Äôadmin."); return; }

  const params = new URLSearchParams({ path:'partner_add', pid, type:'assigned', admin });
  const r = await fetch(WEB_APP_URL, { method:'POST', body: params });
  const j = await r.json();
  if(!j.ok){ alert(j.error||'√âchec √©criture'); return; }
  kpiAssigned.textContent = j.stats.assigned;
}


async function addDoneNoSav(){
  const pid = CURRENT_PARTNER || (partnerIdInput.value||'').trim();
  if(!pid){ alert("Charge d‚Äôabord un partenaire."); return; }
  const admin = prompt("Code admin (obligatoire) :","");
  if(!admin){ alert("Action r√©serv√©e √† l‚Äôadmin."); return; }

  const params = new URLSearchParams({ path:'partner_add', pid, type:'nosav', admin });
  const r = await fetch(WEB_APP_URL, { method:'POST', body: params });
  const j = await r.json();
  if(!j.ok){ alert(j.error||'√âchec √©criture'); return; }

  const s = j.stats;
  kpiNoSav.textContent = s.doneNoSav;
  const rewards = Math.floor(s.doneNoSav / PROMO_THRESHOLD);
  const toNext  = PROMO_THRESHOLD - (s.doneNoSav % PROMO_THRESHOLD || 0);
  kpiRewards.textContent = rewards;
  kpiNext.textContent    = (s.doneNoSav % PROMO_THRESHOLD === 0) ? PROMO_THRESHOLD : toNext;
}

async function undoLast(){
  const pid = CURRENT_PARTNER || (partnerIdInput.value||'').trim();
  if(!pid){ alert("Charge d‚Äôabord un partenaire."); return; }
  const type = prompt("Annuler quoi ? (assigned | nosav)","assigned");
  if(!type) return;
  const admin = prompt("Code admin (obligatoire) :","");
  if(!admin){ alert("Action r√©serv√©e √† l‚Äôadmin."); return; }

  const params = new URLSearchParams({ path:'partner_undo', pid, type, admin });
  const r = await fetch(WEB_APP_URL, { method:'POST', body: params });
  const j = await r.json();
  if(!j.ok){ alert(j.error||'√âchec undo'); return; }

  const s = j.stats;
  kpiAssigned.textContent = s.assigned;
  kpiNoSav.textContent    = s.doneNoSav;
  const rewards = Math.floor(s.doneNoSav / PROMO_THRESHOLD);
  const toNext  = PROMO_THRESHOLD - (s.doneNoSav % PROMO_THRESHOLD || 0);
  kpiRewards.textContent = rewards;
  kpiNext.textContent    = (s.doneNoSav % PROMO_THRESHOLD === 0) ? PROMO_THRESHOLD : toNext;
}

btnLoadPartner?.addEventListener('click', ensurePartner);
btnAddAssigned?.addEventListener('click', addAssigned);
btnAddDoneNoSav?.addEventListener('click', addDoneNoSav);
btnUndo?.addEventListener('click', undoLast);

// Rendre visibles les blocs apr√®s validation PRO (hooke la fonction existante)
if (typeof openIfValid === 'function') {
  const _openIfValid = openIfValid;
  openIfValid = async function(){
    _openIfValid();
    if (document.getElementById('partner-content').style.display === 'block') {
      partnerBanner.style.display='flex';
      partnerOps.style.display='flex';
      await loadTarifs();
    }
  };
}

// Bonus : charge le dernier partenaire utilis√© pour gagner du temps
document.addEventListener('DOMContentLoaded', ()=>{
  const lastPid = localStorage.getItem('partnerStats::LAST_PID') || '';
  if(lastPid){
    partnerIdInput.value = lastPid;
    CURRENT_PARTNER = lastPid;
    refreshUI();
  }
});
partnerIdInput?.addEventListener('change', ()=>{
  const pid = (partnerIdInput.value||'').trim();
  if(pid) localStorage.setItem('partnerStats::LAST_PID', pid);
});
</script>

<script>
// --- PATCH AFFICHE PROMO/APR√àS VALIDATION ---

(function(){
  const btn = document.getElementById('btn-enter') || document.getElementById('enter');
  if (btn) btn.addEventListener('click', () => setTimeout(showPartnerPromoIfOpen, 0));
})();
document.getElementById('code')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') setTimeout(showPartnerPromoIfOpen, 0);
});
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(showPartnerPromoIfOpen, 0);
});

// Bouton global ‚ÄúAjouter au devis‚Äù
document.getElementById('btn-add-selected')?.addEventListener('click', addSelectedPrestations);

// Tab switching
document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click', e=>switchTab(e.currentTarget.dataset.tab)));
</script>

<script>
/* ---- Toggle des notes au clic (AJOUT 3/3) ---- */
document.getElementById('partner-sheets')?.addEventListener('click', (e)=>{
  const label = e.target.closest('.task-label');
  const li = label ? label.closest('li') : e.target.closest('li.has-notes');
  if (!li || !li.classList.contains('has-notes')) return;
  if (e.target.classList.contains('qty-input')) return;
  li.classList.toggle('open');
});
</script>

</body>
</html>
