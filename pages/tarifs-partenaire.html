<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grille Tarifaire Professionnelle - Papo Rénov</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* =============== Reset & Variables =============== */
:root{
  --primary:#0a1f44;
  --secondary:#ffc107;
  --bg:#f4f7fa;
  --panel:#fff;
  --muted:#6c757d;
  --ok:#28a745;
  --border:#e9ecef;
  --shadow:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
html,body{overflow-x:hidden}
body{
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:#111;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* =============== HEADER (identique aux autres pages) =============== */
header{
  background:#fff;
  padding:10px 20px;
  box-shadow:0 2px 4px rgba(0,0,0,.16);
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  position:sticky; top:0; z-index:50;
}
.logo img{max-height:50px;width:auto}
header nav{ flex:1 1 auto; min-width:0; }
nav ul{
  list-style:none; margin:0; padding:0;
  display:flex; gap:20px;
  overflow-x:auto;
  -ms-overflow-style:none; scrollbar-width:none;
  white-space:nowrap;
  -webkit-overflow-scrolling:touch;
}
nav ul::-webkit-scrollbar{display:none}
nav ul li a{
  text-decoration:none;
  color:#003366;
  font-weight:600;
  white-space:nowrap;
  padding:5px 0;
  transition:color .25s;
}
nav ul li a:hover{color:var(--primary)}
nav ul li a.active{color:#007bff; font-weight:700; text-decoration:underline}

/* =============== Carte / Contenu =============== */
.card{
  width:min(1200px,100%);
  background:var(--panel);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  margin:20px auto 30px;
}

/* =============== En-tête panneau PRO =============== */
.header{
  display:flex; justify-content:space-between; align-items:center; gap:12px;
  padding:20px 24px; border-bottom:2px solid var(--primary);
  background:var(--primary); color:#fff;
}
.header-left{display:flex; align-items:center; gap:12px; min-width:0}
.header img{height:45px; filter:brightness(0) invert(1); flex-shrink:0}
.header h1{
  font-size:clamp(1.15rem,1.6vw,1.5rem);
  margin:0; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.badge{background:var(--secondary); color:#000; padding:5px 10px; border-radius:6px; font-weight:700}

/* =============== Zone sécurisée =============== */
.secure-area{padding:22px}
.notice{color:var(--muted); text-align:center; margin:0 0 16px}
.form{display:flex; gap:10px; justify-content:center; margin:8px 0 22px; flex-wrap:wrap}
.form input{
  flex:1 1 260px; max-width:320px; padding:12px 14px;
  border:1px solid var(--border); border-radius:12px; font-size:1rem;
}
.form input:focus{border-color:var(--primary); outline:none}
.form button{
  padding:12px 16px; border-radius:12px; border:none;
  background:var(--secondary); color:var(--primary); font-weight:700; cursor:pointer;
  min-width:160px;
}
.form button:hover{background:#ffda6a}
.error{color:#dc3545; text-align:center; min-height:20px; margin-bottom:10px}

/* =============== Tabs & contenu =============== */
#partner-content{padding-top:10px; display:none}
.tab-nav{
  display:flex; justify-content:center; gap:6px; margin-bottom:16px;
  border-bottom:1px solid var(--border); padding:0 10px 6px;
  overflow-x:auto; scrollbar-width:none;
}
.tab-nav::-webkit-scrollbar{display:none}
.tab-nav button{
  background:none; border:none; padding:10px 14px; cursor:pointer;
  font-size:.98rem; font-weight:600; color:var(--muted);
  border-bottom:3px solid transparent; white-space:nowrap;
}
.tab-nav button.active{color:var(--primary); border-bottom-color:var(--primary)}
.tab-content{padding:0 10px 10px}

/* ======== Promo & Compteur Partenaire ======== */
.promo-banner{
  background:linear-gradient(135deg,var(--secondary),#ffd65a);
  color:#111; border:2px dashed var(--primary); border-radius:14px;
  padding:12px 16px; margin:8px 10px 16px; box-shadow:var(--shadow);
  display:flex; align-items:center; gap:12px; flex-wrap:wrap
}
.promo-banner b{color:#0a1f44}
.promo-banner small{opacity:.9}

.partner-kpis{
  display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:12px; padding:0 10px 12px;
}
.kpi{
  background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
}
.kpi h4{margin:0 0 6px; font-size:1rem; color:var(--primary)}
.kpi .val{font:700 1.6rem/1 'Roboto Mono',monospace; color:#0a1f44}
.kpi .sub{font-size:.85rem; color:var(--muted)}

.partner-ops{
  display:flex; flex-wrap:wrap; gap:10px; padding:0 10px 14px
}
.partner-ops input[type="text"]{
  flex:1 1 260px; max-width:340px; padding:10px 12px; border:1px solid var(--border);
  border-radius:10px; font-size:.98rem
}
.partner-ops button{
  padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; border:1px solid var(--primary);
  background:#fff; color:var(--primary)
}
.partner-ops button.primary{background:var(--primary); color:#fff; border:none}
.partner-ops button.warn{border-color:#dc3545; color:#dc3545}
.partner-ops .hint{font-size:.9rem; color:var(--muted)}

/* =============== Grilles de tarifs (cards) =============== */
.sheets{
  display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr));
  gap:18px; margin-bottom:22px;
}
.sheet{
  background:var(--panel); border:1px solid var(--border); border-radius:14px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  padding:16px; display:flex; flex-direction:column;
  transform-style:preserve-3d; perspective:800px;
  transition:transform .35s ease, box-shadow .35s ease;
}
.sheet:hover{
  transform:translateY(-4px) rotateX(2deg);
  box-shadow:0 18px 36px rgba(0,0,0,.12);
}
.sheet .head{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px}
.sheet h3{font-size:1.1rem; margin:0; color:var(--primary)}
.sheet p{color:var(--muted); font-size:.9rem; margin:4px 0 10px}
.sheet .from{
  font-size:1rem; font-weight:700; color:var(--ok);
  margin-bottom:10px; padding-bottom:8px; border-bottom:1px dashed var(--border);
}
.list{list-style:none; padding:0; margin:0; flex-grow:1}
.list li{
  display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px;
  font-size:.95rem; padding:10px 0; border-bottom:1px dashed var(--border);
}
.list li:last-child{border-bottom:none}
.list li strong{font-family:'Roboto Mono',monospace; font-weight:700; color:var(--primary); white-space:nowrap}

/* === Champs quantité + bouton global === */
.qty-wrap{display:flex; align-items:center; gap:8px}
.qty-input{
  width:74px; padding:6px 8px; border:1px solid var(--border); border-radius:6px;
  font-family:'Roboto Mono',monospace; text-align:right;
}
.bulk-add{
  display:flex; justify-content:flex-end; padding:6px 2px 0;
}
#btn-add-selected{
  padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700;
  background:var(--primary); color:#fff;
}
#btn-add-selected:hover{background:#17386b}

/* =============== Devis rapide =============== */
#devis-rapide-tab{padding:16px 8px 20px}

.devis-header{
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
  border-bottom:2px solid var(--primary); padding-bottom:10px; margin-bottom:14px;
}

#partner-logo-preview{max-height:46px; max-width:160px; display:none}

.devis-actions{display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px}
.devis-actions button, .devis-actions input[type="file"] + label{
  padding:10px 14px; border-radius:8px; font-weight:600; cursor:pointer; border:1px solid var(--primary)
}
#print-devis,#clear-devis{background:var(--primary); color:#fff; border:none}
input[type="file"]{display:none}
.file-upload-label{background:#fff; color:var(--primary); display:inline-block}

/* Table responsive : scroll interne uniquement */
.table-responsive{
  width:100%;
  overflow-x:auto; -webkit-overflow-scrolling:touch;
  border:1px solid var(--border); border-radius:8px; background:#fff;
}
.devis-table{width:100%; border-collapse:collapse; min-width:720px}
.devis-table th,.devis-table td{border-bottom:1px solid var(--border); padding:10px; text-align:left; vertical-align:middle}
.devis-table th{background:#e9eff6; font-weight:600; color:var(--primary)}
.devis-table input[type="number"]{width:70px; padding:6px 8px; border:1px solid var(--border); border-radius:6px; text-align:right; font-family:'Roboto Mono',monospace}
.devis-table .unit-price{text-align:right; font-family:'Roboto Mono',monospace; font-weight:600; white-space:nowrap}
.devis-table .total-row,.devis-table .subtotal-cell{text-align:right; font-family:'Roboto Mono',monospace; font-weight:600}
.devis-table .subtotal-cell{background:#f7f7f7}

/* Totaux */
.devis-totals{display:flex; justify-content:flex-end; padding:8px 0}
.totals-box{width:100%; max-width:420px; border:2px solid var(--primary); border-radius:8px; padding:12px; background:#fff}
.totals-box p{display:flex; justify-content:space-between; margin:8px 0; font-size:1rem}
.totals-box .final{font-size:1.2rem; font-weight:700; color:var(--primary); border-top:1px solid var(--border); padding-top:8px; margin-top:8px}

/* Footer */
.footer{
  padding:12px 18px; border-top:1px solid var(--border); background:#fcfcfc;
  display:flex; justify-content:space-between; align-items:center; gap:10px; font-size:.92rem; flex-wrap:wrap
}
.footer a{color:var(--primary); font-weight:600; text-decoration:none}
.footer a:hover{color:var(--secondary)}

/* =============== Media queries =============== */
@media (max-width:992px){
  .sheets{grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px}
  .sheet{padding:14px}
  .header{padding:16px}
}
@media (max-width:768px){
  .list li{grid-template-columns:1fr; gap:6px}
  .list li strong{order:2}
  .header-left h1{white-space:normal}
  .form{gap:8px}
  .form button{width:100%}
  .bulk-add{justify-content:center}
}
@media (max-width:600px){
  .header{flex-direction:column; align-items:flex-start; gap:8px}
  .badge{align-self:flex-end}
  .devis-actions button,.file-upload-label{flex:1 1 160px; text-align:center}
  .totals-box{max-width:100%}
}
@media (max-width:420px){
  .form input{min-width:0; width:100%}
  .header img{height:36px}
}

/* =============== Impression =============== */
@media print{
  header,.header,.tab-nav,.footer,.devis-actions,.list li .qty-wrap,.secure-area>.notice,.secure-area>.form,.secure-area>.error,
  .devis-table input,.devis-table button{display:none !important}
  /* >>> AJOUT : ne jamais imprimer l'offre partenaire ni le compteur <<< */
  .promo-banner,.partner-ops,.partner-kpis{display:none !important;}

  .card{width:100%; box-shadow:none; margin:0; border-radius:0}
  .client-fields{display:none !important;}
  .table-responsive{overflow: visible !important; border: 1px solid #ccc !important;}
  .devis-table{
    width: 100% !important; min-width: 0 !important; table-layout: auto !important; border-collapse: collapse !important;
  }
  .devis-table thead{ display: table-header-group !important; }
  .devis-table tfoot{ display: table-footer-group !important; }
  .devis-table tr{ break-inside: avoid !important; page-break-inside: avoid !important; }
  .devis-table th, .devis-table td{ white-space: normal !important; word-break: break-word !important; }
  .devis-table thead th:last-child,
  .devis-table tbody td:last-child,
  .devis-table tfoot td:last-child{ display: none !important; }
  #devis-rapide-tab{padding:0}
  #partner-content{display:block !important; padding-top:0}
  .devis-table th,.devis-table td{border-color:#ccc !important}

  /* Logo + titres impression */
  #partner-logo-preview {max-height: 100px !important; max-width: 300px !important; display: block !important; margin: 0 auto 10px auto !important; text-align: center;}
  .devis-header {display: block !important; text-align: center !important;}
  .devis-header .devis-titles {display: block !important; margin-top: 6px !important;}
  .devis-header h3.devis-rapide-title {font-size: 1.2rem !important; margin: 0 !important; color: #000 !important; text-transform: uppercase;}
  #partner-info-print {display: block !important; text-align: center !important; margin-top: 8px !important; font-size: 0.95rem !important; line-height: 1.4; color: #333 !important;}
}
</style>
</head>
<body>

<!-- ===== HEADER identique aux autres pages ===== -->
<header>
  <div class="logo">
    <img src="../img/logo.png" alt="Logo Papo Rénov">
  </div>
  <nav>
    <ul>
      <li><a href="../index.html">Accueil</a></li>
      <li><a href="devis.html">Demande de devis</a></li>
      <li><a href="realisations.html">Mes réalisations</a></li>
      <li><a href="tarifs.html">Tarifs</a></li>
      <li><a href="planning.html">Planning</a></li>
      <li><a class="active" href="tarifs-partenaire.html">Espace PRO</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="avis.html">Avis clients</a></li>
      <li><a href="courtage-cuisine.html">Courtage Cuisine</a></li>
    </ul>
  </nav>
</header>
<!-- =========================================== -->

<div class="card">
  <div class="header">
    <div class="header-left">
      <img src="../img/logo.png" alt="Papo Rénov">
      <h1>Grille Tarifaire Professionnelle</h1>
    </div>
    <span class="badge">Accès Partenaire PRO</span>
  </div>

  <div class="secure-area">
    <p class="notice">Veuillez entrer le <strong>code d’accès professionnel</strong> pour consulter l'intégralité des tarifs et outils dédiés.</p>
    <div class="form">
      <input id="code" type="password" placeholder="Code d’accès PRO" autocomplete="off" required>
      <button id="enter">Accéder</button>
    </div>
    <div id="error" class="error"></div>

    <div id="partner-content" style="display:none">

      <!-- ===== Pancarte Promo Partenaire ===== -->
      <div class="promo-banner" id="promo-banner" style="display:none;">
        <span style="font-size:1.4rem;">🎯</span>
        <div>
          <div><b>OFFRE PARTENAIRE :</b> <b>1 jour de pose OFFERT</b> toutes les <b>5 poses réalisées sans SAV</b>. <b>Cumulable.</b></div>
          <small>La journée offerte s’applique sur une pose planifiée d’1 jour. Conditions détaillées sur bon d’intervention.</small>
        </div>
      </div>

      <!-- ===== Compteur Par Partenaire ===== -->
      <div class="partner-ops" id="partner-ops" style="display:none;">
        <input id="partner-id" type="text" placeholder="Identifiant partenaire (ex. nom, email, code)" />
        <button class="primary" id="btn-load-partner">Charger / Créer</button>
        <button id="btn-add-assigned">+ 1 pose attribuée</button>
        <button id="btn-add-done-nosav">+ 1 pose réalisée SANS SAV</button>
        <button class="warn" id="btn-undo">Annuler la dernière action</button>
        <span class="hint">Astuce : l’ID sert de clé (statistiques locales par partenaire).</span>
      </div>

      <div class="partner-kpis" id="partner-kpis" style="display:none;">
        <div class="kpi">
          <h4>Poses attribuées</h4>
          <div class="val" id="kpi-assigned">0</div>
          <div class="sub">Cumul depuis l’activation</div>
        </div>
        <div class="kpi">
          <h4>Réalisées SANS SAV</h4>
          <div class="val" id="kpi-nosav">0</div>
          <div class="sub">Clôturées sans retour SAV</div>
        </div>
        <div class="kpi">
          <h4>Jours offerts</h4>
          <div class="val" id="kpi-rewards">0</div>
          <div class="sub">1 jour offert / 5 poses sans SAV — cumulable</div>
        </div>
        <div class="kpi">
          <h4>Prochain palier</h4>
          <div class="val"><span id="kpi-next">5</span> restantes</div>
          <div class="sub">Avant le prochain jour offert</div>
        </div>
      </div>

      <div class="tab-nav">
        <button class="tab-btn active" data-tab="tarifs-pro-tab">Grille Tarifaire Détaillée</button>
        <button class="tab-btn" data-tab="devis-rapide-tab">Générateur de Devis Rapide</button>
      </div>

      <div class="tab-content">
        <!-- ===== Onglet Tarifs ===== -->
        <div id="tarifs-pro-tab" class="tab-pane active">
          <p class="notice" style="margin-bottom:18px;">
            <strong>Tarifs Partenaires NETS (Hors Taxes)</strong> — Valables sur volume et récurrence. Matériaux non inclus (sauf mention F+M.O.).
          </p>

          <div class="sheets" id="partner-sheets">
            <!-- Injecté dynamiquement depuis PAPORENOV-Tarifs.json -->
          </div>

          <!-- Bouton global d’ajout au devis -->
          <div class="bulk-add">
            <button id="btn-add-selected">➕ Ajouter au devis</button>
          </div>
        </div>

        <!-- ===== Onglet Devis ===== -->
        <div id="devis-rapide-tab" class="tab-pane" style="display:none;">
          <div class="devis-header">
            <img id="partner-logo-preview" src="" alt="Logo Partenaire" />
            <div class="devis-titles">
               <h3 class="devis-rapide-title">DEVIS ESTIMATIF - <span id="partner-name-display">Votre Client</span></h3>
            </div>
          </div>

          <!-- Saisie coordonnées client (écran) -->
          <div class="client-fields" style="display:block; margin:12px 0;">
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;">
              <input id="client-nom" type="text" placeholder="Nom / Société du client">
              <input id="client-email" type="email" placeholder="Email du client">
              <input id="client-tel" type="text" placeholder="Téléphone du client">
              <input id="client-adresse" type="text" placeholder="Adresse du client">
            </div>
          </div>

          <!-- Bloc impression -->
          <div id="partner-info-print" style="display:none;">
            <div style="margin-top:6px;">
              <div><strong>Client :</strong> <span id="print-client-nom">—</span></div>
              <div><strong>Email :</strong> <span id="print-client-email">—</span></div>
              <div><strong>Téléphone :</strong> <span id="print-client-tel">—</span></div>
              <div><strong>Adresse :</strong> <span id="print-client-adresse">—</span></div>
            </div>
          </div>

          <div class="devis-actions">
            <button id="print-devis">🖨️ Imprimer / Enregistrer en PDF</button>
            <button id="clear-devis">🗑️ Vider le Devis</button>
            <input type="file" id="logo-upload" accept="image/*">
            <label for="logo-upload" class="file-upload-label">🔗 Ajouter votre Logo</label>
          </div>

          <div class="table-responsive">
            <table class="devis-table">
              <thead>
                <tr>
                  <th>Prestation</th>
                  <th>Quantité</th>
                  <th>Prix Unitaire HT (€)</th>
                  <th>Unité</th>
                  <th>Total HT</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="devis-lines"></tbody>
              <tfoot>
                <tr id="devis-subtotal-row" style="display:none;">
                  <td colspan="4" style="text-align:right;"><strong>Sous-Total HT (M.O. Estimée) :</strong></td>
                  <td class="subtotal-cell"><span id="subtotal">0.00 €</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="devis-totals">
            <div class="totals-box">
              <p>Sous-Total (HT) : <span id="total-mo">0.00 €</span></p>
              <p>Total HT : <span id="total-ht">0.00 €</span></p>
              <p>TVA (20%) : <span id="tva">0.00 €</span></p>
              <p class="final">TOTAL TTC : <span id="total-ttc">0.00 €</span></p>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <a href="tarifs.html">← Retour Tarifs Publics</a>
        <span>Documentation PRO et Matériaux : Accès ici</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const ACCESS_CODE = "PROPAPO2025!";

/* ================== DOM HOOKS ================== */
const inputCode = document.getElementById('code');
const btnEnter = document.getElementById('btn-enter') || document.getElementById('enter');
const errorDiv = document.getElementById('error');
const partnerContent = document.getElementById('partner-content');
const noticeText = document.querySelector('.secure-area > .notice');
const secureForm = document.querySelector('.form');
const tabButtons = document.querySelectorAll('.tab-btn');
const tabPanes = document.querySelectorAll('.tab-pane');

const devisLines = document.getElementById('devis-lines');
const subtotalSpan = document.getElementById('subtotal');
const totalMOEl = document.getElementById('total-mo');
const totalHTEl = document.getElementById('total-ht');
const tvaEl = document.getElementById('tva');
const totalTTCEl = document.getElementById('total-ttc');
const printButton = document.getElementById('print-devis');
const clearButton = document.getElementById('clear-devis');
const logoUpload = document.getElementById('logo-upload');
const logoPreview = document.getElementById('partner-logo-preview');

/* ================== STATE ================== */
let devisCart = [];
const TVA_RATE = 0.20;

/* ================== ACCESS ================== */
function openIfValid(){
  const val = (inputCode.value||'').trim();
  if(!val){ errorDiv.textContent="Veuillez saisir le code d’accès professionnel."; return; }
  if(val === ACCESS_CODE){
    errorDiv.textContent="";
    partnerContent.style.display='block';
    secureForm.style.display='none';
    noticeText.textContent="ACCÈS PRO CONFIRMÉ — Bienvenue Partenaire !";
    noticeText.style.color='var(--primary)';
    noticeText.style.fontWeight='600';
    document.getElementById('tarifs-pro-tab').style.display='block';
  }else{
    errorDiv.textContent="Code PRO invalide. Veuillez vérifier vos identifiants.";
  }
}

/* ================== TABS ================== */
function switchTab(targetId){
  tabPanes.forEach(p=>{p.style.display='none'; p.classList.remove('active');});
  tabButtons.forEach(b=>b.classList.remove('active'));
  const pane=document.getElementById(targetId);
  if(pane){ pane.style.display='block'; pane.classList.add('active'); }
  const btn=document.querySelector(`.tab-btn[data-tab="${targetId}"]`);
  if(btn) btn.classList.add('active');

  const ids = ['promo-banner','partner-ops','partner-kpis'];
  if(targetId==='devis-rapide-tab'){
    ids.forEach(id=>{
      const el=document.getElementById(id);
      if(el){
        el.dataset.prevDisplay = el.dataset.prevDisplay ?? (el.style.display || '');
        el.style.display='none';
      }
    });
  } else {
    ids.forEach(id=>{
      const el=document.getElementById(id);
      if(el && el.dataset.prevDisplay!==undefined){
        el.style.display = el.dataset.prevDisplay;
        delete el.dataset.prevDisplay;
      }
    });
  }
}

/* ================== RENDER TARIFS (depuis JSON) ================== */
function euro(x){
  if(x===null || x===undefined || isNaN(x)) return '—';
  return (parseFloat(x).toFixed(2)+' €').replace('.00','');
}
function inferUnit(u, label){
  const t=(u||'').toLowerCase();
  if(t) return t;
  const L=(label||'').toLowerCase();
  if(L.includes('m²')||L.includes('m2')) return 'm²';
  if(L.includes('/u')||L.includes('unité')||L.includes('unite')||L.includes('u.')) return 'u';
  if(L.includes('jr')||L.includes('jour')) return 'jr';
  return 'forfait';
}
function cleanTask(t){
  return (t||'').replace(/\s*\((M\.O\.|F\+M\.O\.|M\.O\.\/\s*\S+)\)\s*/gi,'').trim();
}

async function loadTarifs(){
  // Essaie le JSON à côté de la page
  const candidates = [
    './PAPORENOV-Tarifs.json',
    'PAPORENOV-Tarifs.json'
  ];
  let data=null, lastErr=null;
  for(const url of candidates){
    try{
      const r = await fetch(url, {cache:'no-store'});
      if(r.ok){ data = await r.json(); break; }
    }catch(e){ lastErr=e; }
  }
  if(!data){
    document.getElementById('partner-sheets').innerHTML =
      `<div style="padding:14px; border:1px dashed var(--border); border-radius:10px; background:#fff;">
        Impossible de charger <code>PAPORENOV-Tarifs.json</code>. Place le fichier JSON à côté de cette page.<br>
        Nom attendu : <strong>PAPORENOV-Tarifs.json</strong>
      </div>`;
    return;
  }
  renderSheets(data);
}

function renderSheets(data){
  const container = document.getElementById('partner-sheets');
  container.innerHTML = '';

  Object.keys(data).forEach(sheetName=>{
    const items = (data[sheetName]||[]).filter(x=>x && x.task);
    if(!items.length) return;

    // min "from"
    const mins = items.map(x=> typeof x.price_min==='number' ? x.price_min : null).filter(x=>x!==null);
    const from = mins.length ? Math.min(...mins) : null;

    const art = document.createElement('article');
    art.className = 'sheet';
    art.dataset.category = sheetName;

    const head = document.createElement('div');
    head.className = 'head';
    head.innerHTML = `<h3>${sheetName}</h3>`;
    art.appendChild(head);

    const p = document.createElement('p');
    p.textContent = 'Main d’œuvre (M.O.) | Référence: prix min par prestation';
    art.appendChild(p);

    const fromEl = document.createElement('div');
    fromEl.className = 'from';
    fromEl.textContent = from !== null ? `À partir de ${euro(from)} HT` : `Tarifs sur devis`;
    art.appendChild(fromEl);

    const ul = document.createElement('ul');
    ul.className = 'list';

    items.forEach(it=>{
      const name = cleanTask(it.task);
      const pu = (typeof it.price_min==='number') ? it.price_min : null;
      const unit = inferUnit(it.unit, it.task);
      const li = document.createElement('li');
      li.dataset.presta = name;

      const left = document.createElement('span');
      left.textContent = name + (it.notes ? ` — ${it.notes}` : '');
      const qtyWrap = document.createElement('div');
      qtyWrap.className = 'qty-wrap';

      const strong = document.createElement('strong');
      strong.textContent = pu!==null ? `${euro(pu)}/${unit}` : `P.U. —`;

      const input = document.createElement('input');
      input.type='number'; input.min='0'; input.placeholder='0';
      input.className='qty-input';
      input.dataset.price = (pu!==null ? pu : 0);
      input.dataset.unit = unit;

      qtyWrap.appendChild(strong);
      qtyWrap.appendChild(input);

      li.appendChild(left);
      li.appendChild(qtyWrap);
      ul.appendChild(li);
    });

    art.appendChild(ul);
    container.appendChild(art);
  });
}

/* ================== NOUVEAU FLUX : Ajout global au devis (P.U. = prix min) ================== */
function addSelectedPrestations(){
  const inputs = document.querySelectorAll('#tarifs-pro-tab .qty-input');
  let addedCount = 0;

  inputs.forEach(inp=>{
    const qty = parseFloat(inp.value || '0');
    if(!qty || qty <= 0) return;

    const li = inp.closest('li');
    if(!li) return;

    const nameRaw = li.dataset.presta || (li.querySelector('span')?.textContent || '').trim();
    const name = nameRaw.replace(/\s\(M\.O\.\s*\/\s*\S+\)|\s\(M\.O\.\)|\s\(F\+M\.O\.\)/g,'').trim();

    // >>> IGNORER MAX : on prend UNIQUEMENT le P.U. min comme référence
    const unitPrice = parseFloat(inp.dataset.price || '0') || 0;
    const unit = (inp.dataset.unit || 'forfait');

    const existing = devisCart.find(i=>i.name===name && i.unit===unit && i.unitPrice===parseFloat(unitPrice.toFixed(2)));
    if(existing){ existing.quantity += qty; }
    else{
      devisCart.push({
        name,
        quantity: qty,
        unitPrice: parseFloat(unitPrice.toFixed(2)),
        unit
      });
    }
    inp.value = '';
    addedCount++;
  });

  if(addedCount===0){
    alert("Aucune quantité renseignée. Indique au moins 1 ligne avec une quantité > 0.");
    return;
  }
  renderDevis();
  switchTab('devis-rapide-tab');
}

/* ================== DEVIS RENDER ================== */
function updateQuantity(el,i){
  let q=parseFloat(el.value);
  if(isNaN(q)||q<0){ q=0; el.value=0; }
  if(q===0){ removePrestation(i); } else { devisCart[i].quantity=q; renderDevis(); }
}
function updateUnitPrice(el,i){
  let p=parseFloat(el.value);
  if(isNaN(p)||p<0){ p=devisCart[i].unitPrice; el.value=p.toFixed(2); }
  devisCart[i].unitPrice=parseFloat(p.toFixed(2));
  renderDevis();
}
function removePrestation(i){ devisCart.splice(i,1); renderDevis(); }

function renderDevis(){
  const tbody=devisLines; tbody.innerHTML='';
  let subtotal=0;
  if(devisCart.length===0){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center; color:var(--muted);">Aucune prestation ajoutée. Ajoutez des quantités dans la Grille Tarifaire puis cliquez “Ajouter au devis”.</td></tr>';
  }
  devisCart.forEach((it,i)=>{
    const total=it.quantity*it.unitPrice; subtotal+=total;
    const row=tbody.insertRow();
    row.innerHTML=`
      <td>${it.name}</td>
      <td><input type="number" min="0" step="0.01" value="${it.quantity}" onchange="updateQuantity(this,${i})"></td>
      <td class="unit-price"><input type="number" min="0" step="0.01" value="${it.unitPrice.toFixed(2)}" onchange="updateUnitPrice(this,${i})"></td>
      <td>${it.unit}</td>
      <td class="total-row">${total.toFixed(2)} €</td>
      <td><button style="color:#dc3545; border:1px solid #dc3545; background:transparent; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="removePrestation(${i})">Supprimer</button></td>
    `;
  });
  const tva=subtotal*TVA_RATE, ttc=subtotal+tva;
  subtotalSpan.textContent=subtotal.toFixed(2)+' €';
  totalMOEl.textContent=subtotal.toFixed(2)+' €';
  totalHTEl.textContent=subtotal.toFixed(2)+' €';
  tvaEl.textContent=tva.toFixed(2)+' €';
  totalTTCEl.textContent=ttc.toFixed(2)+' €';
}

/* ================== MISC ================== */
function clearDevis(){
  if(confirm("Êtes-vous sûr de vouloir vider le devis ? Cette action est irréversible.")){
    devisCart=[]; renderDevis();
    logoPreview.src=''; logoPreview.style.display='none';
    document.getElementById('logo-upload').value='';
    alert("Le devis a été vidé.");
  }
}
function handleLogoUpload(e){
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ logoPreview.src=ev.target.result; logoPreview.style.display='block'; };
  r.readAsDataURL(f);
}

/* ================== Events ================== */
btnEnter?.addEventListener('click', async ()=>{
  openIfValid();
  if (partnerContent.style.display==='block') await loadTarifs();
});
inputCode.addEventListener('keydown', async e=>{
  if(e.key==='Enter'){
    openIfValid();
    if (partnerContent.style.display==='block') await loadTarifs();
  }
});

tabButtons.forEach(b=>b.addEventListener('click', e=>switchTab(e.currentTarget.dataset.tab)));

document.getElementById('btn-add-selected')?.addEventListener('click', addSelectedPrestations);

printButton?.addEventListener('click', ()=>window.print());
clearButton?.addEventListener('click', clearDevis);
logoUpload?.addEventListener('change', handleLogoUpload);

document.addEventListener('DOMContentLoaded', renderDevis);

/* Expose pour inline events */
window.updateQuantity=updateQuantity;
window.updateUnitPrice=updateUnitPrice;
window.removePrestation=removePrestation;
window.clearDevis=clearDevis;
</script>

<script>
  // Hooks champs client
  const clientNomEl = document.getElementById('client-nom');
  const clientEmailEl = document.getElementById('client-email');
  const clientTelEl = document.getElementById('client-tel');
  const clientAdresseEl = document.getElementById('client-adresse');

  // Hooks affichage impression + titre
  const printNom = document.getElementById('print-client-nom');
  const printEmail = document.getElementById('print-client-email');
  const printTel = document.getElementById('print-client-tel');
  const printAdr = document.getElementById('print-client-adresse');
  const partnerNameDisplay = document.getElementById('partner-name-display');

  function syncClientFields(){
    const nom = (clientNomEl?.value || '').trim();
    const email = (clientEmailEl?.value || '').trim();
    const tel = (clientTelEl?.value || '').trim();
    const adr = (clientAdresseEl?.value || '').trim();

    if (printNom)   printNom.textContent   = nom || '—';
    if (printEmail) printEmail.textContent = email || '—';
    if (printTel)   printTel.textContent   = tel || '—';
    if (printAdr)   printAdr.textContent   = adr || '—';

    if (partnerNameDisplay) {
      partnerNameDisplay.textContent = nom || 'Votre Client';
    }
  }

  [clientNomEl, clientEmailEl, clientTelEl, clientAdresseEl].forEach(el=>{
    el && el.addEventListener('input', syncClientFields);
  });

  document.addEventListener('DOMContentLoaded', syncClientFields);
</script>

<script>
/* ======== Compteur Partenaire (localStorage) ======== */
const PROMO_THRESHOLD = 5; // 1 jour offert toutes les 5 poses SANS SAV
const partnerBanner = document.getElementById('promo-banner');
const partnerOps = document.getElementById('partner-ops');
const partnerKpis = document.getElementById('partner-kpis');
const partnerIdInput = document.getElementById('partner-id');
const btnLoadPartner = document.getElementById('btn-load-partner');
const btnAddAssigned = document.getElementById('btn-add-assigned');
const btnAddDoneNoSav = document.getElementById('btn-add-done-nosav');
const btnUndo = document.getElementById('btn-undo');

const kpiAssigned = document.getElementById('kpi-assigned');
const kpiNoSav = document.getElementById('kpi-nosav');
const kpiRewards = document.getElementById('kpi-rewards');
const kpiNext = document.getElementById('kpi-next');

let CURRENT_PARTNER = null;
let LAST_ACTION_STACK = []; // pour undo (pile simple)

function storageKey(pid){ return `partnerStats::${pid}`; }
function defaultStats(){
  return { assigned:0, doneNoSav:0, history:[] };
}
function loadStats(pid){
  const raw = localStorage.getItem(storageKey(pid));
  return raw ? JSON.parse(raw) : defaultStats();
}
function saveStats(pid, stats){
  localStorage.setItem(storageKey(pid), JSON.stringify(stats));
}

function computeRewards(doneNoSav){
  const rewards = Math.floor(doneNoSav / PROMO_THRESHOLD);
  const next = PROMO_THRESHOLD - (doneNoSav % PROMO_THRESHOLD || 0);
  return { rewards, toNext: (doneNoSav % PROMO_THRESHOLD === 0) ? PROMO_THRESHOLD : next };
}

function refreshUI(){
  const visible = !!CURRENT_PARTNER;
  partnerOps.style.display = visible ? 'flex':'none';
  partnerKpis.style.display = visible ? 'grid':'none';
  partnerBanner.style.display = visible ? 'flex':'none';

  if(!visible) return;
  const stats = loadStats(CURRENT_PARTNER);
  const { rewards, toNext } = computeRewards(stats.doneNoSav);

  kpiAssigned.textContent = stats.assigned;
  kpiNoSav.textContent = stats.doneNoSav;
  kpiRewards.textContent = rewards;
  kpiNext.textContent = toNext;

  if(toNext === PROMO_THRESHOLD) {
    partnerBanner.style.borderColor = 'var(--ok)';
  } else {
    partnerBanner.style.borderColor = 'var(--primary)';
  }
}

function ensurePartner(){
  const pid = (partnerIdInput.value||'').trim();
  if(!pid){ alert("Renseigne l’identifiant partenaire (nom, email ou code)."); return null; }
  CURRENT_PARTNER = pid;
  if(!localStorage.getItem(storageKey(pid))) saveStats(pid, defaultStats());
  refreshUI();
  return pid;
}

function addAssigned(){
  if(!ensurePartner()) return;
  const stats = loadStats(CURRENT_PARTNER);
  stats.assigned += 1;
  stats.history.push({t:'assigned', ts:Date.now()});
  saveStats(CURRENT_PARTNER, stats);
  LAST_ACTION_STACK.push({type:'assigned'});
  refreshUI();
}

function addDoneNoSav(){
  if(!ensurePartner()) return;
  const stats = loadStats(CURRENT_PARTNER);
  stats.doneNoSav += 1;
  stats.history.push({t:'nosav', ts:Date.now()});
  saveStats(CURRENT_PARTNER, stats);
  LAST_ACTION_STACK.push({type:'nosav'});

  const { rewards, toNext } = computeRewards(stats.doneNoSav);
  if(toNext === PROMO_THRESHOLD){
    setTimeout(()=>alert(`🎉 Bravo ! Nouveau palier atteint : ${rewards} jour(s) de pose offert(s) cumulés.`), 50);
  }
  refreshUI();
}

function undoLast(){
  if(!CURRENT_PARTNER){ alert("Aucun partenaire n’est chargé."); return; }
  const last = LAST_ACTION_STACK.pop();
  if(!last){ alert("Aucune action à annuler."); return; }
  const stats = loadStats(CURRENT_PARTNER);
  if(last.type==='assigned' && stats.assigned>0) stats.assigned -= 1;
  if(last.type==='nosav' && stats.doneNoSav>0) stats.doneNoSav -= 1;
  saveStats(CURRENT_PARTNER, stats);
  refreshUI();
}

btnLoadPartner?.addEventListener('click', ensurePartner);
btnAddAssigned?.addEventListener('click', addAssigned);
btnAddDoneNoSav?.addEventListener('click', addDoneNoSav);
btnUndo?.addEventListener('click', undoLast);

// Rendre visibles les blocs après validation PRO (hooke la fonction existante)
const _openIfValid = openIfValid;
openIfValid = async function(){
  _openIfValid();
  if (document.getElementById('partner-content').style.display === 'block') {
    partnerBanner.style.display='flex';
    partnerOps.style.display='flex';
    await loadTarifs();
  }
};

// Bonus : charge le dernier partenaire utilisé pour gagner du temps
document.addEventListener('DOMContentLoaded', ()=>{
  const lastPid = localStorage.getItem('partnerStats::LAST_PID') || '';
  if(lastPid){
    partnerIdInput.value = lastPid;
    CURRENT_PARTNER = lastPid;
    refreshUI();
  }
});
partnerIdInput?.addEventListener('change', ()=>{
  const pid = (partnerIdInput.value||'').trim();
  if(pid) localStorage.setItem('partnerStats::LAST_PID', pid);
});
</script>

<script>
// --- PATCH AFFICHE PROMO/APRÈS VALIDATION ---
function showPartnerPromoIfOpen(){
  const pc = document.getElementById('partner-content');
  if (pc && pc.style.display === 'block') {
    document.getElementById('promo-banner').style.display = 'flex';
    document.getElementById('partner-ops').style.display = 'flex';
  }
}
(function(){
  const btn = document.getElementById('btn-enter') || document.getElementById('enter');
  if (btn) btn.addEventListener('click', () => setTimeout(showPartnerPromoIfOpen, 0));
})();
document.getElementById('code')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') setTimeout(showPartnerPromoIfOpen, 0);
});
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(showPartnerPromoIfOpen, 0);
});
</script>

</body>
</html>
