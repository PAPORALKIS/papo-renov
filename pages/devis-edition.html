<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Édition du devis - Papo Rénov</title>

<style>
body{font-family:Arial;margin:0;padding:20px;background:#f5f5f5;}
.container{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:10px;}
h1{margin-top:0;}
.section{margin-top:25px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;}
button{padding:10px 18px;border:none;border-radius:6px;background:#003366;color:#fff;font-size:16px;}
button:hover{opacity:0.85;}
</style>

</head>
<body>
<div class="container">

<h1>Édition du devis</h1>

<div class="section">
<label>Client :</label><br />
<input id="client" type="text" style="width:100%;padding:8px;" />

<label>Adresse :</label><br />
<input id="adresse" type="text" style="width:100%;padding:8px;" />

<label>Objet :</label><br />
<input id="objet" type="text" style="width:100%;padding:8px;" />

<label>Date :</label><br />
<input id="dateDevis" type="date" style="width:200px;padding:8px;" />
</div>

<div class="section">
<h2>Lignes du devis</h2>
<table id="tableLignes">
<thead>
<tr><th>Tâche</th><th>Qté</th><th>PU</th><th>Total</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="ajouterLigne()">Ajouter une ligne</button>
</div>

<div class="section">
<h2>Total</h2>
<p>HT : <span id="totalHT">0</span> €</p>
<p>TTC : <span id="totalTTC">0</span> €</p>
</div>

<div class="section">
<button onclick="enregistrerEtGenerer()">Enregistrer + Générer PDF</button>
<p id="msg" style="margin-top:10px;color:#d00;"></p>
</div>

</div>

<script>
const TARIFS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz9bHJB4QmH98EV2IrBEd-lyt5z74yN6uxiYQUBgXTuvr6oZQMCKWQ9AiiEzSzLvRz4fQ/exec";
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby_fBB20qGFsZvZnOQfKircrFpOV2A7qgLr7wYt5W8OcG8UojVwspobRUR68KrPI2pk/exec";

let lignes = [];
let idDevis = "AUTO"; // sera remplacé après création ou chargement

function ajouterLigne(){
  const tbody = document.querySelector("#tableLignes tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" class="tache" /></td>
    <td><input type="number" class="qte" value="1" /></td>
    <td><input type="number" class="pu" value="0" step="0.01" /></td>
    <td class="totalLigne">0</td>
  `;
  tbody.appendChild(tr);
}

function recalculer(){
  let totalHT = 0;
  document.querySelectorAll("#tableLignes tbody tr").forEach(tr=>{
    const qte = parseFloat(tr.querySelector(".qte").value)||0;
    const pu = parseFloat(tr.querySelector(".pu").value)||0;
    const t = qte * pu;
    tr.querySelector(".totalLigne").textContent = t.toFixed(2);
    totalHT += t;
  });
  document.getElementById("totalHT").textContent = totalHT.toFixed(2);
  document.getElementById("totalTTC").textContent = (totalHT * 1.2).toFixed(2);
}

document.addEventListener("input", e=>{
  if(e.target.classList.contains("qte") || e.target.classList.contains("pu")){
    recalculer();
  }
});

async function enregistrerEtGenerer(){
  const msg = document.getElementById("msg");
  msg.textContent = "";

  const client = document.getElementById("client").value;
  const adresse = document.getElementById("adresse").value;
  const objet = document.getElementById("objet").value;
  const dateDevis = document.getElementById("dateDevis").value;
  const totalHT = parseFloat(document.getElementById("totalHT").textContent)||0;
  const totalTTC = parseFloat(document.getElementById("totalTTC").textContent)||0;

  const lignesData = [];
  document.querySelectorAll("#tableLignes tbody tr").forEach(tr=>{
    lignesData.push({
      tache: tr.querySelector(".tache").value,
      qte: tr.querySelector(".qte").value,
      pu: tr.querySelector(".pu").value,
      total: tr.querySelector(".totalLigne").textContent
    });
  });

  const payloadUpdate = {
    id_devis: idDevis,
    client: client,
    adresse: adresse,
    commentaires: objet,
    date_devis: dateDevis,
    montant_ht: totalHT,
    montant_ttc: totalTTC
  };

  try {
    const resp1 = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        path:"bo",
        action:"update_devis",
        ...payloadUpdate
      })
    });
    const json1 = await resp1.json();
    if(!json1.ok){
      msg.textContent = "Erreur lors de la mise à jour du devis.";
      return;
    }
  } catch(e){
    msg.textContent = "Erreur réseau lors du update.";
    return;
  }

  try {
    const resp2 = await fetch(WEB_APP_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        path:"bo",
        action:"generate_pdf",
        id_devis:idDevis
      })
    });
    const json2 = await resp2.json();
    if(json2.ok && json2.pdfUrl){
      msg.style.color = "green";
      msg.textContent = "PDF généré.";
      window.open(json2.pdfUrl,"_blank");
    } else {
      msg.textContent = "Erreur génération PDF.";
    }
  } catch(e){
    msg.textContent = "Erreur réseau lors du PDF.";
  }
}

</script>

</body>
</html>
