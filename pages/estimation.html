<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Papo-RÃ©nov â€” Estimation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b0d12;
      --fg: #e8ecf1;
      --muted: #9aa6b2;
      --brand: #2ec4ff;
      --card: #151a22;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --shadow: 0 8px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light) {
      :root { --bg:#f7fafc; --fg:#17202a; --muted:#6b7280; --card:#ffffff; }
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      display: grid; place-items: start center;
    }
    .wrap { width: min(1200px, 96vw); margin: 24px 0 56px; }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      margin: 14px 0 18px;
    }
    .brand { display:flex; align-items:center; gap:10px; }
    .logo {
      inline-size: 32px; block-size: 32px; border-radius: 8px;
      background: linear-gradient(135deg, var(--brand), #7af7ff);
      box-shadow: var(--shadow);
    }
    h1 { font-size: clamp(20px, 3.6vw, 28px); margin: 0; letter-spacing: .2px; }
    .tools { display:flex; flex-wrap: wrap; gap:8px; }
    button, .btn {
      appearance: none; border: 0; border-radius: 12px; padding: 10px 14px;
      background: var(--card); color: var(--fg); cursor: pointer;
      box-shadow: var(--shadow); font-weight: 600; transition: transform .08s ease;
    }
    button:hover { transform: translateY(-1px); }
    .btn-primary { background: linear-gradient(135deg, var(--brand), #79e3ff); color:#06212a; }
    .btn-ghost { background: transparent; outline: 1px solid color-mix(in oklab, var(--fg) 15%, transparent); }
    .status {
      display:flex; align-items:center; gap:8px; color: var(--muted); font-size: 14px; margin: 8px 0 0;
    }
    .dot {
      inline-size: 9px; block-size: 9px; border-radius: 50%;
      background: var(--warn); box-shadow: 0 0 0 3px color-mix(in oklab, var(--warn) 20%, transparent);
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100%{ transform: scale(1); opacity: .9 }
      50%{ transform: scale(1.25); opacity: 1 }
    }
    .card {
      background: var(--card); border-radius: 18px; padding: clamp(14px, 2.5vw, 22px);
      box-shadow: var(--shadow); overflow: clip;
    }
    .placeholder {
      display:grid; place-items:center; min-block-size: 40vh; text-align:center; color: var(--muted);
    }
    .error {
      border: 1px solid color-mix(in oklab, var(--err) 40%, transparent);
      background: color-mix(in oklab, var(--err) 8%, var(--card));
      color: color-mix(in oklab, var(--err) 90%, var(--fg));
      padding: 12px 14px; border-radius: 12px; margin: 12px 0;
    }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    footer { margin: 18px 0 0; color: var(--muted); font-size: 14px; }
    .result { container-type: inline-size; }
    .actions-bottom { display:flex; gap:8px; flex-wrap:wrap; margin-top: 12px; }
    /* Make any <h3>/<ul> from IA readable */
    .result :is(h2,h3){ margin: .4em 0 .2em; }
    .result :is(p,li){ color: inherit; }
    .result ul{ margin: .2em 0 .6em .8em; }
    .watermark {
      position: fixed; inset: auto 12px 12px auto; opacity: .35; font-weight: 700; font-size: 12px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <span class="logo" aria-hidden="true"></span>
        <div>
          <h1>Papo-RÃ©nov Â· Estimation IA</h1>
          <div id="status" class="status"><span class="dot" aria-hidden="true"></span><span>Chargement de votre estimationâ€¦</span></div>
        </div>
      </div>
      <div class="tools">
        <button id="btnPrint" class="btn btn-primary" type="button">Imprimer</button>
        <button id="btnDownload" class="btn" type="button">TÃ©lÃ©charger (HTML)</button>
        <button id="btnCopy" class="btn btn-ghost" type="button">Copier le lien</button>
      </div>
    </header>

    <main id="main" class="card">
      <div id="placeholder" class="placeholder">
        <div>
          <div class="spinner" aria-hidden="true"></div>
          <p>On dÃ©roule le tapis rouge ðŸŽ¬â€¦ prÃ©paration de votre rendu.</p>
        </div>
      </div>
      <article id="result" class="result" hidden></article>
      <div id="error" class="error" hidden></div>
      <div class="actions-bottom">
        <button id="btnPrint2" class="btn btn-primary" type="button" hidden>Imprimer</button>
      </div>
    </main>

    <footer>
      Astuce : gardez ce lien, il contient votre identifiant dâ€™estimation pour recharger le rendu.
    </footer>
  </div>

  <div class="watermark">Papo-RÃ©nov</div>

  <noscript>
    <div class="card error" role="alert">Activez JavaScript pour afficher lâ€™estimation.</div>
  </noscript>

  <script>
    // 1) Renseignez ici lâ€™URL /exec de votre Web App Apps Script (ou passez-la via ?api=... dans lâ€™URL)
    const DEFAULT_SCRIPT_BASE = 'https://script.google.com/macros/s/XXXXXXXXXXXX/exec'; // â† Ã€ REMPLACER

    // 2) Utilitaires URL
    const usp = new URLSearchParams(location.search);
    const ID = usp.get('id') || '';            // Jeton stockÃ© cÃ´tÃ© Apps Script (Cache)
    const SCRIPT_BASE = usp.get('api') || DEFAULT_SCRIPT_BASE; // Option: passer ?api=https://script.google.com/macros/s/AKfycbzIEB7_atox_Qnx8GfNc2V4fIT3OxASsZmmkMWLnHrxpHlstqSnhe5GrfeF7UVJ_qKHwQ/exec
    const AUTO_PRINT = usp.get('print') === '1';

    // 3) SÃ©lecteurs
    const $status = document.getElementById('status');
    const $placeholder = document.getElementById('placeholder');
    const $result = document.getElementById('result');
    const $error = document.getElementById('error');
    const $btnPrint = document.getElementById('btnPrint');
    const $btnPrint2 = document.getElementById('btnPrint2');
    const $btnDownload = document.getElementById('btnDownload');
    const $btnCopy = document.getElementById('btnCopy');

    function setStatus(text, state) {
      if (!text) { $status.hidden = true; return; }
      $status.hidden = false;
      $status.querySelector('span:last-child').textContent = text;
      const dot = $status.querySelector('.dot');
      if (state === 'ok') { dot.style.background = 'var(--ok)'; }
      else if (state === 'err') { dot.style.background = 'var(--err)'; }
      else { dot.style.background = 'var(--warn)'; }
    }

    function showError(msg) {
      $placeholder.hidden = true;
      $result.hidden = true;
      $btnPrint2.hidden = true;
      $error.hidden = false;
      $error.textContent = msg;
      setStatus('Erreur lors du chargement.', 'err');
    }

    function asFileName(prefix = 'estimation') {
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      return `${prefix}-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}.html`;
    }

    async function loadEstimation() {
      try {
        if (!ID) {
          showError("Identifiant manquant dans lâ€™URL (?id=...). VÃ©rifiez la redirection du formulaire.");
          return;
        }
        if (!/^https?:\/\/.+\/exec$/.test(SCRIPT_BASE)) {
          setStatus('Configuration API absente, tentative quand mÃªmeâ€¦', 'warn');
        }
        const url = `${SCRIPT_BASE}?fn=get&id=${encodeURIComponent(ID)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          throw new Error(`HTTP ${res.status} â€” ${txt.slice(0, 240)}`);
        }
        const data = await res.json();
        const html = (data && data.html) ? String(data.html) : '';
        if (!html) throw new Error('RÃ©ponse vide (html manquant).');

        // Afficher le rendu IA (HTML dÃ©jÃ  formatÃ© cÃ´tÃ© serveur)
        $result.innerHTML = html;
        $placeholder.hidden = true;
        $error.hidden = true;
        $result.hidden = false;
        $btnPrint2.hidden = false;
        setStatus('Estimation chargÃ©e âœ…', 'ok');

        if (AUTO_PRINT) {
          // Laisse le temps au DOM de peindre lâ€™estimation
          setTimeout(() => window.print(), 200);
        }
      } catch (err) {
        showError(String(err));
      }
    }

    // 4) Actions
    $btnPrint.addEventListener('click', () => window.print());
    $btnPrint2.addEventListener('click', () => window.print());

    $btnDownload.addEventListener('click', () => {
      const content = `<!doctype html><meta charset="utf-8"><title>Estimation Papo-RÃ©nov</title>${$result.innerHTML}`;
      const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = asFileName('papo-renov-estimation');
      a.click();
      URL.revokeObjectURL(url);
    });

    $btnCopy.addEventListener('click', async () => {
      try {
        // Conserve id + api si prÃ©sent
        const u = new URL(location.href);
        await navigator.clipboard.writeText(u.toString());
        setStatus('Lien copiÃ© dans le presse-papiers âœ…', 'ok');
        setTimeout(() => setStatus('', 'ok'), 1800);
      } catch {
        setStatus('Impossible de copier automatiquement, copiez lâ€™URL manuellement.', 'warn');
      }
    });

    // 5) Init
    setStatus('Chargement de votre estimationâ€¦', 'warn');
    loadEstimation();
  </script>
</body>
</html>
