<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Papo-Rénov — Estimation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />

  <!-- Nav identique : mêmes assets que tes autres pages -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">

  <style>
    /* Styles existants de la page estimation (conservés) */
    :root {
      --bg: #0b0d12;
      --fg: #e8ecf1;
      --muted: #9aa6b2;
      --brand: #2ec4ff;
      --card: #151a22;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --shadow: 0 8px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light) {
      :root { --bg:#f7fafc; --fg:#17202a; --muted:#6b7280; --card:#ffffff; }
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      display: grid; place-items: start center;
    }
    .wrap { width: min(1200px, 96vw); margin: 24px 0 56px; }
    .brand { display:flex; align-items:center; gap:10px; }
    .logo {
      inline-size: 32px; block-size: 32px; border-radius: 8px;
      background: linear-gradient(135deg, var(--brand), #7af7ff);
      box-shadow: var(--shadow);
    }
    h1 { font-size: clamp(20px, 3.6vw, 28px); margin: 0; letter-spacing: .2px; }
    .tools { display:flex; flex-wrap: wrap; gap:8px; }
    button, .btn {
      appearance: none; border: 0; border-radius: 12px; padding: 10px 14px;
      background: var(--card); color: var(--fg); cursor: pointer;
      box-shadow: var(--shadow); font-weight: 600; transition: transform .08s ease;
    }
    button:hover { transform: translateY(-1px); }
    .btn-primary { background: linear-gradient(135deg, var(--brand), #79e3ff); color:#06212a; }
    .btn-ghost { background: transparent; outline: 1px solid color-mix(in oklab, var(--fg) 15%, transparent); }
    .status {
      display:flex; align-items:center; gap:8px; color: var(--muted); font-size: 14px; margin: 8px 0 0;
    }
    .dot { inline-size: 9px; block-size: 9px; border-radius: 50%; background: var(--warn); box-shadow: 0 0 0 3px color-mix(in oklab, var(--warn) 20%, transparent); animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{ transform: scale(1); opacity: .9 } 50%{ transform: scale(1.25); opacity: 1 } }
    .card { background: var(--card); border-radius: 18px; padding: clamp(14px, 2.5vw, 22px); box-shadow: var(--shadow); overflow: clip; }
    .placeholder { display:grid; place-items:center; min-block-size: 14vh; text-align:center; color: var(--muted); }
    .error {
      border: 1px solid color-mix(in oklab, var(--err) 40%, transparent);
      background: color-mix(in oklab, var(--err) 8%, var(--card));
      color: color-mix(in oklab, var(--err) 90%, var(--fg));
      padding: 12px 14px; border-radius: 12px; margin: 12px 0;
    }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    footer { margin: 18px 0 0; color: var(--muted); font-size: 14px; }
    .result { container-type: inline-size; }
    .result :is(h2,h3){ margin: .4em 0 .2em; }
    .result :is(p,li){ color: inherit; }
    .result ul{ margin: .2em 0 .6em .8em; }
    .watermark { position: fixed; inset: auto 12px 12px auto; opacity: .35; font-weight: 700; font-size: 12px; pointer-events: none; }
  </style>
</head>
<body>

  <!-- ====== NAVBAR identique à tes autres pages ====== -->
  <header>
    <div class="logo">
      <img src="../img/logo.png" alt="Logo Papo Rénov">
    </div>
    <nav>
      <ul>
        <li><a href="../index.html">Accueil</a></li>
        <li><a href="devis.html">Demande de devis</a></li>
        <li><a href="realisations.html">Mes réalisations</a></li>
        <li><a href="tarifs.html">Tarifs</a></li>
        <li><a href="planning.html">Planning</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="avis.html">Avis clients</a></li>
        <li><a href="courtage-cuisine.html">Courtage Cuisine</a></li>
      </ul>
    </nav>
  </header>
  <!-- ====== /NAVBAR ====== -->

  <div class="wrap">
    <header style="display:flex; align-items:center; justify-content: space-between; gap:12px; margin:14px 0 18px;">
      <div class="brand">
        <span class="logo" aria-hidden="true"></span>
        <div>
          <h1>Papo-Rénov · Estimation IA</h1>
          <div id="status" class="status"><span class="dot" aria-hidden="true"></span><span>Chargement de votre estimation…</span></div>
        </div>
      </div>
      <div class="tools">
        <button id="btnPrint" class="btn btn-primary" type="button">Imprimer</button>
        <!-- Suppression demandée : bouton Télécharger (HTML) et Copier le lien -->
        <!-- <button id="btnDownload" class="btn" type="button">Télécharger (HTML)</button> -->
        <!-- <button id="btnCopy" class="btn btn-ghost" type="button">Copier le lien</button> -->
      </div>
    </header>

    <main id="main" class="card">
      <!-- Suppression du texte "On déroule le tapis rouge…" -->
      <div id="placeholder" class="placeholder" hidden>
        <div></div>
      </div>

      <article id="result" class="result" hidden></article>
      <div id="error" class="error" hidden></div>
      <div class="actions-bottom">
        <button id="btnPrint2" class="btn btn-primary" type="button" hidden>Imprimer</button>
      </div>
    </main>

    <footer>
      <!-- Texte neutre après suppressions -->
      Estimation générée automatiquement à partir de votre brief.
    </footer>
  </div>

  <div class="watermark">Papo-Rénov</div>

  <noscript>
    <div class="card error" role="alert">Activez JavaScript pour afficher l’estimation.</div>
  </noscript>

  <script>
    // URL Web App (inchangée si tu as déjà mis à jour)
    const DEFAULT_SCRIPT_BASE = 'https://script.google.com/macros/s/AKfycbzYhaNEHxY2MOowz4lEKEEU9WW-3e73SA9u1BR3oMuxWCSaS5Womvxy52kGPmi5EqmYbA/exec';

    // Query params
    const usp = new URLSearchParams(location.search);
    const DIRECT_HTML = usp.get('html');  // rendu direct
    const ID = usp.get('id') || '';       // fallback historique
    const SCRIPT_BASE = usp.get('api') || DEFAULT_SCRIPT_BASE;
    const AUTO_PRINT = usp.get('print') === '1';

    // Sélecteurs
    const $status = document.getElementById('status');
    const $placeholder = document.getElementById('placeholder');
    const $result = document.getElementById('result');
    const $error = document.getElementById('error');
    const $btnPrint = document.getElementById('btnPrint');
    const $btnPrint2 = document.getElementById('btnPrint2');

    function setStatus(text, state) {
      if (!text) { $status.hidden = true; return; }
      $status.hidden = false;
      $status.querySelector('span:last-child').textContent = text;
      const dot = $status.querySelector('.dot');
      if (state === 'ok') { dot.style.background = 'var(--ok)'; }
      else if (state === 'err') { dot.style.background = 'var(--err)'; }
      else { dot.style.background = 'var(--warn)'; }
    }

    function showError(msg) {
      $placeholder.hidden = true;
      $result.hidden = true;
      $btnPrint2.hidden = true;
      $error.hidden = false;
      $error.textContent = msg;
      setStatus('Erreur lors du chargement.', 'err');
    }

    function sanitizeHypothesesSections(container) {
      // Supprime toute section dont le titre est "Hypothèses" ou commence par "Hypothèses"
      const headings = container.querySelectorAll('h2, h3');
      headings.forEach(h => {
        const t = (h.textContent || '').trim().toLowerCase();
        if (t === 'hypothèses' || t.startsWith('hypothèses ' ) || t.includes('hypothèses &')) {
          // Supprimer le titre + les blocs suivants jusqu’au prochain h2/h3
          let node = h;
          const toRemove = [node];
          while (node && node.nextElementSibling && !/^H[23]$/.test(node.nextElementSibling.tagName)) {
            node = node.nextElementSibling;
            toRemove.push(node);
          }
          toRemove.forEach(n => n.remove());
        }
      });
    }

    function ensureComparatifBlock(container) {
      // Si aucun tableau "Comparatif" n'est présent, injecter le bloc d'exemple demandé
      const hasComparatif = Array.from(container.querySelectorAll('h2, h3')).some(h => /comparatif/i.test(h.textContent || ''));
      if (hasComparatif) return;

      const wrapper = document.createElement('section');
      wrapper.innerHTML = `
        <h3>Comparatif type (exemple)</h3>
        <table>
          <thead>
            <tr><th>Critère</th><th>Enseigne A</th><th>Enseigne B</th><th>Fournisseur C</th><th>Objectif</th></tr>
          </thead>
          <tbody>
            <tr><td>Prix meubles</td><td>€€</td><td>€</td><td>€€€</td><td>€ le plus bas à qualité égale</td></tr>
            <tr><td>Plan de travail</td><td>Stratifié</td><td>Quartz</td><td>Compact HPL</td><td>Matériau adapté usage/budget</td></tr>
            <tr><td>Délais</td><td>2–3 sem</td><td>1–2 sem</td><td>4–5 sem</td><td>Synchronisé avec planning travaux</td></tr>
            <tr><td>Négociation</td><td>-10% obtenu</td><td>Livraison offerte</td><td>Non pertinent</td><td>Maximiser les avantages</td></tr>
          </tbody>
        </table>
        <p class="muted">Exemple indicatif. Le comparatif réel dépend de votre brief, marque choisie, matériaux et délais souhaités.</p>
      `;
      container.appendChild(wrapper);
    }

    function showDirectHtml(html) {
      $result.innerHTML = html;
      // Post-traitements demandés
      sanitizeHypothesesSections($result);     // 1) supprimer "Hypothèses"
      ensureComparatifBlock($result);          // 2) garantir le comparatif type (exemple)

      $placeholder.hidden = true;
      $error.hidden = true;
      $result.hidden = false;
      $btnPrint2.hidden = false;
      setStatus('Estimation chargée ✅', 'ok');
      if (AUTO_PRINT) setTimeout(() => window.print(), 200);
    }

    async function loadById() {
      try {
        if (!ID) {
          showError("Identifiant manquant dans l’URL (?id=...).");
          return;
        }
        if (!/^https?:\/\/.+\/exec$/.test(SCRIPT_BASE)) {
          setStatus('Configuration API absente, tentative quand même…', 'warn');
        }
        const url = `${SCRIPT_BASE}?fn=get&id=${encodeURIComponent(ID)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          throw new Error(`HTTP ${res.status} — ${txt.slice(0, 240)}`);
        }
        const data = await res.json();
        const html = (data && data.html) ? String(data.html) : '';
        if (!html) throw new Error('Réponse vide (html manquante).');
        showDirectHtml(html);
      } catch (err) {
        showError(String(err));
      }
    }

    // Actions
    $btnPrint.addEventListener('click', () => window.print());
    $btnPrint2.addEventListener('click', () => window.print());

    // Init
    setStatus('Chargement de votre estimation…', 'warn');
    if (DIRECT_HTML) {
      showDirectHtml(DIRECT_HTML);
    } else {
      loadById();
    }
  </script>
</body>
</html>
