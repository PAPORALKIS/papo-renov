<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Espace priv√© ‚Äì Papo R√©nov</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1120;
      --bg-alt:#020617;
      --card:#0f172a;
      --card-soft:#111827;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,0.15);
      --accent-strong:#0ea5e9;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --border:#1f2937;
      --danger:#ef4444;
      --warning:#facc15;
      --success:#22c55e;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.75);
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;}
    body{
      font-family:'Poppins',sans-serif;
      background: radial-gradient(circle at top left,#1d283a 0,#020617 55%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    a{color:var(--accent);text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* ===== HEADER MINIMAL (retour au site) ===== */
    header.pr-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 22px;
      border-bottom:1px solid rgba(148,163,184,0.25);
      background:linear-gradient(to right,rgba(15,23,42,0.96),rgba(15,23,42,0.9));
      backdrop-filter:blur(18px);
      position:sticky;
      top:0;
      z-index:20;
    }
    header.pr-header .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    header.pr-header img.logo{
      height:32px;
      width:auto;
      filter:drop-shadow(0 0 12px rgba(56,189,248,0.6));
    }
    header.pr-header .brand h1{
      font-size:1rem;
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    header.pr-header nav a{
      font-size:.85rem;
      color:var(--text-soft);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid transparent;
    }
    header.pr-header nav a:hover{
      border-color:rgba(148,163,184,0.4);
      color:#f9fafb;
      background:rgba(15,23,42,.9);
    }

    /* ===== LAYOUT GLOBAL ===== */
    .private-root{
      max-width:1360px;
      margin:22px auto 32px;
      padding:0 14px 24px;
    }

    /* ===== LOGIN ===== */
    .private-login{
      max-width:520px;
      margin:52px auto 0;
      padding:26px 26px 24px;
      border-radius:var(--radius-lg);
      background:radial-gradient(circle at top left,rgba(56,189,248,0.15),transparent 55%) , var(--card);
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,0.4);
      text-align:left;
    }
    .private-login h1{
      font-size:1.3rem;
      font-weight:700;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .private-login h1 span.badge{
      font-size:.7rem;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(15,23,42,0.94);
      border:1px solid rgba(148,163,184,0.55);
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#e5e7eb;
    }
    .private-login p{
      font-size:.9rem;
      color:var(--text-soft);
      margin-bottom:18px;
    }
    .private-login .field{
      display:flex;
      gap:8px;
      margin-bottom:10px;
    }
    .private-login input{
      flex:1;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:.9rem;
      outline:none;
    }
    .private-login input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .private-login button{
      padding:10px 16px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#0b1120;
      font-weight:600;
      font-size:.9rem;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 10px 30px rgba(56,189,248,0.45);
    }
    .private-login button:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }
    .private-login button:active{
      transform:translateY(0);
      box-shadow:0 4px 18px rgba(15,23,42,0.9);
    }
    #private-error{
      min-height:18px;
      font-size:.8rem;
      color:var(--danger);
      margin-top:4px;
    }
    .private-login .hint{
      font-size:.75rem;
      color:var(--text-soft);
      margin-top:10px;
    }
    /* =====  NOUVEAU CLIENT ===== */
.modal-new-client{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:60px;
  background:rgba(0,0,0,0.6);
  z-index:200;
}
.modal-new-client.show{
  display:flex;
}
.modal-panel{
  width:95%;
  max-width:520px;
  background:var(--card);
  border-radius:var(--radius-lg);
  padding:20px;
  border:1px solid var(--border);
  box-shadow:0 10px 40px rgba(0,0,0,0.4);
}
.modal-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-bottom:12px;
}
.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:14px;
}
    .modal-new-client label{
      font-size:.75rem;
      color:var(--text-soft);
      display:block;
      margin-bottom:2px;
    }
    .modal-new-client input,
    .modal-new-client select,
    .modal-new-client textarea{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.96);
      color:var(--text);
      font-size:.8rem;
      outline:none;
    }
    .modal-new-client textarea{
      min-height:70px;
      resize:vertical;
    }
    .modal-new-client input:focus,
    .modal-new-client select:focus,
    .modal-new-client textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .modal-new-client .btn-secondary{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.96);
      color:var(--text-soft);
      font-size:.8rem;
      padding:7px 12px;
      cursor:pointer;
    }
    .modal-new-client .btn-primary{
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#0b1120;
      font-weight:600;
      font-size:.8rem;
      padding:7px 14px;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(56,189,248,0.55);
    }
    .modal-new-client .btn-primary:active{
      transform:translateY(1px);
      box-shadow:0 4px 16px rgba(15,23,42,1);
    }
    #new-client-error{
      min-height:16px;
      font-size:.78rem;
      color:var(--danger);
      margin-top:2px;
    }


    /* ===== DASHBOARD LAYOUT ===== */
    #private-dashboard{
      display:none; /* affich√© apr√®s login */
      margin-top:22px;
      border-radius:22px;
      background:radial-gradient(circle at top left,rgba(56,189,248,0.08),transparent 60%) , var(--bg-alt);
      border:1px solid rgba(31,41,55,0.95);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }

    .dash-top{
      padding:16px 20px 14px;
      border-bottom:1px solid rgba(31,41,55,0.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background:linear-gradient(to right,rgba(15,23,42,0.98),rgba(15,23,42,0.92));
    }
    .dash-top .title-block{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .dash-top h2{
      font-size:1.1rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dash-top h2 .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--success);
      box-shadow:0 0 12px rgba(34,197,94,.9);
    }
    .dash-top .subtitle{
      font-size:.8rem;
      color:var(--text-soft);
    }
    .dash-top .mini-kpis{
      display:flex;
      gap:14px;
      font-size:.78rem;
      color:var(--text-soft);
    }
    .dash-top .mini-kpis span.label{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:500;
      color:#9ca3af;
    }
    .dash-top .mini-kpis span.value{
      font-weight:600;
      color:#e5e7eb;
    }

    .dash-body{
      display:grid;
      grid-template-columns:220px minmax(0,1fr);
      min-height:520px;
    }

    /* ===== MENU LATERAL ===== */
    .dash-menu{
      background:radial-gradient(circle at top,rgba(15,23,42,0.9),rgba(15,23,42,0.95));
      border-right:1px solid rgba(31,41,55,0.95);
      padding:16px 10px 16px 14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .dash-menu .section-label{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#6b7280;
      padding:0 6px;
    }
    .dash-menu button{
      width:100%;
      text-align:left;
      padding:8px 10px;
      margin-bottom:2px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text-soft);
      font-size:.8rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dash-menu button span.icon{
      width:20px;
      text-align:center;
      opacity:.9;
    }
    .dash-menu button span.label{
      flex:1;
    }
    .dash-menu button span.tag{
      font-size:.7rem;
      padding:2px 7px;
      background:rgba(15,23,42,0.9);
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      color:#9ca3af;
    }
    .dash-menu button:hover{
      border-color:rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.95);
      color:#e5e7eb;
    }
    .dash-menu button.active{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:#e5f6ff;
    }
    .dash-menu button.active span.icon{
      color:var(--accent-strong);
    }

    /* ===== PANELS ===== */
    .dash-main{
      padding:16px 18px 20px;
      overflow:auto;
      background:radial-gradient(circle at top right,rgba(15,23,42,0.9),rgba(15,23,42,1));
    }
    .panel{
      display:none;
      animation:fadeIn .2s ease-out;
    }
    .panel.active{
      display:block;
    }
    .panel h2{
      font-size:1.05rem;
      margin-bottom:8px;
    }
    .panel p.description{
      font-size:.85rem;
      color:var(--text-soft);
      margin-bottom:14px;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(4px);}
      to{opacity:1;transform:translateY(0);}
    }

    /* ===== KPI GRID DASHBOARD ===== */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
      margin-bottom:16px;
    }
    .kpi-card{
      padding:11px 12px 10px;
      border-radius:var(--radius-md);
      background:linear-gradient(145deg,rgba(15,23,42,0.98),rgba(15,23,42,0.92));
      border:1px solid rgba(31,41,55,0.95);
    }
    .kpi-card .label{
      font-size:.78rem;
      color:var(--text-soft);
      margin-bottom:4px;
    }
    .kpi-card .value{
      font-size:1.1rem;
      font-weight:600;
    }
    .kpi-card .pill{
      margin-top:4px;
      font-size:.72rem;
      color:#9ca3af;
    }

    /* ===== LISTES ET TABLES ===== */
    .two-columns{
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1fr);
      gap:14px;
    }

    .card-block{
      border-radius:var(--radius-md);
      background:var(--card);
      border:1px solid var(--border);
      padding:10px 12px;
    }
    .card-block h3{
      font-size:.9rem;
      margin-bottom:6px;
    }
    .card-block p.sub{
      font-size:.78rem;
      color:var(--text-soft);
      margin-bottom:8px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
    }
    thead{
      background:rgba(15,23,42,0.95);
    }
    th,td{
      padding:6px 6px;
      border-bottom:1px solid rgba(31,41,55,0.9);
      text-align:left;
    }
    th{
      font-weight:500;
      color:#9ca3af;
      font-size:.75rem;
    }
    tbody tr:hover{
      background:rgba(15,23,42,0.9);
      cursor:pointer;
    }
    .badge-status{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.8);
      font-size:.68rem;
    }
    .badge-status.en-cours{
      border-color:var(--accent);
      color:var(--accent-strong);
      background:rgba(15,23,42,0.96);
    }
    .badge-status.termine{
      border-color:var(--success);
      color:var(--success);
      background:rgba(15,23,42,0.96);
    }
    .badge-status.attente{
      border-color:var(--warning);
      color:var(--warning);
      background:rgba(15,23,42,0.96);
    }

    /* ===== S√©lection dans la liste des clients ===== */
    #clients-table tbody tr.selected{
      background:rgba(15,23,42,1);
    }

    /* ===== Mise en forme de la fiche client ===== */
    #client-details .client-main{
      margin-bottom:8px;
    }
    #client-details .client-name{
      font-weight:600;
      font-size:.9rem;
      margin-bottom:4px;
    }
    #client-details .client-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      font-size:.75rem;
    }
    #client-details .tag-project{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      color:#e5e7eb;
    }
    #client-details .client-cols{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:10px;
      margin-top:8px;
      font-size:.78rem;
    }
    #client-details h4{
      font-size:.78rem;
      margin-bottom:4px;
      color:var(--text-soft);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    #client-details .client-notes{
      margin-top:10px;
      font-size:.78rem;
    }
    #client-details .client-notes p{
      white-space:pre-wrap;
    }

    .toolbar{

      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .toolbar input[type="search"],
    .toolbar select{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.96);
      color:var(--text);
      font-size:.78rem;
      outline:none;
    }
    .toolbar button{
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.7);
      background:var(--accent-soft);
      color:#e0f2fe;
      font-size:.78rem;
      cursor:pointer;
    }
    .toolbar button:hover{
      filter:brightness(1.05);
    }

    /* NOTES */
    .notes-list{
      list-style:none;
      max-height:260px;
      overflow:auto;
    }
    .notes-list li{
      padding:6px 6px 7px;
      border-bottom:1px dashed rgba(31,41,55,0.85);
      font-size:.78rem;
    }
    .notes-list li .title{
      font-weight:500;
    }
    .notes-list li .meta{
      font-size:.7rem;
      color:#9ca3af;
    }
    .note-editor input,
    .note-editor textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.98);
      color:var(--text);
      font-size:.8rem;
      padding:7px 9px;
      outline:none;
    }
    .note-editor textarea{
      min-height:110px;
      resize:vertical;
    }
    .note-editor input:focus,
    .note-editor textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .note-editor button{
      margin-top:6px;
      padding:7px 12px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#0b1120;
      font-size:.8rem;
      font-weight:600;
      cursor:pointer;
    }

    /* RESPONSIVE */
    @media(max-width:900px){
      .dash-body{
        grid-template-columns: minmax(0,1fr);
      }
      .dash-menu{
        flex-direction:row;
        overflow:auto;
        padding-right:12px;
      }
      .dash-menu button{
        white-space:nowrap;
      }
      .two-columns{
        grid-template-columns:1fr;
      }
    }
    @media(max-width:600px){
      .private-login{
        margin-top:26px;
        padding:18px 16px 16px;
      }
      .private-root{
        padding:0 10px 20px;
      }
      header.pr-header{
        padding:8px 12px;
      }
    }
  </style>
</head>
<body>

<header class="pr-header">
  <div class="brand">
    <img src="../img/logo.png" alt="Papo R√©nov" class="logo">
    <h1>Papo R√©nov‚Äô ‚Äì Espace priv√©</h1>
  </div>
  <nav>
    <a href="../index.html">‚Üê Retour au site</a>
  </nav>
</header>

<div class="private-root">

  <!-- ===== LOGIN ===== -->
  <section class="private-login" id="private-login">
    <h1>
      Espace de pilotage
      <span class="badge">Priv√©</span>
    </h1>
    <p>
      Acc√®s strictement r√©serv√© √† l‚Äôadministrateur.  
      G√©rez vos clients, chantiers, devis, partenaires et statistiques depuis un seul endroit.
    </p>
    <div class="field">
      <input type="password" id="private-code" placeholder="Mot de passe administrateur">
      <button id="private-enter">Entrer</button>
    </div>
    <div id="private-error"></div>
    <p class="hint">
      Astuce : ce mot de passe est diff√©rent de l‚Äôacc√®s PRO partenaire.  
      Vous pouvez le modifier directement dans le code de cette page (const <code>PRIVATE_CODE</code>).
    </p>
  </section>

  <!-- ===== DASHBOARD ===== -->
  <section id="private-dashboard">
    <div class="dash-top">
      <div class="title-block">
        <h2>
          <span class="dot"></span>
          Papo R√©nov‚Äô ‚Äì Tableau de bord priv√©
        </h2>
        <div class="subtitle">
          Vue d‚Äôensemble de votre activit√© : clients, devis, chantiers, partenaires et site web.
        </div>
      </div>
      <div class="mini-kpis">
        <div>
          <span class="label">Vue :</span>
          <span class="value" id="mini-view-label">Aujourd‚Äôhui</span>
        </div>
        <div>
          <span class="label">Mode :</span>
          <span class="value">Administrateur</span>
        </div>
      </div>
    </div>

    <div class="dash-body">
      <!-- MENU LATERAL -->
      <aside class="dash-menu">
        <div class="section-label">Vue g√©n√©rale</div>
        <button class="active" data-target="panel-dashboard">
          <span class="icon">üìä</span>
          <span class="label">Tableau de bord</span>
        </button>

        <div class="section-label">Gestion op√©rationnelle</div>
        <button data-target="panel-clients">
          <span class="icon">üë•</span>
          <span class="label">Clients</span>
        </button>
        <button data-target="panel-devis">
          <span class="icon">üìÑ</span>
          <span class="label">Devis</span>
        </button>
        <button data-target="panel-chantiers">
          <span class="icon">üß±</span>
          <span class="label">Chantiers</span>
        </button>
        <button data-target="panel-partenaires">
          <span class="icon">ü§ù</span>
          <span class="label">Partenaires & R√©compenses</span>
        </button>

        <div class="section-label">Suivi & ressources</div>
        <button data-target="panel-stats-site">
          <span class="icon">üìà</span>
          <span class="label">Stats du site</span>
        </button>
        <button data-target="panel-documents">
          <span class="icon">üìÇ</span>
          <span class="label">Documents</span>
        </button>
        <button data-target="panel-notes">
          <span class="icon">üìù</span>
          <span class="label">Notes & pense-b√™tes</span>
        </button>

        <div class="section-label">Technique</div>
        <button data-target="panel-admin">
          <span class="icon">‚öôÔ∏è</span>
          <span class="label">Admin</span>
          <span class="tag">Tech</span>
        </button>
      </aside>

      <!-- CONTENU PRINCIPAL -->
      <main class="dash-main">

        <!-- PANEL TABLEAU DE BORD -->
        <section id="panel-dashboard" class="panel active">
          <h2>Tableau de bord</h2>
          <p class="description">
            Synth√®se rapide de votre activit√©. Les donn√©es seront ensuite reli√©es √† votre fichier
            <strong>PAPORENOV_BACKOFFICE</strong> (clients, devis, chantiers, stats‚Ä¶).
          </p>

          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="label">Chantiers en cours</div>
              <div class="value" id="kpi-chantiers-en-cours">0</div>
              <div class="pill">Bas√© sur l‚Äôonglet <code>chantiers</code></div>
            </div>
            <div class="kpi-card">
              <div class="label">Devis en attente</div>
              <div class="value" id="kpi-devis-attente">0</div>
              <div class="pill">Statut : <code>envoye</code> / <code>brouillon</code></div>
            </div>
            <div class="kpi-card">
              <div class="label">Clients actifs</div>
              <div class="value" id="kpi-clients-actifs">0</div>
              <div class="pill">Onglet <code>clients</code> (statut en_cours)</div>
            </div>
            <div class="kpi-card">
              <div class="label">Demandes depuis le site</div>
              <div class="value" id="kpi-demandes-site">0</div>
              <div class="pill">Onglet <code>stats_site</code> (demandes_devis)</div>
            </div>
          </div>

          <div class="two-columns">
            <div class="card-block">
              <h3>Chantiers en cours</h3>
              <p class="sub">Extrait des chantiers en statut <code>en_cours</code>. (Lecture Sheets √† brancher).</p>
              <table>
                <thead>
                  <tr>
                    <th>Chantier</th>
                    <th>Client</th>
                    <th>Statut</th>
                    <th>Fin pr√©vue</th>
                  </tr>
                </thead>
                <tbody id="dash-chantiers-body">
                  <tr>
                    <td colspan="4">Connexion aux donn√©es √† venir. Pour l‚Äôinstant, cette zone sert de maquette.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="card-block">
              <h3>Derni√®res notes internes</h3>
              <p class="sub">Onglet <code>notes</code> de votre fichier backoffice.</p>
              <ul class="notes-list" id="dash-notes-list">
                <li>
                  <div class="title">Bienvenue dans votre espace priv√©</div>
                  <div class="meta">Tag : admin ‚Äì Cette note dispara√Ætra quand l‚Äôonglet sera connect√©.</div>
                </li>
              </ul>
            </div>
          </div>
        </section>

        <!-- PANEL CLIENTS -->
        <section id="panel-clients" class="panel">
          <h2>Clients</h2>
          <p class="description">
            Liste et fiches d√©taill√©es de vos clients. Les donn√©es viendront de l‚Äôonglet <code>clients</code>.
          </p>

          <div class="toolbar">
            <input type="search" id="search-client" placeholder="Rechercher un client (nom, email‚Ä¶)" />
            <select id="filter-clients-statut">
              <option value="">Tous les statuts</option>
              <option value="prospect">Prospect</option>
              <option value="en_cours">En cours</option>
              <option value="termine">Termin√©</option>
              <option value="perdu">Perdu</option>
            </select>
            <button id="btn-new-client" type="button">+ Nouveau client</button>
          </div>

          <div class="two-columns">
            <div class="card-block">
              <h3>Liste des clients</h3>
              <table id="clients-table">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Projet</th>
                    <th>Statut</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>‚Äî</td>
                    <td>‚Äî</td>
                    <td><span class="badge-status attente">en attente de donn√©es</span></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="card-block" id="client-details">
              <h3>Fiche client</h3>
              <p class="sub">S√©lectionnez un client dans la liste pour afficher les d√©tails.</p>
              <p style="font-size:.8rem;color:var(--text-soft);">
                Cette zone affichera : coordonn√©es, historique devis, chantiers li√©s, notes internes.
              </p>
            </div>
          </div>
                  <!-- Modal nouveau client -->
        <div id="modal-new-client" class="modal-new-client">
          <div class="modal-backdrop"></div>
          <div class="modal-panel">
            <h3>Nouveau client</h3>
            <p class="sub">
              Ajoute un nouveau contact dans l‚Äôonglet <code>clients</code> du backoffice.
            </p>

            <form id="form-new-client" autocomplete="off">
              <div class="modal-grid">
                <div>
                  <label for="nc-prenom">Pr√©nom</label>
                  <input id="nc-prenom" name="prenom" type="text">
                </div>
                <div>
                  <label for="nc-nom">Nom</label>
                  <input id="nc-nom" name="nom" type="text">
                </div>
                <div>
                  <label for="nc-telephone">T√©l√©phone</label>
                  <input id="nc-telephone" name="telephone" type="tel">
                </div>
                <div>
                  <label for="nc-email">Email</label>
                  <input id="nc-email" name="email" type="email">
                </div>
                <div>
                  <label for="nc-adresse">Adresse</label>
                  <input id="nc-adresse" name="adresse" type="text">
                </div>
                <div>
                  <label for="nc-ville">Ville</label>
                  <input id="nc-ville" name="ville" type="text">
                </div>
                <div>
                  <label for="nc-cp">Code postal</label>
                  <input id="nc-cp" name="code_postal" type="text">
                </div>
                <div>
                  <label for="nc-type">Type de projet</label>
                  <select id="nc-type" name="type_projet">
                    <option value="">‚Äî</option>
                    <option value="cuisine">Cuisine</option>
                    <option value="salle_de_bain">Salle de bain</option>
                    <option value="dressing">Dressing / rangement</option>
                    <option value="global">R√©novation globale</option>
                    <option value="exterieur">Ext√©rieur</option>
                    <option value="autre">Autre</option>
                  </select>
                </div>
                <div>
                  <label for="nc-source">Source</label>
                  <select id="nc-source" name="source">
                    <option value="">Non pr√©cis√©</option>
                    <option value="site_web">Site web</option>
                    <option value="contact_direct">Contact direct</option>
                    <option value="partenaire">Partenaire</option>
                    <option value="recommandation">Recommandation</option>
                  </select>
                </div>
                <div>
                  <label for="nc-statut">Statut</label>
                  <select id="nc-statut" name="statut">
                    <option value="prospect">Prospect</option>
                    <option value="en_cours">En cours</option>
                    <option value="termine">Termin√©</option>
                    <option value="perdu">Perdu</option>
                  </select>
                </div>
              </div>

              <div>
                <label for="nc-notes">Notes internes</label>
                <textarea id="nc-notes" name="notes_internes"
                  placeholder="Contexte, besoins, infos importantes‚Ä¶"></textarea>
              </div>

              <div id="new-client-error"></div>

              <div class="modal-actions">
                <button type="button" class="btn-secondary" id="btn-cancel-new-client">Annuler</button>
                <button type="submit" class="btn-primary" id="btn-save-new-client">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
          <!-- Modal nouveau devis -->
          <div id="modal-new-devis" class="modal-new-client">
            <div class="modal-backdrop"></div>
            <div class="modal-panel">
              <h3>Nouveau devis</h3>
              <p class="sub">
                Cr√©e un devis dans l‚Äôonglet <code>devis</code> du backoffice (num√©rotation auto DEV-000X).
              </p>

              <form id="form-new-devis" autocomplete="off">
                <div class="modal-grid">
                  <div>
                    <label for="nd-client">Client</label>
                    <input id="nd-client" name="client" type="text" placeholder="Nom / Pr√©nom ou raison sociale">
                  </div>
                  <div>
                    <label for="nd-type">Type de projet</label>
                    <input id="nd-type" name="type_projet" type="text" placeholder="Cuisine, SDB, global‚Ä¶">
                  </div>
                  <div>
                    <label for="nd-montant">Montant HT estim√©</label>
                    <input id="nd-montant" name="montant_ht" type="number" step="0.01" placeholder="Ex : 8500">
                  </div>
                  <div>
                    <label for="nd-statut">Statut</label>
                    <select id="nd-statut" name="statut">
                      <option value="brouillon">Brouillon</option>
                      <option value="envoye">Envoy√©</option>
                      <option value="accepte">Accept√©</option>
                      <option value="signe">Sign√©</option>
                      <option value="refuse">Refus√©</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label for="nd-commentaire">Commentaire interne</label>
                  <textarea id="nd-commentaire" name="commentaire"
                    placeholder="Contexte du devis, infos cliente, particularit√©s‚Ä¶"></textarea>
                </div>

                <div id="new-devis-error"></div>

                <div class="modal-actions">
                  <button type="button" class="btn-secondary" id="btn-cancel-new-devis">Annuler</button>
                  <button type="submit" class="btn-primary" id="btn-save-new-devis">Enregistrer</button>
                </div>
              </form>
            </div>
          </div>

        </section>

        <!-- PANEL DEVIS -->
        <section id="panel-devis" class="panel">
          <h2>Devis</h2>
          <p class="description">
            Suivi des devis (brouillons, envoy√©s, accept√©s, refus√©s, sign√©s). Source : onglet <code>devis</code>.
          </p>

          <div class="toolbar">
            <select id="filter-devis-status">
              <option value="">Tous les statuts</option>
              <option value="brouillon">Brouillon</option>
              <option value="envoye">Envoy√©</option>
              <option value="accepte">Accept√©</option>
              <option value="refuse">Refus√©</option>
              <option value="signe">Sign√©</option>
            </select>
            <button id="btn-new-devis" type="button">+ Nouveau devis (√† venir)</button>
          </div>

          <div class="card-block">
            <h3>Liste des devis</h3>
            <table id="devis-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Client</th>
                  <th>Montant HT</th>
                  <th>Statut</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>DEV-0001</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td><span class="badge-status attente">non connect√©</span></td>
                  <td>‚Äî</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- PANEL CHANTIERS -->
        <section id="panel-chantiers" class="panel">
          <h2>Chantiers</h2>
          <p class="description">
            Vue globale des chantiers planifi√©s, en cours et termin√©s. Source : onglet <code>chantiers</code>.
          </p>

              <div class="toolbar">
            <select id="filter-chantiers-status">
              <option value="">Tous les statuts</option>
              <option value="preparation">Pr√©paration</option>
              <option value="en_cours">En cours</option>
              <option value="en_pause">En pause</option>
              <option value="termine">Termin√©</option>
              <option value="sav">SAV</option>
            </select>
            <button id="btn-new-chantier" type="button">+ Nouveau chantier</button>
          </div>


          <div class="two-columns">
            <div class="card-block">
              <h3>Liste des chantiers</h3>
              <table id="chantiers-table">
                <thead>
                  <tr>
                    <th>Chantier</th>
                    <th>Client</th>
                    <th>Statut</th>
                    <th>Fin pr√©vue</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>‚Äî</td>
                    <td>‚Äî</td>
                    <td><span class="badge-status attente">√† connecter</span></td>
                    <td>‚Äî</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="card-block" id="chantier-details">
              <h3>D√©tail chantier</h3>
              <p class="sub">S√©lectionnez un chantier pour afficher les informations d√©taill√©es.</p>
              <p style="font-size:.8rem;color:var(--text-soft);">
                Informations pr√©vues : type de projet, adresse, planning, responsable, notes, liens photos.
              </p>
            </div>
                      <!-- Modal nouveau chantier -->
          <div id="modal-new-chantier" class="modal-new-client">
            <div class="modal-backdrop"></div>
            <div class="modal-panel">
              <h3>Nouveau chantier</h3>
              <p class="sub">
                Cr√©e un chantier dans l‚Äôonglet <code>chantiers</code> du backoffice (num√©rotation auto CH-000X).
              </p>

              <form id="form-new-chantier" autocomplete="off">
                <div class="modal-grid">
                  <div>
                    <label for="nc2-client">Client</label>
                    <input id="nc2-client" name="client" type="text" placeholder="Nom / Pr√©nom ou raison sociale">
                  </div>
                  <div>
                    <label for="nc2-type">Type de projet</label>
                    <input id="nc2-type" name="type_projet" type="text" placeholder="Cuisine, SDB, global‚Ä¶">
                  </div>
                  <div>
                    <label for="nc2-adresse">Adresse</label>
                    <input id="nc2-adresse" name="adresse" type="text">
                  </div>
                  <div>
                    <label for="nc2-ville">Ville</label>
                    <input id="nc2-ville" name="ville" type="text">
                  </div>
                  <div>
                    <label for="nc2-cp">Code postal</label>
                    <input id="nc2-cp" name="code_postal" type="text">
                  </div>
                  <div>
                    <label for="nc2-statut">Statut</label>
                    <select id="nc2-statut" name="statut">
                      <option value="preparation">Pr√©paration</option>
                      <option value="en_cours">En cours</option>
                      <option value="en_pause">En pause</option>
                      <option value="termine">Termin√©</option>
                      <option value="sav">SAV</option>
                    </select>
                  </div>
                  <div>
                    <label for="nc2-debut">Date de d√©but</label>
                    <input id="nc2-debut" name="date_debut" type="date">
                  </div>
                  <div>
                    <label for="nc2-fin">Fin pr√©vue</label>
                    <input id="nc2-fin" name="date_fin_prevue" type="date">
                  </div>
                </div>

                <div>
                  <label for="nc2-notes">Notes chantier</label>
                  <textarea id="nc2-notes" name="notes_internes"
                    placeholder="Infos techniques, d√©lais, d√©pendances, mat√©riel‚Ä¶"></textarea>
                </div>

                <div id="new-chantier-error"></div>

                <div class="modal-actions">
                  <button type="button" class="btn-secondary" id="btn-cancel-new-chantier">Annuler</button>
                  <button type="submit" class="btn-primary" id="btn-save-new-chantier">Enregistrer</button>
                </div>
              </form>
            </div>
          </div>

          </div>
        </section>

        <!-- PANEL PARTENAIRES -->
        <section id="panel-partenaires" class="panel">
          <h2>Partenaires & R√©compenses</h2>
          <p class="description">
            Synth√®se des partenaires et de leurs compteurs (poses attribu√©es, sans SAV, jours offerts).
            Bas√© sur vos onglets <code>partenaires</code>, <code>partner_stats</code> et <code>partner_logs</code>.
          </p>

          <div class="card-block">
            <h3>Liste des partenaires</h3>
            <table id="partenaires-table">
              <thead>
                <tr>
                  <th>Partenaire</th>
                  <th>Contact</th>
                  <th>Type</th>
                  <th>Poses attribu√©es</th>
                  <th>Sans SAV</th>
                  <th>Jours offerts (estim√©)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>0</td>
                  <td>0</td>
                  <td>0</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- PANEL STATS SITE -->
        <section id="panel-stats-site" class="panel">
          <h2>Statistiques du site</h2>
          <p class="description">
            Vue synth√©tique de l‚Äôactivit√© de votre site (visites, demandes de devis, clics contact).
            Source initiale : onglet <code>stats_site</code>. Connexion √† Google Analytics possible plus tard.
          </p>

          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="label">Visites (p√©riode r√©cente)</div>
              <div class="value" id="kpi-visites">0</div>
              <div class="pill">Onglet stats_site</div>
            </div>
            <div class="kpi-card">
              <div class="label">Demandes de devis</div>
              <div class="value" id="kpi-demande-devis">0</div>
              <div class="pill">Bas√© sur demandes_devis</div>
            </div>
            <div class="kpi-card">
              <div class="label">Clics ‚ÄúContact‚Äù</div>
              <div class="value" id="kpi-clics-contact">0</div>
              <div class="pill">Colonnes clics_contact</div>
            </div>
          </div>

          <div class="card-block">
            <h3>Graphique d‚Äô√©volution (placeholder)</h3>
            <p class="sub">
              Cette zone pourra accueillir un graphique (visites / demandes / conversions) quand on aura branch√©
              soit votre onglet <code>stats_site</code>, soit Google Analytics.
            </p>
            <div id="stats-chart" style="height:180px;border-radius:10px;border:1px dashed rgba(55,65,81,0.9);display:flex;align-items:center;justify-content:center;font-size:.8rem;color:#6b7280;">
              Graphique √† venir ‚Äî pour l‚Äôinstant, maquette visuelle uniquement.
            </div>
          </div>
        </section>

        <!-- PANEL DOCUMENTS -->
        <section id="panel-documents" class="panel">
          <h2>Documents</h2>
          <p class="description">
            Biblioth√®que de documents (mod√®les, contrats, factures fournisseurs‚Ä¶). Source : onglet <code>documents</code>.
          </p>

          <div class="toolbar">
            <select id="filter-doc-category">
              <option value="">Toutes les cat√©gories</option>
              <option value="contrat">Contrats</option>
              <option value="modele">Mod√®les</option>
              <option value="facture_fournisseur">Factures fournisseurs</option>
              <option value="modele_devis">Mod√®les de devis</option>
              <option value="autre">Autres</option>
            </select>
            <button id="btn-new-doc" type="button">+ Ajouter un document (manuellement au d√©but)</button>
          </div>

          <div class="card-block">
            <h3>Liste des documents</h3>
            <table id="documents-table">
              <thead>
                <tr>
                  <th>Cat√©gorie</th>
                  <th>Libell√©</th>
                  <th>Lien</th>
                  <th>Commentaire</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>Onglet documents √† connecter</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- PANEL NOTES -->
        <section id="panel-notes" class="panel">
          <h2>Notes & pense-b√™tes</h2>
          <p class="description">
            Zone de notes interne (id√©es, t√¢ches, rappels). Source : onglet <code>notes</code>.
          </p>

          <div class="two-columns">
            <div class="card-block">
              <h3>Liste des notes</h3>
              <ul class="notes-list" id="notes-list">
                <li>
                  <div class="title">Exemple de note</div>
                  <div class="meta">Tag : admin ‚Äì Cette liste sera aliment√©e par l‚Äôonglet notes.</div>
                  <div class="meta">Contenu : pense-b√™tes, id√©es, choses √† appeler, mat√©riel √† commander‚Ä¶</div>
                </li>
              </ul>
            </div>

            <div class="card-block note-editor">
              <h3>Nouvelle note (maquette)</h3>
              <input type="text" id="note-title" placeholder="Titre de la note">
              <textarea id="note-content" placeholder="Contenu, d√©tails, id√©es‚Ä¶"></textarea>
              <input type="text" id="note-tag" placeholder="Tag (urgent, id√©e, admin, perso, etc.)">
              <button id="btn-save-note" type="button">Enregistrer (√† connecter plus tard)</button>
            </div>
          </div>
        </section>

        <!-- PANEL ADMIN -->
        <section id="panel-admin" class="panel">
          <h2>Mode Admin</h2>
          <p class="description">
            Liens rapides vers les outils techniques (Sheets, Apps Script, GitHub) et v√©rification de l‚ÄôAPI.
          </p>

          <div class="card-block" style="margin-bottom:12px;">
            <h3>Liens Backoffice</h3>
            <p class="sub">Adapte les URL ci-dessous avec tes liens r√©els (Sheets, Apps Script, GitHub).</p>
            <ul style="font-size:.8rem;line-height:1.6;">
              <li>üìë Fichier Backoffice : <span style="color:#93c5fd;">√† renseigner (URL Sheets)</span></li>
              <li>üí∂ Fichier Tarifs : <span style="color:#93c5fd;">d√©j√† utilis√© pour tes pages tarifs</span></li>
              <li>‚öôÔ∏è Apps Script WebApp : <span style="color:#93c5fd;">ton URL actuelle /exec</span></li>
              <li>üíª D√©p√¥t GitHub : <span style="color:#93c5fd;">https://github.com/‚Ä¶/papo-renov</span></li>
            </ul>
          </div>

          <div class="card-block">
            <h3>Test rapide API (maquette)</h3>
            <p class="sub">
              On pourra ici tester rapidement si l‚ÄôAPI Apps Script r√©pond (ping, tarifs, partenaires‚Ä¶). Pour l‚Äôinstant,
              c‚Äôest une zone r√©serv√©e √† la phase de branchement.
            </p>
            <button type="button" style="font-size:.78rem;">Tester l‚ÄôAPI (√† brancher plus tard)</button>
          </div>
        </section>

      </main>
    </div>
  </section>
</div>

<script>
  // =========================
  // MOT DE PASSE ESPACE PRIV√â
  // =========================
  // URL de ta WebApp Backoffice
const WEB_APP_URL = 
"https://script.google.com/macros/s/AKfycbyemfjgPUxJhhYPkGvf4WGtCogUJgDW1ZfmPdZ3KTvf0b-9QpjQAqUjYzCQKQW6MOsg/exec";
  const PRIVATE_CODE = "fang"; // üîê change-le comme tu veux

  const loginSection    = document.getElementById('private-login');
  const dashboard       = document.getElementById('private-dashboard');
  const inputPrivate    = document.getElementById('private-code');
  const btnPrivateEnter = document.getElementById('private-enter');
  const privateError    = document.getElementById('private-error');
  // Cache en m√©moire de la liste des clients
  let CLIENTS_CACHE = [];

  // Panneau fiche client
  const clientDetails = document.getElementById('client-details');
  // Cache Devis / Chantiers
  let DEVIS_CACHE = [];
  let CHANTIERS_CACHE = [];

  // Panneau d√©tail chantier
  const chantierDetails = document.getElementById('chantier-details');

  
  // Si l'admin est d√©j√† authentifi√© via acces-admin.html,
// on bypass le mot de passe interne et on ouvre directement le dashboard.
const isAdminAuth = (localStorage.getItem("admin_auth") === "true");
if(isAdminAuth){
  loginSection.style.display = 'none';
  dashboard.style.display = 'block';
  const mini = document.getElementById('mini-view-label');
  if(mini) mini.textContent = "Vue globale";

  // si les fonctions de chargement existent, on les appelle
  if(typeof loadDashboardKpis === "function") loadDashboardKpis();
  if(typeof loadClientsList === "function")   loadClientsList();
    if(typeof loadDevisList === "function")     loadDevisList();
  if(typeof loadChantiersList === "function") loadChantiersList();
}
  function unlockIfValid(){
    const value = (inputPrivate.value || '').trim();
    if(!value){
      privateError.textContent = "Merci de saisir le mot de passe administrateur.";
      return;
    }
    if(value === PRIVATE_CODE){
      privateError.textContent = "";
      localStorage.setItem("admin_auth","true");
      loginSection.style.display = 'none';
      dashboard.style.display = 'block';
      // petit effet de focus sur la vue principale
      document.getElementById('mini-view-label').textContent = "Vue globale";
      window.scrollTo({top:0,behavior:'smooth'});

      if(typeof loadDashboardKpis === "function") loadDashboardKpis();
      if(typeof loadClientsList === "function")   loadClientsList();
      if(typeof loadDevisList === "function")     loadDevisList();
      if(typeof loadChantiersList === "function") loadChantiersList();
    }else{
      privateError.textContent = "Mot de passe incorrect.";
    }

  }

  btnPrivateEnter.addEventListener('click', unlockIfValid);
  inputPrivate.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ unlockIfValid(); }
  });

  // =========================
  // NAVIGATION ENTRE PANELS
  // =========================
  const menuButtons = document.querySelectorAll('.dash-menu button');
  const panels = document.querySelectorAll('.panel');

  menuButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const targetId = btn.dataset.target;
      if(!targetId) return;
      menuButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      panels.forEach(p=>{
        if(p.id === targetId) p.classList.add('active');
        else p.classList.remove('active');
      });
    });
  });
// =========================
// CHARGEMENT DONN√âES BACKOFFICE
// =========================

// Remplit les KPI du dashboard
async function loadDashboardKpis(){
  try{
    const r = await fetch(`${WEB_APP_URL}?path=bo&resource=dashboard`, {cache:'no-store'});
    const j = await r.json();
    if(!j.ok) return;

    const k = (j.data && j.data.kpi) ? j.data.kpi : {};

    const elChantiers = document.getElementById('kpi-chantiers-en-cours');
    const elDevis     = document.getElementById('kpi-devis-attente');
    const elClients   = document.getElementById('kpi-clients-actifs');
    const elDemandes  = document.getElementById('kpi-demandes-site');

    if(elChantiers) elChantiers.textContent = k.chantiersEnCours ?? 0;
    if(elDevis)     elDevis.textContent     = k.devisAttente ?? 0;
    if(elClients)   elClients.textContent   = k.clientsActifs ?? 0;
    if(elDemandes)  elDemandes.textContent  = k.demandesSite ?? 0;
  }catch(e){
    console.log('Erreur dashboard', e);
  }
}

// Remplit la liste de clients (lecture seule depuis l‚Äôonglet "clients")
// Charge les clients depuis l'API et remplit le cache
async function loadClientsList(){
  try{
    const r = await fetch(`${WEB_APP_URL}?path=bo&resource=clients`, {cache:'no-store'});
    const j = await r.json();
    if(!j.ok) return;

    CLIENTS_CACHE = j.rows || [];
    applyClientFiltersAndRender();
  }catch(e){
    console.log('Erreur clients', e);
  }
}
// Applique recherche + filtre statut puis rend le tableau
function applyClientFiltersAndRender(){
  const searchInput  = document.getElementById('search-client');
  const statusSelect = document.getElementById('filter-clients-statut');

  const search = (searchInput?.value || '').trim().toLowerCase();
  const statut = (statusSelect?.value || '').trim();

  let rows = CLIENTS_CACHE.slice();

  if(search){
    rows = rows.filter(c=>{
      const bloc = [
        c.nom, c.prenom, c.email,
        c.telephone, c.ville, c.type_projet
      ].map(x => (x || '').toString().toLowerCase()).join(' ');
      return bloc.includes(search);
    });
  }

  if(statut){
    rows = rows.filter(c => String(c.statut || '').trim() === statut);
  }

  renderClientsTable(rows);
}

// Construit visuellement le <tbody> de la liste
function renderClientsTable(rows){
  const tbody = document.querySelector('#clients-table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  if(!rows || rows.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 3;
    td.textContent = "Aucun client trouv√© dans l‚Äôonglet 'clients'.";
    tr.appendChild(td);
    tbody.appendChild(tr);

    // on remet la fiche en mode ‚Äúvide‚Äù
    if(clientDetails){
      clientDetails.innerHTML = `
        <h3>Fiche client</h3>
        <p class="sub">S√©lectionnez un client dans la liste pour afficher les d√©tails.</p>
        <p style="font-size:.8rem;color:var(--text-soft);">
          Cette zone affichera : coordonn√©es, historique devis, chantiers li√©s, notes internes.
        </p>
      `;
    }
    return;
  }

  rows.forEach(c=>{
    const tr   = document.createElement('tr');
    const nom  = [c.prenom, c.nom].filter(Boolean).join(' ') || '‚Äî';
    const proj = c.type_projet || '‚Äî';
    const st   = (c.statut || '').toString().trim() || '‚Äî';

    // on garde l'id_client pour aller chercher les d√©tails
    tr.dataset.clientId = String(c.id_client || '');

    const tdNom = document.createElement('td');
    tdNom.textContent = nom;

    const tdProj = document.createElement('td');
    tdProj.textContent = proj;

    const tdStat = document.createElement('td');
    const span = document.createElement('span');
    span.className = 'badge-status ' + (
      st === 'en_cours' ? 'en-cours' :
      st === 'termine'  ? 'termine'  : 'attente'
    );
    span.textContent = st ? st.replace('_',' ') : '‚Äî';
    tdStat.appendChild(span);

    tr.appendChild(tdNom);
    tr.appendChild(tdProj);
    tr.appendChild(tdStat);

    // Clic sur la ligne ‚Üí affiche la fiche client
    tr.addEventListener('click', ()=>{
      tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));
      tr.classList.add('selected');

      const id = tr.dataset.clientId;
      const cli = CLIENTS_CACHE.find(x => String(x.id_client || '') === id);
      if(cli) showClientDetails(cli);
    });

    tbody.appendChild(tr);
  });
}

// Affiche la fiche d√©taill√©e √† droite
function showClientDetails(c){
  if(!clientDetails) return;

  const nomComplet = [c.prenom, c.nom].filter(Boolean).join(' ') || 'Client sans nom';
  const statutRaw  = (c.statut || '').toString().trim();
  const statut     = statutRaw || '‚Äî';
  const statutCls  = (
    statutRaw === 'en_cours' ? 'en-cours' :
    statutRaw === 'termine'  ? 'termine'  : 'attente'
  );
  const projet = c.type_projet || '‚Äî';
  const ville  = c.ville || '';
  const cp     = c.code_postal || '';
  const tel    = c.telephone || '';
  const mail   = c.email || '';
  const src    = c.source || '‚Äî';
  const notes  = c.notes_internes || '';
  const dateC  = formatDateHuman(c.date_creation);

  const ligneVille = [cp, ville].filter(Boolean).join(' ');

  clientDetails.innerHTML = `
    <h3>Fiche client</h3>
    <p class="sub">Vue synth√©tique du client et de son projet.</p>

    <div class="client-main">
      <div class="client-name">${nomComplet}</div>
      <div class="client-meta">
        <span class="badge-status ${statutCls}">${statut.replace('_',' ')}</span>
        <span class="tag-project">${projet}</span>
      </div>
    </div>

    <div class="client-cols">
      <div>
        <h4>Coordonn√©es</h4>
        <p>
          ${tel ? `üìû ${tel}<br>` : ''}
          ${mail ? `‚úâÔ∏è ${mail}<br>` : ''}
          ${c.adresse ? `${c.adresse}<br>` : ''}
          ${ligneVille}
        </p>
      </div>
      <div>
        <h4>Projet</h4>
        <p>Type : ${projet}</p>
        <p>Source : ${src}</p>
        <p>Cr√©√© le : ${dateC}</p>
      </div>
    </div>

    ${notes ? `
      <div class="client-notes">
        <h4>Notes internes</h4>
        <p>${notes}</p>
      </div>
    ` : ''}
  `;
}

// Formatage simple d'une date en JJ/MM/AAAA
function formatDateHuman(v){
  if(!v) return '‚Äî';
  try{
    const d = (v instanceof Date) ? v : new Date(v);
    if(isNaN(d)) return String(v);
    return d.toLocaleDateString('fr-FR');
  }catch(e){
    return String(v);
  }
}
// ===== DEVIS =====

// Charge la liste de devis
async function loadDevisList(){
  try{
    const r = await fetch(`${WEB_APP_URL}?path=bo&resource=devis`, {cache:'no-store'});
    const j = await r.json();
    if(!j.ok) return;
    DEVIS_CACHE = j.rows || [];
    applyDevisFiltersAndRender();
  }catch(e){
    console.log('Erreur devis', e);
  }
}

function applyDevisFiltersAndRender(){
  const statusSelect = document.getElementById('filter-devis-status');
  const statut = (statusSelect?.value || '').trim();

  let rows = DEVIS_CACHE.slice();
  if(statut){
    rows = rows.filter(d => String(d.statut || '').trim() === statut);
  }
  renderDevisTable(rows);
}

function renderDevisTable(rows){
  const tbody = document.querySelector('#devis-table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  if(!rows || rows.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 5;
    td.textContent = "Aucun devis trouv√© dans l‚Äôonglet 'devis'.";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(d => {
    const tr = document.createElement('tr');

    const num = d.id_devis || d.numero_devis || d.numero || d.ref || '‚Äî';
    const client =
      d.client ||
      [d.prenom_client, d.nom_client].filter(Boolean).join(' ') ||
      d.client_nom || '‚Äî';

    const brutMontant = d.montant_ht || d.montant || d.total_ht || '';
    let montantAff = '‚Äî';
    if(brutMontant !== '' && brutMontant != null){
      const n = Number(brutMontant);
      montantAff = isNaN(n)
        ? String(brutMontant)
        : n.toLocaleString('fr-FR',{maximumFractionDigits:0})+' ‚Ç¨';
    }

    const statutRaw = (d.statut || '').toString().trim();
    const statutTxt = statutRaw || '‚Äî';
    const statutCls =
      statutRaw === 'brouillon' ? 'attente' :
      statutRaw === 'envoye'   ? 'en-cours' :
      statutRaw === 'accepte'  ? 'success'  :
      statutRaw === 'signe'    ? 'success'  :
      statutRaw === 'refuse'   ? 'danger'   : 'attente';

    const date = d.date_devis || d.date || d.date_creation || '';

    const tdNum = document.createElement('td');
    tdNum.textContent = num;

    const tdClient = document.createElement('td');
    tdClient.textContent = client;

    const tdMontant = document.createElement('td');
    tdMontant.textContent = montantAff;

    const tdStatut = document.createElement('td');
    const span = document.createElement('span');
    span.className = 'badge-status ' + statutCls;
    span.textContent = statutTxt.replace('_',' ');
    tdStatut.appendChild(span);

    const tdDate = document.createElement('td');
    tdDate.textContent = formatDateHuman(date);

    tr.appendChild(tdNum);
    tr.appendChild(tdClient);
    tr.appendChild(tdMontant);
    tr.appendChild(tdStatut);
    tr.appendChild(tdDate);

    tbody.appendChild(tr);
  });
}

// ===== CHANTIERS =====

async function loadChantiersList(){
  try{
    const r = await fetch(`${WEB_APP_URL}?path=bo&resource=chantiers`, {cache:'no-store'});
    const j = await r.json();
    if(!j.ok) return;
    CHANTIERS_CACHE = j.rows || [];
    applyChantiersFiltersAndRender();
  }catch(e){
    console.log('Erreur chantiers', e);
  }
}

function applyChantiersFiltersAndRender(){
  const statusSelect = document.getElementById('filter-chantiers-status');
  const statut = (statusSelect?.value || '').trim();

  let rows = CHANTIERS_CACHE.slice();
  if(statut){
    rows = rows.filter(ch => String(ch.statut || '').trim() === statut);
  }
  renderChantiersTable(rows);
}

function renderChantiersTable(rows){
  const tbody = document.querySelector('#chantiers-table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  if(!rows || rows.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.textContent = "Aucun chantier trouv√© dans l‚Äôonglet 'chantiers'.";
    tr.appendChild(td);
    tbody.appendChild(tr);

    if(chantierDetails){
      chantierDetails.innerHTML = `
        <h3>D√©tail chantier</h3>
        <p class="sub">S√©lectionnez un chantier pour afficher les informations d√©taill√©es.</p>
        <p style="font-size:.8rem;color:var(--text-soft);">
          Informations pr√©vues : type de projet, adresse, planning, responsable, notes, etc.
        </p>
      `;
    }
    return;
  }

  rows.forEach(ch => {
    const tr = document.createElement('tr');

    const id = ch.id_chantier || ch.code_chantier || ch.reference || '‚Äî';
    const client =
      ch.client ||
      [ch.prenom_client, ch.nom_client].filter(Boolean).join(' ') ||
      ch.client_nom || '‚Äî';

    const statutRaw = (ch.statut || '').toString().trim();
    const statutTxt = statutRaw || '‚Äî';
    const statutCls =
      statutRaw === 'en_cours'   ? 'en-cours' :
      statutRaw === 'termine'    ? 'termine'  :
      statutRaw === 'sav'        ? 'danger'   :
      statutRaw === 'en_pause'   ? 'attente'  :
      statutRaw === 'preparation'? 'attente'  : 'attente';

    const finPrevue = ch.date_fin_prevue || ch.date_fin || ch.fin_prevue || '';

    tr.dataset.chantierId = String(id);

    const tdId = document.createElement('td');
    tdId.textContent = id;

    const tdClient = document.createElement('td');
    tdClient.textContent = client;

    const tdStatut = document.createElement('td');
    const span = document.createElement('span');
    span.className = 'badge-status ' + statutCls;
    span.textContent = statutTxt.replace('_',' ');
    tdStatut.appendChild(span);

    const tdFin = document.createElement('td');
    tdFin.textContent = formatDateHuman(finPrevue);

    tr.appendChild(tdId);
    tr.appendChild(tdClient);
    tr.appendChild(tdStatut);
    tr.appendChild(tdFin);

    tr.addEventListener('click', ()=>{
      tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));
      tr.classList.add('selected');
      showChantierDetails(ch);
    });

    tbody.appendChild(tr);
  });
}

function showChantierDetails(ch){
  if(!chantierDetails) return;

  const id = ch.id_chantier || ch.code_chantier || ch.reference || '‚Äî';
  const client =
    ch.client ||
    [ch.prenom_client, ch.nom_client].filter(Boolean).join(' ') ||
    ch.client_nom || '‚Äî';

  const projet   = ch.type_projet || ch.type || '‚Äî';
  const adresse  = ch.adresse || '';
  const ville    = ch.ville || '';
  const cp       = ch.code_postal || '';
  const dateDeb  = ch.date_debut || ch.date_debut_prevue || '';
  const dateFin  = ch.date_fin || ch.date_fin_prevue || '';
  const statut   = (ch.statut || '').toString().trim() || '‚Äî';
  const notes    = ch.notes || ch.notes_internes || '';

  const ligneVille = [cp, ville].filter(Boolean).join(' ');

  chantierDetails.innerHTML = `
    <h3>D√©tail chantier</h3>
    <p class="sub">Vue synth√©tique du chantier et de son avancement.</p>

    <div class="client-main">
      <div class="client-name">${id} ‚Äî ${client}</div>
      <div class="client-meta">
        <span class="tag-project">${projet}</span>
      </div>
    </div>

    <div class="client-cols">
      <div>
        <h4>Localisation</h4>
        <p>
          ${adresse ? `${adresse}<br>` : ''}
          ${ligneVille}
        </p>
      </div>
      <div>
        <h4>Planning</h4>
        <p>D√©but : ${formatDateHuman(dateDeb)}</p>
        <p>Fin pr√©vue : ${formatDateHuman(dateFin)}</p>
        <p>Statut : ${statut.replace('_',' ')}</p>
      </div>
    </div>

    ${notes ? `
      <div class="client-notes">
        <h4>Notes chantier</h4>
        <p>${notes}</p>
      </div>
    ` : ''}
  `;
}


  // Recherche + filtre statut sur les clients
  const searchClientInput  = document.getElementById('search-client');
  const filterClientSelect = document.getElementById('filter-clients-statut');

  if(searchClientInput){
    searchClientInput.addEventListener('input', applyClientFiltersAndRender);
  }
  if(filterClientSelect){
    filterClientSelect.addEventListener('change', applyClientFiltersAndRender);
  }
    // Filtres Devis / Chantiers
  const filterDevisSelect      = document.getElementById('filter-devis-status');
  const filterChantiersSelect  = document.getElementById('filter-chantiers-status');

  if(filterDevisSelect){
    filterDevisSelect.addEventListener('change', applyDevisFiltersAndRender);
  }
  if(filterChantiersSelect){
    filterChantiersSelect.addEventListener('change', applyChantiersFiltersAndRender);
  }

    // ===== Modal "Nouveau client" =====
  const btnNewClient       = document.getElementById('btn-new-client');
  const modalNewClient     = document.getElementById('modal-new-client');
  const formNewClient      = document.getElementById('form-new-client');
  const btnCancelNewClient = document.getElementById('btn-cancel-new-client');
  const newClientError     = document.getElementById('new-client-error');

  function openNewClientModal(){
    if(!modalNewClient) return;
    newClientError.textContent = "";
    formNewClient?.reset();
    modalNewClient.classList.add('show');
  }
  function closeNewClientModal(){
    if(!modalNewClient) return;
    modalNewClient.classList.remove('show');
  }

  if(btnNewClient){
    btnNewClient.addEventListener('click', openNewClientModal);
  }
  if(btnCancelNewClient){
    btnCancelNewClient.addEventListener('click', closeNewClientModal);
  }
  if(modalNewClient){
    // clic sur le fond sombre = fermer
    modalNewClient.addEventListener('click', (e)=>{
      if(e.target === modalNewClient) closeNewClientModal();
    });
  }

  if(formNewClient){
    formNewClient.addEventListener('submit', async (e)=>{
      e.preventDefault();
      newClientError.textContent = "";

      const fd     = new FormData(formNewClient);
      const nom    = (fd.get('nom') || '').toString().trim();
      const prenom = (fd.get('prenom') || '').toString().trim();

      if(!nom && !prenom){
        newClientError.textContent = "Merci de renseigner au moins un nom ou un pr√©nom.";
        return;
      }

      try{
        const params = new URLSearchParams();
        params.append('path','bo');
        params.append('action','create_client');
        for(const [k,v] of fd.entries()){
          params.append(k, v.toString());
        }

        const resp = await fetch(WEB_APP_URL, {
          method:'POST',
          body: params
        });
        const json = await resp.json();
        if(!json.ok){
          console.log('create_client error', json);
          newClientError.textContent = "Erreur lors de l‚Äôenregistrement.";
          return;
        }

        closeNewClientModal();
        await loadClientsList();
      }catch(err){
        console.log('create_client exception', err);
        newClientError.textContent = "Erreur r√©seau, impossible d‚Äôenregistrer.";
       }
    });
  }
      

  // ===== Modal "Nouveau chantier" =====
  const btnNewChantier       = document.getElementById('btn-new-chantier');
  const modalNewChantier     = document.getElementById('modal-new-chantier');
  const formNewChantier      = document.getElementById('form-new-chantier');
  const btnCancelNewChantier = document.getElementById('btn-cancel-new-chantier');
  const newChantierError     = document.getElementById('new-chantier-error');

  function openNewChantierModal(){
    if(!modalNewChantier) return;
    newChantierError.textContent = "";
    formNewChantier?.reset();
    modalNewChantier.classList.add('show');
  }
  function closeNewChantierModal(){
    if(!modalNewChantier) return;
    modalNewChantier.classList.remove('show');
  }

  if(btnNewChantier){
    btnNewChantier.addEventListener('click', openNewChantierModal);
  }
  if(btnCancelNewChantier){
    btnCancelNewChantier.addEventListener('click', closeNewChantierModal);
  }
  if(modalNewChantier){
    modalNewChantier.addEventListener('click', (e)=>{
      if(e.target === modalNewChantier) closeNewChantierModal();
    });
  }

  if(formNewChantier){
    formNewChantier.addEventListener('submit', async (e)=>{
      e.preventDefault();
      newChantierError.textContent = "";

      const fd     = new FormData(formNewChantier);
      const client = (fd.get('client') || '').toString().trim();
      if(!client){
        newChantierError.textContent = "Merci de renseigner au minimum le nom du client.";
        return;
      }

      try{
        const params = new URLSearchParams();
        params.append('path','bo');
        params.append('action','create_chantier');
        for(const [k,v] of fd.entries()){
          params.append(k, v.toString());
        }

        const resp = await fetch(WEB_APP_URL, {
          method:'POST',
          body: params
        });
        const json = await resp.json();
        if(!json.ok){
          console.log('create_chantier error', json);
          newChantierError.textContent = "Erreur lors de l‚Äôenregistrement du chantier.";
          return;
        }

        closeNewChantierModal();
        await loadChantiersList();
      }catch(err){
        console.log('create_chantier exception', err);
        newChantierError.textContent = "Erreur r√©seau, impossible d‚Äôenregistrer le chantier.";
      }
    });
  }


</script>


</body>
</html>
