<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Espace priv√© ‚Äì Papo R√©nov</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1120;
      --bg-alt:#020617;
      --card:#0f172a;
      --card-soft:#111827;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,0.15);
      --accent-strong:#0ea5e9;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --border:#1f2937;
      --danger:#ef4444;
      --warning:#facc15;
      --success:#22c55e;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.75);
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }

    html,body{
      height:100%;
      background:radial-gradient(circle at top left,#1f2937,#020617 55%);
      color:var(--text);
      font-family:"Poppins",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* HEADER */
    header.pr-header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(18px);
      background:linear-gradient(to right,rgba(15,23,42,0.96),rgba(15,23,42,0.88));
      border-bottom:1px solid rgba(148,163,184,0.2);
      box-shadow:0 18px 55px rgba(15,23,42,0.9);
    }

    header.pr-header .inner{
      max-width:1200px;
      margin:0 auto;
      padding:0.75rem 1rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }

    header.pr-header .brand{
      display:flex;
      align-items:center;
      gap:0.75rem;
    }

    header.pr-header .brand-logo{
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:
        radial-gradient(circle at 30% 30%,rgba(248,250,252,0.55),transparent 55%),
        radial-gradient(circle at 70% 80%,rgba(56,189,248,0.45),transparent 60%),
        #020617;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(15,23,42,0.9),0 15px 35px rgba(15,23,42,0.9);
    }

    header.pr-header .brand-logo span{
      font-weight:800;
      font-size:1.35rem;
      letter-spacing:1px;
      color:#e5f4ff;
      text-shadow:0 0 18px rgba(56,189,248,0.9);
    }

    header.pr-header .brand-text h1{
      font-size:1rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:#e5e7eb;
    }

    header.pr-header .brand-text p{
      font-size:0.75rem;
      color:var(--text-soft);
    }

    header.pr-header nav{
      display:flex;
      align-items:center;
      gap:0.35rem;
      font-size:0.75rem;
      color:var(--text-soft);
    }

    header.pr-header nav span.dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:radial-gradient(circle,#22c55e,#166534);
      box-shadow:0 0 0 3px rgba(34,197,94,0.35);
    }

    header.pr-header nav a{
      color:var(--accent);
      text-decoration:none;
      border-radius:999px;
      padding:0.25rem 0.75rem;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(56,189,248,0.35);
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      font-size:0.75rem;
    }

    header.pr-header nav a:hover{
      background:var(--accent-soft);
    }

    /* LAYOUT GLOBAL */
    main{
      flex:1;
      max-width:1200px;
      margin:1.25rem auto 2.5rem auto;
      padding:0 1rem 2rem 1rem;
      width:100%;
    }

    .private-shell{
      display:flex;
      flex-direction:column;
      gap:1.25rem;
    }

    /* CARTE LOGIN */
    #private-login{
      max-width:480px;
      margin:2rem auto 0 auto;
      background:radial-gradient(circle at top,rgba(15,23,42,0.9),rgba(15,23,42,0.96));
      border-radius:var(--radius-lg);
      padding:1.75rem 1.5rem 1.75rem;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }

    #private-login::before{
      content:"";
      position:absolute;
      inset:-40%;
      opacity:0.08;
      background:
        radial-gradient(circle at 0% 0%,#1d4ed8 0,transparent 55%),
        radial-gradient(circle at 100% 100%,#0ea5e9 0,transparent 55%);
      pointer-events:none;
    }

    #private-login h2{
      font-size:1.15rem;
      margin-bottom:0.35rem;
    }

    #private-login p{
      font-size:0.85rem;
      color:var(--text-soft);
      margin-bottom:1rem;
    }

    .login-row{
      display:flex;
      flex-direction:column;
      gap:0.75rem;
    }

    .login-row label{
      font-size:0.8rem;
      color:var(--text-soft);
    }

    .login-row input{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      padding:0.6rem 0.9rem;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.9rem;
      outline:none;
    }

    .login-row input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.25);
    }

    .login-actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:1rem;
      gap:0.75rem;
      flex-wrap:wrap;
    }

    .btn{
      border-radius:999px;
      border:1px solid transparent;
      padding:0.55rem 1.1rem;
      font-size:0.85rem;
      cursor:pointer;
      background:var(--accent);
      color:#0b1120;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      transition:transform 0.08s ease-out,box-shadow 0.08s ease-out,background 0.08s ease-out;
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 32px rgba(8,47,73,0.6);
      background:var(--accent-strong);
    }

    .btn-secondary{
      background:transparent;
      color:var(--text-soft);
      border-color:rgba(148,163,184,0.4);
      box-shadow:none;
    }

    .btn-secondary:hover{
      background:rgba(15,23,42,0.9);
    }

    #private-error{
      margin-top:0.75rem;
      font-size:0.8rem;
      color:var(--danger);
      min-height:1em;
    }

    /* DASHBOARD GLOBAL */
    #private-dashboard{
      display:none;
      background:radial-gradient(circle at top,rgba(15,23,42,0.95),rgba(2,6,23,0.98));
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:var(--shadow-soft);
      padding:1.4rem 1.2rem 1.6rem;
      position:relative;
      overflow:hidden;
      min-height:520px;
    }

    #private-dashboard::before{
      content:"";
      position:absolute;
      inset:-40%;
      opacity:0.25;
      background:
        radial-gradient(circle at 0% 0%,rgba(56,189,248,0.35),transparent 70%),
        radial-gradient(circle at 100% 100%,rgba(59,130,246,0.35),transparent 70%);
      mix-blend-mode:soft-light;
      pointer-events:none;
    }

    #private-dashboard .inner{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns:240px minmax(0,1fr);
      gap:1.2rem;
    }

    /* MENU LATERAL */
    .dash-menu{
      background:linear-gradient(to bottom,rgba(15,23,42,0.98),rgba(15,23,42,0.96));
      border-radius:var(--radius-md);
      border:1px solid rgba(31,41,55,0.95);
      box-shadow:0 18px 38px rgba(15,23,42,0.9);
      padding:0.85rem;
      display:flex;
      flex-direction:column;
      gap:0.55rem;
    }

    .dash-menu-header{
      display:flex;
      flex-direction:column;
      gap:0.15rem;
      margin-bottom:0.4rem;
    }

    .dash-menu-header span.label{
      font-size:0.7rem;
      color:var(--text-soft);
      letter-spacing:0.16em;
      text-transform:uppercase;
    }

    .dash-menu-header span#mini-view-label{
      font-size:0.95rem;
      font-weight:600;
    }

    .dash-menu button{
      border:none;
      border-radius:999px;
      padding:0.48rem 0.85rem;
      font-size:0.8rem;
      color:var(--text-soft);
      background:transparent;
      text-align:left;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.5rem;
      transition:background 0.1s ease-out,color 0.1s ease-out,transform 0.08s ease-out;
    }

    .dash-menu button span.badge{
      border-radius:999px;
      padding:0.08rem 0.45rem;
      font-size:0.7rem;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.85);
      color:var(--text-soft);
    }

    .dash-menu button.active{
      background:linear-gradient(to right,rgba(8,47,73,0.9),rgba(15,23,42,0.98));
      color:#e5f4ff;
      transform:translateY(-1px);
      box-shadow:0 16px 32px rgba(8,47,73,0.8);
      border:1px solid rgba(56,189,248,0.6);
    }

    .dash-menu button.active span.badge{
      border-color:rgba(56,189,248,0.7);
      background:rgba(15,23,42,0.98);
      color:var(--accent);
    }

    .dash-menu-footer{
      border-top:1px dashed rgba(55,65,81,0.9);
      margin-top:0.6rem;
      padding-top:0.45rem;
      display:flex;
      flex-direction:column;
      gap:0.2rem;
      font-size:0.7rem;
      color:var(--text-soft);
    }

    .dash-menu-footer strong{
      color:var(--accent);
      font-weight:500;
    }

    /* PANELS */
    .panels{
      border-radius:var(--radius-md);
      background:radial-gradient(circle at top left,#020617,#020617 40%,#020617);
      border:1px solid rgba(31,41,55,0.9);
      box-shadow:0 18px 45px rgba(15,23,42,0.85);
      padding:0.9rem;
      display:flex;
      flex-direction:column;
      gap:0.9rem;
      min-height:420px;
    }

    .panel{
      display:none;
      flex-direction:column;
      gap:0.75rem;
    }

    .panel.active{
      display:flex;
    }

    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.75rem;
      flex-wrap:wrap;
    }

    .panel-header h2{
      font-size:0.95rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:#e5e7eb;
    }

    .panel-header p{
      font-size:0.8rem;
      color:var(--text-soft);
    }

    .panel-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      align-items:center;
    }

    .chip{
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      padding:0.25rem 0.65rem;
      font-size:0.7rem;
      color:var(--text-soft);
      background:rgba(15,23,42,0.9);
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
    }

    .chip-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:radial-gradient(circle,#22c55e,#166534);
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:0.65rem;
      margin-top:0.35rem;
      margin-bottom:0.2rem;
    }

    .kpi-card{
      background:radial-gradient(circle at top,rgba(15,23,42,0.98),rgba(15,23,42,0.96));
      border-radius:var(--radius-md);
      border:1px solid rgba(31,41,55,0.95);
      padding:0.7rem 0.75rem;
      display:flex;
      flex-direction:column;
      gap:0.25rem;
    }

    .kpi-label{
      font-size:0.7rem;
      color:var(--text-soft);
    }

    .kpi-value{
      font-size:1.15rem;
      font-weight:600;
    }

    .kpi-trend{
      font-size:0.75rem;
      color:var(--success);
    }

    .kpi-trend.negative{
      color:var(--danger);
    }

    .split{
      display:grid;
      grid-template-columns:1.4fr 1fr;
      gap:0.75rem;
      margin-top:0.4rem;
    }

    .card{
      background:rgba(15,23,42,0.96);
      border-radius:var(--radius-md);
      border:1px solid rgba(31,41,55,0.95);
      padding:0.75rem 0.8rem;
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.5rem;
    }

    .card-header h3{
      font-size:0.85rem;
    }

    .card-header span.sub{
      font-size:0.75rem;
      color:var(--text-soft);
    }

    /* TABLES */
    .table-wrapper{
      border-radius:var(--radius-md);
      border:1px solid rgba(31,41,55,0.95);
      overflow:hidden;
      background:rgba(2,6,23,0.98);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.78rem;
    }

    thead{
      background:radial-gradient(circle at top,rgba(15,23,42,0.98),rgba(15,23,42,0.96));
    }

    th,td{
      padding:0.45rem 0.55rem;
      border-bottom:1px solid rgba(31,41,55,0.95);
      text-align:left;
      white-space:nowrap;
    }

    th{
      font-weight:500;
      color:var(--text-soft);
    }

    tbody tr:hover{
      background:rgba(15,23,42,0.92);
      cursor:pointer;
    }

    tbody tr.selected{
      background:rgba(15,23,42,0.98);
    }

    td{
      color:#e5e7eb;
    }

    .badge-status{
      border-radius:999px;
      padding:0.08rem 0.5rem;
      font-size:0.7rem;
      border:1px solid rgba(55,65,81,0.95);
    }

    .badge-status.en-cours{
      border-color:rgba(250,204,21,0.9);
      background:rgba(250,204,21,0.1);
      color:#facc15;
    }

    .badge-status.termine{
      border-color:rgba(34,197,94,0.9);
      background:rgba(34,197,94,0.08);
      color:#22c55e;
    }

    .badge-status.attente{
      border-color:rgba(148,163,184,0.9);
      background:rgba(148,163,184,0.08);
      color:#e5e7eb;
    }

    .client-details,.chantier-details{
      font-size:0.78rem;
      color:var(--text-soft);
    }

    .client-details h3,
    .chantier-details h3{
      font-size:0.9rem;
      margin-bottom:0.3rem;
      color:#e5e7eb;
    }

    .details-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:0.6rem;
    }

    .details-grid h4{
      font-size:0.8rem;
      margin-bottom:0.15rem;
      color:var(--text-soft);
    }

    .details-grid p{
      font-size:0.78rem;
    }

    .client-notes{
      margin-top:0.55rem;
      padding-top:0.5rem;
      border-top:1px dashed rgba(55,65,81,0.9);
      font-size:0.78rem;
    }

    .client-notes strong{
      color:var(--accent);
    }

    .note-item{
      border-radius:var(--radius-md);
      border:1px solid rgba(31,41,55,0.95);
      padding:0.6rem 0.7rem;
      background:rgba(15,23,42,0.97);
      margin-bottom:0.4rem;
      font-size:0.78rem;
    }

    .note-meta{
      display:flex;
      justify-content:space-between;
      gap:0.4rem;
      margin-bottom:0.2rem;
      color:var(--text-soft);
      font-size:0.7rem;
    }

    /* INPUTS / SELECTS */
    select,input[type="text"],input[type="date"],input[type="number"],input[type="email"],input[type="tel"],textarea{
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.95);
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.78rem;
      padding:0.35rem 0.7rem;
      outline:none;
    }

    textarea{
      border-radius:var(--radius-md);
      min-height:80px;
      resize:vertical;
      padding:0.45rem 0.6rem;
    }

    select:focus,
    input:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.28);
    }

    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      align-items:center;
      margin-top:0.4rem;
    }

    .filters-row label{
      font-size:0.75rem;
      color:var(--text-soft);
    }

    /* MODALES */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      backdrop-filter:blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }

    .modal-backdrop.active{
      display:flex;
    }

    .modal{
      width:100%;
      max-width:520px;
      background:radial-gradient(circle at top,rgba(15,23,42,0.98),rgba(15,23,42,0.98));
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.35);
      padding:1.2rem 1rem 1.1rem;
      box-shadow:var(--shadow-soft);
      position:relative;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.6rem;
      gap:0.5rem;
    }

    .modal-header h3{
      font-size:0.9rem;
    }

    .modal-header button{
      border:none;
      background:transparent;
      color:var(--text-soft);
      cursor:pointer;
      font-size:0.85rem;
    }

    .modal-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:0.55rem;
      margin-top:0.5rem;
      margin-bottom:0.6rem;
    }

    .modal-grid label{
      font-size:0.75rem;
      color:var(--text-soft);
      display:block;
      margin-bottom:0.15rem;
    }

    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:0.4rem;
      margin-top:0.5rem;
    }

    .error-text{
      font-size:0.75rem;
      color:var(--danger);
      min-height:1em;
      margin-top:0.2rem;
    }

    /* DOCS & PARTENAIRES LISTES */
    .pill-list{
      display:flex;
      flex-direction:column;
      gap:0.35rem;
      font-size:0.8rem;
    }

    .pill-item{
      border-radius:var(--radius-md);
      border:1px solid rgba(31,41,55,0.95);
      background:rgba(15,23,42,0.97);
      padding:0.5rem 0.6rem;
      display:flex;
      flex-direction:column;
      gap:0.2rem;
    }

    .pill-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.4rem;
    }

    .pill-top a{
      color:var(--accent);
      text-decoration:none;
      font-size:0.78rem;
      word-break:break-all;
    }

    .pill-meta{
      font-size:0.7rem;
      color:var(--text-soft);
      display:flex;
      flex-wrap:wrap;
      gap:0.3rem;
    }

    .tag{
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.95);
      padding:0.05rem 0.45rem;
      font-size:0.7rem;
      color:var(--text-soft);
    }

    /* RESPONSIVE */
    @media(max-width:960px){
      #private-dashboard .inner{
        grid-template-columns:minmax(0,1fr);
      }
      .dash-menu{
        flex-direction:row;
        overflow-x:auto;
        padding:0.6rem;
      }
      .dash-menu-header{
        display:none;
      }
      .dash-menu button{
        min-width:140px;
      }
    }

    @media(max-width:720px){
      main{
        margin-top:0.75rem;
      }
      #private-login{
        margin-top:1.25rem;
        padding:1.4rem 1.25rem;
      }
      .kpi-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
      .split{
        grid-template-columns:1fr;
      }
    }

    @media(max-width:480px){
      .kpi-grid{
        grid-template-columns:1fr 1fr;
      }
      header.pr-header .inner{
        flex-direction:column;
        align-items:flex-start;
      }
    }

  </style>
</head>
<body>
  <header class="pr-header">
    <div class="inner">
      <div class="brand">
        <div class="brand-logo">
          <span>P</span>
        </div>
        <div class="brand-text">
          <h1>Papo R√©nov ¬∑ Espace priv√©</h1>
          <p>Pilote ton activit√© : clients, devis, chantiers & suivi.</p>
        </div>
      </div>
      <nav>
        <span class="dot"></span>
        <span id="mini-view-label">Vue verrouill√©e</span>
        <a href="../index.html">Retour au site</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="private-shell">

      <!-- LOGIN -->
      <section id="private-login">
        <h2>Acc√®s espace priv√©</h2>
        <p>Prot√©g√© par un code interne. Pour un acc√®s direct depuis <strong>acces-admin.html</strong>, on bypass ce code.</p>

        <div class="login-row">
          <label for="private-code">Code interne</label>
          <input type="password" id="private-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <div class="login-actions">
          <button class="btn" id="private-enter">
            <span>Entrer dans le dashboard</span>
          </button>
          <button class="btn btn-secondary" id="btn-test-connexion" type="button">
            Tester la connexion Sheets
          </button>
        </div>

        <div id="private-error"></div>
      </section>

      <!-- DASHBOARD -->
      <section id="private-dashboard">
        <div class="inner">
          <!-- MENU -->
          <aside class="dash-menu">
            <div class="dash-menu-header">
              <span class="label">Espace de pilotage</span>
              <span id="mini-view-label">Vue globale</span>
            </div>

            <button type="button" class="active" data-target="panel-dashboard">
              <span>Tableau de bord</span>
              <span class="badge">Synth√®se</span>
            </button>
            <button type="button" data-target="panel-clients">
              <span>Clients</span>
              <span class="badge" id="badge-clients">0</span>
            </button>
            <button type="button" data-target="panel-devis">
              <span>Devis</span>
              <span class="badge" id="badge-devis">0</span>
            </button>
            <button type="button" data-target="panel-chantiers">
              <span>Chantiers</span>
              <span class="badge" id="badge-chantiers">0</span>
            </button>
            <button type="button" data-target="panel-docs">
              <span>Documents</span>
              <span class="badge" id="badge-docs">0</span>
            </button>
            <button type="button" data-target="panel-notes">
              <span>Notes</span>
              <span class="badge" id="badge-notes">0</span>
            </button>
            <button type="button" data-target="panel-partenaires">
              <span>Partenaires</span>
              <span class="badge" id="badge-partenaires">0</span>
            </button>

            <div class="dash-menu-footer">
              <span>Feuille : <strong>Dashboard / Backoffice</strong></span>
              <span id="status-connexion">Statut : en attente‚Ä¶</span>
            </div>
          </aside>

          <!-- PANELS -->
          <div class="panels">

            <!-- PANEL DASHBOARD -->
            <section id="panel-dashboard" class="panel active">
              <div class="panel-header">
                <div>
                  <h2>Tableau de bord</h2>
                  <p>Vue synth√©tique de ton activit√©.</p>
                </div>
                <div class="panel-toolbar">
                  <div class="chip">
                    <span class="chip-dot"></span>
                    <span>Donn√©es √† jour depuis Google Sheets</span>
                  </div>
                </div>
              </div>

              <div class="kpi-grid">
                <div class="kpi-card">
                  <div class="kpi-label">Chantiers en cours</div>
                  <div class="kpi-value" id="kpi-chantiers-en-cours">0</div>
                  <div class="kpi-trend" id="kpi-chantiers-trend">Charge actuelle</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Devis en attente</div>
                  <div class="kpi-value" id="kpi-devis-attente">0</div>
                  <div class="kpi-trend" id="kpi-devis-trend">Pipeline</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Clients actifs</div>
                  <div class="kpi-value" id="kpi-clients-actifs">0</div>
                  <div class="kpi-trend" id="kpi-clients-trend">Base clients</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Demandes via le site</div>
                  <div class="kpi-value" id="kpi-demandes-site">0</div>
                  <div class="kpi-trend" id="kpi-demandes-trend">Entr√©es</div>
                </div>
              </div>

              <div class="split">
                <div class="card">
                  <div class="card-header">
                    <div>
                      <h3>Flux Devis & Chantiers</h3>
                      <span class="sub">Vue rapide de ce qui bouge.</span>
                    </div>
                  </div>
                  <div id="dashboard-flow" style="font-size:0.78rem;color:var(--text-soft);">
                    Les derniers devis et chantiers appara√Ætront ici sous forme de r√©sum√© (source : onglets
                    <code>devis</code> et <code>chantiers</code>).
                  </div>
                </div>

                <div class="card">
                  <div class="card-header">
                    <div>
                      <h3>Notes √©pingl√©es</h3>
                      <span class="sub">Petit pense-b√™te de gestion.</span>
                    </div>
                  </div>
                  <div id="dashboard-notes" style="font-size:0.78rem;color:var(--text-soft);">
                    Aucune note √©pingl√©e pour l‚Äôinstant. Ajoute des notes dans l‚Äôonglet <strong>Notes</strong>.
                  </div>
                </div>
              </div>
            </section>

            <!-- PANEL CLIENTS -->
            <section id="panel-clients" class="panel">
              <div class="panel-header">
                <div>
                  <h2>Clients</h2>
                  <p>Base clients (source : onglet <code>clients</code>).</p>
                </div>
                <div class="panel-toolbar">
                  <button class="btn btn-secondary" id="btn-new-client">+ Nouveau client</button>
                </div>
              </div>

              <div class="filters-row">
                <label>Recherche :</label>
                <input type="text" id="filter-clients-search" placeholder="Nom, ville, email‚Ä¶">
                <label>Statut :</label>
                <select id="filter-clients-status">
                  <option value="">Tous</option>
                  <option value="prospect">Prospects</option>
                  <option value="client">Clients</option>
                  <option value="archive">Archiv√©s</option>
                </select>
              </div>

              <div class="split">
                <div class="card">
                  <div class="card-header">
                    <h3>Liste des clients</h3>
                    <span class="sub" id="clients-count-label">0 client</span>
                  </div>
                  <div class="table-wrapper">
                    <table id="clients-table">
                      <thead>
                        <tr>
                          <th>Client</th>
                          <th>Projet</th>
                          <th>Statut</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="3">Chargement‚Ä¶</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="card client-details" id="client-details">
                  <h3>D√©tails du client</h3>
                  <p style="font-size:0.78rem;color:var(--text-soft);margin-top:0.35rem;">
                    S√©lectionne un client dans la liste pour afficher sa fiche d√©taill√©e.
                  </p>
                </div>
              </div>
            </section>

            <!-- PANEL DEVIS -->
            <section id="panel-devis" class="panel">
              <div class="panel-header">
                <div>
                  <h2>Devis</h2>
                  <p>Suivi des devis (brouillons, envoy√©s, accept√©s, refus√©s). Source : onglet <code>devis</code>.</p>
                </div>
                <div class="panel-toolbar">
                  <button class="btn btn-secondary" id="btn-new-devis">+ Nouveau devis</button>
                </div>
              </div>

              <div class="filters-row">
                <label>Statut :</label>
                <select id="filter-devis-status">
                  <option value="">Tous</option>
                  <option value="brouillon">Brouillon</option>
                  <option value="envoye">Envoy√©</option>
                  <option value="accepte">Accept√©</option>
                  <option value="refuse">Refus√©</option>
                </select>
                <label>P√©riode :</label>
                <input type="month" id="filter-devis-month">
              </div>

              <div class="card">
                <div class="card-header">
                  <h3>Liste des devis</h3>
                  <span class="sub" id="devis-count-label">0 devis</span>
                </div>
                <div class="table-wrapper">
                  <table id="devis-table">
                    <thead>
                      <tr>
                        <th>N¬∞</th>
                        <th>Client</th>
                        <th>Date</th>
                        <th>Montant</th>
                        <th>Statut</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="5">Chargement‚Ä¶</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- PANEL CHANTIERS -->
            <section id="panel-chantiers" class="panel">
              <div class="panel-header">
                <div>
                  <h2>Chantiers</h2>
                  <p>Suivi des chantiers (planning, statut, reste √† faire). Source : onglet <code>chantiers</code>.</p>
                </div>
                <div class="panel-toolbar">
                  <button class="btn btn-secondary" id="btn-new-chantier">+ Nouveau chantier</button>
                </div>
              </div>

              <div class="filters-row">
                <label>Statut :</label>
                <select id="filter-chantiers-status">
                  <option value="">Tous</option>
                  <option value="en_cours">En cours</option>
                  <option value="termine">Termin√©</option>
                  <option value="pause">En pause</option>
                </select>
                <label>P√©riode :</label>
                <input type="month" id="filter-chantiers-month">
              </div>

              <div class="split">
                <div class="card">
                  <div class="card-header">
                    <h3>Liste des chantiers</h3>
                    <span class="sub" id="chantiers-count-label">0 chantier</span>
                  </div>
                  <div class="table-wrapper">
                    <table id="chantiers-table">
                      <thead>
                        <tr>
                          <th>R√©f.</th>
                          <th>Client</th>
                          <th>Ville</th>
                          <th>Statut</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="4">Chargement‚Ä¶</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="card chantier-details" id="chantier-details">
                  <h3>D√©tails du chantier</h3>
                  <p style="font-size:0.78rem;color:var(--text-soft);margin-top:0.35rem;">
                    S√©lectionne un chantier dans la liste pour afficher les infos d√©taill√©es.
                  </p>
                </div>
              </div>
            </section>

            <!-- PANEL DOCUMENTS -->
            <section id="panel-docs" class="panel">
              <div class="panel-header">
                <div>
                  <h2>Documents</h2>
                  <p>Liens utiles : mod√®les, CGV, grilles de tarifs, etc. Source : onglet <code>documents</code>.</p>
                </div>
                <div class="panel-toolbar">
                  <button class="btn btn-secondary" id="btn-new-doc">+ Nouveau document</button>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3>Liste des documents</h3>
                  <span class="sub" id="docs-count-label">0 document</span>
                </div>
                <div class="pill-list" id="docs-list">
                  <div style="font-size:0.78rem;color:var(--text-soft);">
                    Aucun document enregistr√© pour l‚Äôinstant.
                  </div>
                </div>
              </div>
            </section>

            <!-- PANEL NOTES -->
            <section id="panel-notes" class="panel">
              <div class="panel-header">
                <div>
                  <h2>Notes</h2>
                  <p>Notes de gestion, id√©es, points √† suivre. Source : onglet <code>notes</code>.</p>
                </div>
                <div class="panel-toolbar">
                  <button class="btn btn-secondary" id="btn-new-note">+ Nouvelle note</button>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3>Liste des notes</h3>
                  <span class="sub" id="notes-count-label">0 note</span>
                </div>
                <div id="notes-list">
                  <p style="font-size:0.78rem;color:var(--text-soft);">
                    Aucune note pour l‚Äôinstant. Ajoute ta premi√®re note en cliquant sur ‚ÄúNouvelle note‚Äù.
                  </p>
                </div>
              </div>
            </section>

            <!-- PANEL PARTENAIRES -->
            <section id="panel-partenaires" class="panel">
              <div class="panel-header">
                <div>
                  <h2>Partenaires</h2>
                  <p>R√©seau d‚Äôartisans, cuisinistes, fournisseurs. Source : onglet <code>partenaires</code>.</p>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3>Liste des partenaires</h3>
                  <span class="sub" id="partenaires-count-label">0 partenaire</span>
                </div>
                <div class="pill-list" id="partenaires-list">
                  <div style="font-size:0.78rem;color:var(--text-soft);">
                    Aucun partenaire enregistr√© pour l‚Äôinstant.
                  </div>
                </div>
              </div>
            </section>

          </div> <!-- /panels -->
        </div> <!-- /inner -->
      </section>
    </div>
  </main>

  <!-- MODAL NOUVEAU CLIENT -->
  <div class="modal-backdrop" id="modal-new-client">
    <div class="modal">
      <div class="modal-header">
        <h3>Nouveau client</h3>
        <button type="button" id="btn-close-new-client">‚úï</button>
      </div>
      <form id="form-new-client" autocomplete="off">
        <div class="modal-grid">
          <div>
            <label for="nc-prenom">Pr√©nom</label>
            <input id="nc-prenom" name="prenom" type="text">
          </div>
          <div>
            <label for="nc-nom">Nom</label>
            <input id="nc-nom" name="nom" type="text">
          </div>
          <div>
            <label for="nc-telephone">T√©l√©phone</label>
            <input id="nc-telephone" name="telephone" type="tel">
          </div>
          <div>
            <label for="nc-email">Email</label>
            <input id="nc-email" name="email" type="email">
          </div>
          <div>
            <label for="nc-ville">Ville</label>
            <input id="nc-ville" name="ville" type="text">
          </div>
          <div>
            <label for="nc-cp">Code postal</label>
            <input id="nc-cp" name="code_postal" type="text">
          </div>
          <div>
            <label for="nc-type">Type de projet</label>
            <select id="nc-type" name="type_projet">
              <option value="">‚Äî</option>
              <option value="cuisine">Cuisine</option>
              <option value="salle_de_bain">Salle de bain</option>
              <option value="dressing">Dressing</option>
              <option value="rangements">Rangements</option>
              <option value="autre">Autre</option>
            </select>
          </div>
          <div>
            <label for="nc-source">Source</label>
            <select id="nc-source" name="source">
              <option value="">‚Äî</option>
              <option value="site_web">Site web</option>
              <option value="recommandation">Recommandation</option>
              <option value="reseaux">R√©seaux sociaux</option>
              <option value="showroom">Showroom / partenaire</option>
            </select>
          </div>
        </div>

        <label for="nc-notes" style="font-size:0.75rem;color:var(--text-soft);margin-bottom:0.15rem;display:block;">Notes internes</label>
        <textarea id="nc-notes" name="notes"></textarea>

        <div class="error-text" id="new-client-error"></div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="btn-cancel-new-client">Annuler</button>
          <button type="submit" class="btn">Enregistrer le client</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL NOUVEAU DEVIS -->
  <div class="modal-backdrop" id="modal-new-devis">
    <div class="modal">
      <div class="modal-header">
        <h3>Nouveau devis</h3>
        <button type="button" id="btn-close-new-devis">‚úï</button>
      </div>
      <form id="form-new-devis" autocomplete="off">
        <div class="modal-grid">
          <div>
            <label for="nd-client">Client (nom)</label>
            <input id="nd-client" name="client" type="text">
          </div>
          <div>
            <label for="nd-date">Date</label>
            <input id="nd-date" name="date_devis" type="date">
          </div>
          <div>
            <label for="nd-montant">Montant TTC</label>
            <input id="nd-montant" name="montant_ttc" type="number" step="0.01">
          </div>
          <div>
            <label for="nd-statut">Statut</label>
            <select id="nd-statut" name="statut">
              <option value="brouillon">Brouillon</option>
              <option value="envoye">Envoy√©</option>
              <option value="accepte">Accept√©</option>
              <option value="refuse">Refus√©</option>
            </select>
          </div>
        </div>

        <label for="nd-objet" style="font-size:0.75rem;color:var(--text-soft);margin-bottom:0.15rem;display:block;">Objet / description</label>
        <textarea id="nd-objet" name="objet"></textarea>

        <div class="error-text" id="new-devis-error"></div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="btn-cancel-new-devis">Annuler</button>
          <button type="submit" class="btn">Enregistrer le devis</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL NOUVEAU CHANTIER -->
  <div class="modal-backdrop" id="modal-new-chantier">
    <div class="modal">
      <div class="modal-header">
        <h3>Nouveau chantier</h3>
        <button type="button" id="btn-close-new-chantier">‚úï</button>
      </div>
      <form id="form-new-chantier" autocomplete="off">
        <div class="modal-grid">
          <div>
            <label for="nc-ref">R√©f√©rence chantier</label>
            <input id="nc-ref" name="ref_chantier" type="text">
          </div>
          <div>
            <label for="nc-client">Client</label>
            <input id="nc-client" name="client" type="text">
          </div>
          <div>
            <label for="nc-ville-ch">Ville</label>
            <input id="nc-ville-ch" name="ville" type="text">
          </div>
          <div>
            <label for="nc-statut-ch">Statut</label>
            <select id="nc-statut-ch" name="statut">
              <option value="en_cours">En cours</option>
              <option value="termine">Termin√©</option>
              <option value="pause">En pause</option>
            </select>
          </div>
          <div>
            <label for="nc-debut">D√©but</label>
            <input id="nc-debut" name="date_debut" type="date">
          </div>
          <div>
            <label for="nc-fin">Fin pr√©vue</label>
            <input id="nc-fin" name="date_fin_prevue" type="date">
          </div>
        </div>

        <label for="nc-notes-ch" style="font-size:0.75rem;color:var(--text-soft);margin-bottom:0.15rem;display:block;">Notes chantier</label>
        <textarea id="nc-notes-ch" name="notes"></textarea>

        <div class="error-text" id="new-chantier-error"></div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="btn-cancel-new-chantier">Annuler</button>
          <button type="submit" class="btn">Enregistrer le chantier</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL NOUVEAU DOCUMENT -->
  <div class="modal-backdrop" id="modal-new-doc">
    <div class="modal">
      <div class="modal-header">
        <h3>Nouveau document</h3>
        <button type="button" id="btn-close-new-doc">‚úï</button>
      </div>
      <form id="form-new-doc" autocomplete="off">
        <div class="modal-grid">
          <div>
            <label for="ndoc-cat">Cat√©gorie</label>
            <input id="ndoc-cat" name="categorie" type="text" placeholder="Tarifs, CGV, mod√®le devis‚Ä¶">
          </div>
          <div>
            <label for="ndoc-libelle">Libell√©</label>
            <input id="ndoc-libelle" name="libelle" type="text">
          </div>
          <div style="grid-column:1/3;">
            <label for="ndoc-lien">Lien (Drive, PDF‚Ä¶)</label>
            <input id="ndoc-lien" name="lien" type="text">
          </div>
        </div>

        <label for="ndoc-comment" style="font-size:0.75rem;color:var(--text-soft);margin-bottom:0.15rem;display:block;">Commentaire</label>
        <textarea id="ndoc-comment" name="commentaire"></textarea>

        <div class="error-text" id="new-doc-error"></div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="btn-cancel-new-doc">Annuler</button>
          <button type="submit" class="btn">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL NOUVELLE NOTE -->
  <div class="modal-backdrop" id="modal-new-note">
    <div class="modal">
      <div class="modal-header">
        <h3>Nouvelle note</h3>
        <button type="button" id="btn-close-new-note">‚úï</button>
      </div>
      <form id="form-new-note" autocomplete="off">
        <div class="modal-grid">
          <div style="grid-column:1/2;">
            <label for="nn-titre">Titre</label>
            <input id="nn-titre" name="titre" type="text">
          </div>
          <div style="grid-column:2/3;">
            <label for="nn-tag">Tag</label>
            <input id="nn-tag" name="tag" type="text" placeholder="Urgent, Id√©e, √Ä suivre‚Ä¶">
          </div>
        </div>

        <label for="nn-contenu" style="font-size:0.75rem;color:var(--text-soft);margin-bottom:0.15rem;display:block;">Contenu</label>
        <textarea id="nn-contenu" name="contenu"></textarea>

        <div class="error-text" id="new-note-error"></div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="btn-cancel-new-note">Annuler</button>
          <button type="submit" class="btn">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG BACKOFFICE
    // =========================
    // üëâ Mets ici l‚ÄôURL de TA WebApp (d√©ploiement Apps Script)
    const WEB_APP_URL =
      "https://script.google.com/macros/s/TON_DEPLOIEMENT_WEBAPP/exec";

    const PRIVATE_CODE = "fang"; // change-le si tu veux

    const loginSection    = document.getElementById('private-login');
    const dashboard       = document.getElementById('private-dashboard');
    const inputPrivate    = document.getElementById('private-code');
    const btnPrivateEnter = document.getElementById('private-enter');
    const privateError    = document.getElementById('private-error');
    const statusConnexion = document.getElementById('status-connexion');

    const clientDetails   = document.getElementById('client-details');
    const chantierDetails = document.getElementById('chantier-details');

    let CLIENTS_CACHE   = [];
    let DEVIS_CACHE     = [];
    let CHANTIERS_CACHE = [];
    let NOTES_CACHE     = [];
    let DOCS_CACHE      = [];
    let PARTENAIRES_CACHE = [];

    // Auth admin depuis acces-admin.html
    const isAdminAuth = (localStorage.getItem("admin_auth") === "true");
    if(isAdminAuth){
      loginSection.style.display = 'none';
      dashboard.style.display = 'block';
      const mini = document.getElementById('mini-view-label');
      if(mini) mini.textContent = "Vue globale";

      if(typeof loadDashboardKpis === "function") loadDashboardKpis();
      if(typeof loadClientsList === "function")   loadClientsList();
      if(typeof loadDevisList === "function")     loadDevisList();
      if(typeof loadChantiersList === "function") loadChantiersList();
      if(typeof loadDocsList === "function")      loadDocsList();
      if(typeof loadNotesList === "function")     loadNotesList();
      if(typeof loadPartenairesList === "function") loadPartenairesList();
    }

    // =========================
    // LOGIN INTERNE
    // =========================
    if(btnPrivateEnter){
      btnPrivateEnter.addEventListener('click', async ()=>{
        const value = (inputPrivate.value || "").trim();
        if(!value){
          privateError.textContent = "Merci de saisir le code.";
          return;
        }
        if(value !== PRIVATE_CODE){
          privateError.textContent = "Code incorrect.";
          return;
        }
        privateError.textContent = "";
        loginSection.style.display = 'none';
        dashboard.style.display = 'block';
        const mini = document.getElementById('mini-view-label');
        if(mini) mini.textContent = "Vue globale";

        await Promise.all([
          loadDashboardKpis(),
          loadClientsList(),
          loadDevisList(),
          loadChantiersList(),
          loadDocsList(),
          loadNotesList(),
          loadPartenairesList()
        ]);
      });
    }

    // =========================
    // NAVIGATION PANELS
    // =========================
    const menuButtons = document.querySelectorAll('.dash-menu button');
    const panels = document.querySelectorAll('.panel');

    menuButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const targetId = btn.dataset.target;
        if(!targetId) return;

        menuButtons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');

        panels.forEach(p=>{
          if(p.id === targetId) p.classList.add('active');
          else p.classList.remove('active');
        });
      });
    });

    // =========================
    // FONCTION UTILITAIRE FETCH
    // =========================
    async function fetchJson(url, options){
      try{
        const r = await fetch(url, options || {});
        const j = await r.json();
        return j;
      }catch(err){
        console.error("Erreur fetchJson", err);
        return { ok:false, error:"Exception r√©seau" };
      }
    }

    function formatDateFr(d){
      if(!d) return "";
      try{
        return new Date(d).toLocaleDateString("fr-FR");
      }catch(e){
        return d;
      }
    }

    function formatEuro(v){
      const n = Number(v||0);
      if(Number.isNaN(n)) return v || "";
      return n.toLocaleString("fr-FR",{style:"currency",currency:"EUR"});
    }

    // =========================
    // DASHBOARD KPIs
    // =========================
    async function loadDashboardKpis(){
      const j = await fetchJson(`${WEB_APP_URL}?path=bo&resource=dashboard`, {cache:'no-store'});
      if(!j.ok || !j.data || !j.data.kpi) return;
      const k = j.data.kpi;

      const elChantiers = document.getElementById('kpi-chantiers-en-cours');
      const elDevis     = document.getElementById('kpi-devis-attente');
      const elClients   = document.getElementById('kpi-clients-actifs');
      const elDemandes  = document.getElementById('kpi-demandes-site');

      if(elChantiers) elChantiers.textContent = k.chantiersEnCours ?? 0;
      if(elDevis)     elDevis.textContent     = k.devisAttente ?? 0;
      if(elClients)   elClients.textContent   = k.clientsActifs ?? 0;
      if(elDemandes)  elDemandes.textContent  = k.demandesSite ?? 0;

      const badgeClients      = document.getElementById('badge-clients');
      const badgeDevis        = document.getElementById('badge-devis');
      const badgeChantiers    = document.getElementById('badge-chantiers');
      const badgeDocs         = document.getElementById('badge-docs');
      const badgeNotes        = document.getElementById('badge-notes');
      const badgePartenaires  = document.getElementById('badge-partenaires');

      if(badgeClients)     badgeClients.textContent    = k.clientsActifs ?? 0;
      if(badgeDevis)       badgeDevis.textContent      = k.nbDevis ?? (k.devisAttente ?? 0);
      if(badgeChantiers)   badgeChantiers.textContent  = k.nbChantiers ?? (k.chantiersEnCours ?? 0);
      if(badgeDocs)        badgeDocs.textContent       = k.nbDocs ?? 0;
      if(badgeNotes)       badgeNotes.textContent      = k.nbNotes ?? 0;
      if(badgePartenaires) badgePartenaires.textContent= k.nbPartenaires ?? 0;

      const flowEl  = document.getElementById('dashboard-flow');
      const notesEl = document.getElementById('dashboard-notes');

      if(j.data.flow && flowEl){
        flowEl.innerHTML = j.data.flow;
      }
      if(j.data.notesHtml && notesEl){
        notesEl.innerHTML = j.data.notesHtml;
      }
    }

    // =========================
    // CLIENTS
    // =========================
    async function loadClientsList(){
      const j = await fetchJson(`${WEB_APP_URL}?path=bo&resource=clients`, {cache:'no-store'});
      if(!j.ok) return;
      CLIENTS_CACHE = Array.isArray(j.data) ? j.data : [];
      renderClientsTable(CLIENTS_CACHE);
    }

    function renderClientsTable(rows){
      const tbody = document.querySelector('#clients-table tbody');
      const label = document.getElementById('clients-count-label');
      if(!tbody) return;
      tbody.innerHTML = '';

      if(!rows || rows.length === 0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = "Aucun client trouv√©.";
        tr.appendChild(td);
        tbody.appendChild(tr);

        if(clientDetails){
          clientDetails.innerHTML = `
            <h3>D√©tails du client</h3>
            <p style="margin-top:0.35rem;font-size:0.78rem;color:var(--text-soft);">
              Aucun client s√©lectionn√©.
            </p>
          `;
        }
        if(label) label.textContent = "0 client";
        return;
      }

      if(label) label.textContent = rows.length + (rows.length>1 ? " clients" : " client");

      rows.forEach(c=>{
        const tr   = document.createElement('tr');
        const nom  = [c.prenom, c.nom].filter(Boolean).join(' ') || '‚Äî';
        const proj = c.type_projet || '‚Äî';
        const st   = (c.statut || '').toString().trim() || '‚Äî';

        tr.dataset.clientId = String(c.id_client || '');

        const tdNom = document.createElement('td');
        tdNom.textContent = nom;

        const tdProj = document.createElement('td');
        tdProj.textContent = proj;

        const tdStat = document.createElement('td');
        const span = document.createElement('span');
        span.className = 'badge-status ' + (
          st === 'en_cours' ? 'en-cours' :
          st === 'termine'  ? 'termine'  : 'attente'
        );
        span.textContent = st || '‚Äî';
        tdStat.appendChild(span);

        tr.appendChild(tdNom);
        tr.appendChild(tdProj);
        tr.appendChild(tdStat);

        tr.addEventListener('click', ()=>{
          tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));
          tr.classList.add('selected');

          const id = tr.dataset.clientId;
          const cli = CLIENTS_CACHE.find(x => String(x.id_client || '') === id);
          if(cli) showClientDetails(cli);
        });

        tbody.appendChild(tr);
      });
    }

    function showClientDetails(c){
      if(!clientDetails) return;

      const nomComplet = [c.prenom, c.nom].filter(Boolean).join(' ') || 'Client sans nom';
      const statutRaw  = (c.statut || '').toString().trim();
      const statut     = statutRaw || '‚Äî';
      const statutCls  = (
        statutRaw === 'en_cours' ? 'en-cours' :
        statutRaw === 'termine'  ? 'termine'  : 'attente'
      );
      const projet = c.type_projet || '‚Äî';
      const ville  = c.ville || '';
      const cp     = c.code_postal || '';
      const tel    = c.telephone || '';
      const mail   = c.email || '';
      const src    = c.source || '‚Äî';
      const notes  = c.notes || '';
      const dateC  = c.date_creation ? formatDateFr(c.date_creation) : '';

      let ligneVille = "";
      if(ville || cp){
        ligneVille = [cp, ville].filter(Boolean).join(" ");
      }

      clientDetails.innerHTML = `
        <h3>${nomComplet}</h3>
        <div class="details-grid" style="margin-top:0.4rem;">
          <div>
            <h4>Coordonn√©es</h4>
            <p>
              ${tel ? `üìû ${tel}<br>` : ''}
              ${mail ? `‚úâÔ∏è <a href="mailto:${mail}" style="color:var(--accent);text-decoration:none;">${mail}</a><br>` : ''}
              ${c.adresse ? `${c.adresse}<br>` : ''}
              ${ligneVille}
            </p>
          </div>
          <div>
            <h4>Projet</h4>
            <p>Type : ${projet}</p>
            <p>Source : ${src}</p>
            <p>Cr√©√© le : ${dateC}</p>
          </div>
        </div>

        ${notes ? `
          <div class="client-notes">
            <strong>Notes :</strong><br>
            ${notes.replace(/\n/g,'<br>')}
          </div>
        ` : ''}
      `;
    }

    // Filtres clients
    const inputSearchClients = document.getElementById('filter-clients-search');
    const selectStatutClients = document.getElementById('filter-clients-status');

    function applyClientsFilters(){
      let rows = CLIENTS_CACHE.slice();
      const search = (inputSearchClients?.value || '').toLowerCase();
      const statut = (selectStatutClients?.value || '').toLowerCase();

      if(search){
        rows = rows.filter(c=>{
          const bloc = [
            c.nom, c.prenom, c.email, c.telephone,
            c.ville, c.type_projet
          ].map(x => (x || '').toString().toLowerCase()).join(' ');
          return bloc.includes(search);
        });
      }

      if(statut){
        rows = rows.filter(c => String(c.statut || '').toLowerCase() === statut);
      }

      renderClientsTable(rows);
    }

    if(inputSearchClients){
      inputSearchClients.addEventListener('input', applyClientsFilters);
    }
    if(selectStatutClients){
      selectStatutClients.addEventListener('change', applyClientsFilters);
    }

    // Modal "Nouveau client"
    const btnNewClient       = document.getElementById('btn-new-client');
    const modalNewClient     = document.getElementById('modal-new-client');
    const btnCloseNewClient  = document.getElementById('btn-close-new-client');
    const btnCancelNewClient = document.getElementById('btn-cancel-new-client');
    const formNewClient      = document.getElementById('form-new-client');
    const newClientError     = document.getElementById('new-client-error');

    function openNewClientModal(){
      if(modalNewClient) modalNewClient.classList.add('active');
      if(newClientError) newClientError.textContent = "";
      if(formNewClient) formNewClient.reset();
    }
    function closeNewClientModal(){
      if(modalNewClient) modalNewClient.classList.remove('active');
    }

    if(btnNewClient){
      btnNewClient.addEventListener('click', openNewClientModal);
    }
    if(btnCloseNewClient){
      btnCloseNewClient.addEventListener('click', closeNewClientModal);
    }
    if(btnCancelNewClient){
      btnCancelNewClient.addEventListener('click', closeNewClientModal);
    }
    if(formNewClient){
      formNewClient.addEventListener('submit', async (e)=>{
        e.preventDefault();
        newClientError.textContent = "";

        const fd     = new FormData(formNewClient);
        const nom    = (fd.get('nom') || '').toString().trim();
        const prenom = (fd.get('prenom') || '').toString().trim();

        if(!nom && !prenom){
          newClientError.textContent = "Merci de renseigner au moins un nom ou un pr√©nom.";
          return;
        }

        try{
          const params = new URLSearchParams();
          params.append('path','bo');
          params.append('action','create_client');
          for(const [k,v] of fd.entries()){
            params.append(k, v.toString());
          }

          const resp = await fetch(WEB_APP_URL, {
            method:'POST',
            body: params
          });
          const json = await resp.json();
          if(!json.ok){
            console.log('create_client error', json);
            newClientError.textContent = "Erreur lors de l‚Äôenregistrement.";
            return;
          }

          closeNewClientModal();
          await loadClientsList();
        }catch(err){
          console.log('create_client exception', err);
          newClientError.textContent = "Erreur r√©seau, impossible d‚Äôenregistrer.";
        }
      });
    }

    // =========================
    // DEVIS
    // =========================
    async function loadDevisList(){
      const j = await fetchJson(`${WEB_APP_URL}?path=bo&resource=devis`, {cache:'no-store'});
      if(!j.ok){
        console.log("Erreur loadDevisList", j.error);
        return;
      }
      DEVIS_CACHE = Array.isArray(j.data) ? j.data : [];
      renderDevisTable(DEVIS_CACHE);
    }

    function renderDevisTable(rows){
      const tbody = document.querySelector('#devis-table tbody');
      const label = document.getElementById('devis-count-label');
      if(!tbody) return;
      tbody.innerHTML = '';

      if(!rows || rows.length === 0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = "Aucun devis trouv√©.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        if(label) label.textContent = "0 devis";
        return;
      }

      if(label) label.textContent = rows.length + (rows.length>1 ? " devis" : " devis");

      rows.forEach(d=>{
        const tr      = document.createElement('tr');
        const num     = d.numero || d.id_devis || '‚Äî';
        const client  = d.client || d.nom_client || '‚Äî';
        const date    = d.date_devis ? formatDateFr(d.date_devis) : '‚Äî';
        const montant = d.montant_ttc ? formatEuro(d.montant_ttc) : '‚Äî';
        const statut  = (d.statut || '').toString().trim() || '‚Äî';

        const tdNum = document.createElement('td');
        tdNum.textContent = num;

        const tdCli = document.createElement('td');
        tdCli.textContent = client;

        const tdDate = document.createElement('td');
        tdDate.textContent = date;

        const tdMontant = document.createElement('td');
        tdMontant.textContent = montant;

        const tdStat = document.createElement('td');
        const span = document.createElement('span');
        span.className = 'badge-status ' + (
          statut === 'accepte' ? 'termine' :
          statut === 'envoye'  ? 'en-cours' :
          statut === 'brouillon' ? 'attente' : 'attente'
        );
        span.textContent = statut || '‚Äî';
        tdStat.appendChild(span);

        tr.appendChild(tdNum);
        tr.appendChild(tdCli);
        tr.appendChild(tdDate);
        tr.appendChild(tdMontant);
        tr.appendChild(tdStat);

        tbody.appendChild(tr);
      });
    }

    const selectDevisStatus = document.getElementById('filter-devis-status');
    const inputDevisMonth   = document.getElementById('filter-devis-month');

    function applyDevisFilters(){
      let rows = DEVIS_CACHE.slice();
      const statut = (selectDevisStatus?.value || '').toLowerCase();
      const mois   = (inputDevisMonth?.value || '').trim(); // yyyy-mm

      if(statut){
        rows = rows.filter(d => String(d.statut || '').toLowerCase() === statut);
      }
      if(mois){
        rows = rows.filter(d=>{
          if(!d.date_devis) return false;
          try{
            const dte = new Date(d.date_devis);
            const y = dte.getFullYear();
            const m = String(dte.getMonth()+1).padStart(2,'0');
            return `${y}-${m}` === mois;
          }catch(e){
            return false;
          }
        });
      }

      renderDevisTable(rows);
    }

    if(selectDevisStatus){
      selectDevisStatus.addEventListener('change', applyDevisFilters);
    }
    if(inputDevisMonth){
      inputDevisMonth.addEventListener('change', applyDevisFilters);
    }

    // Modal "Nouveau devis"
    const btnNewDevis       = document.getElementById('btn-new-devis');
    const modalNewDevis     = document.getElementById('modal-new-devis');
    const formNewDevis      = document.getElementById('form-new-devis');
    const btnCancelNewDevis = document.getElementById('btn-cancel-new-devis');
    const btnCloseNewDevis  = document.getElementById('btn-close-new-devis');
    const newDevisError     = document.getElementById('new-devis-error');

    function openNewDevisModal(){
      if(modalNewDevis) modalNewDevis.classList.add('active');
      if(newDevisError) newDevisError.textContent = "";
      if(formNewDevis) formNewDevis.reset();
    }
    function closeNewDevisModal(){
      if(modalNewDevis) modalNewDevis.classList.remove('active');
    }

    if(btnNewDevis){
      btnNewDevis.addEventListener('click', openNewDevisModal);
    }
    if(btnCancelNewDevis){
      btnCancelNewDevis.addEventListener('click', closeNewDevisModal);
    }
    if(btnCloseNewDevis){
      btnCloseNewDevis.addEventListener('click', closeNewDevisModal);
    }

    if(formNewDevis){
      formNewDevis.addEventListener('submit', async (e)=>{
        e.preventDefault();
        newDevisError.textContent = "";

        const fd = new FormData(formNewDevis);
        const client = (fd.get('client') || '').toString().trim();
        if(!client){
          newDevisError.textContent = "Merci d‚Äôindiquer au moins le nom du client.";
          return;
        }

        try{
          const params = new URLSearchParams();
          params.append('path','bo');
          params.append('action','create_devis');
          for(const [k,v] of fd.entries()){
            params.append(k, v.toString());
          }

          const resp = await fetch(WEB_APP_URL, {
            method:'POST',
            body: params
          });
          const json = await resp.json();
          if(!json.ok){
            console.log('create_devis error', json);
            newDevisError.textContent = "Erreur lors de l‚Äôenregistrement.";
            return;
          }

          closeNewDevisModal();
          await loadDevisList();
          await loadDashboardKpis();
        }catch(err){
          console.log('create_devis exception', err);
          newDevisError.textContent = "Erreur r√©seau, impossible d‚Äôenregistrer.";
        }
      });
    }

    // =========================
    // CHANTIERS
    // =========================
    async function loadChantiersList(){
      const j = await fetchJson(`${WEB_APP_URL}?path=bo&resource=chantiers`, {cache:'no-store'});
      if(!j.ok){
        console.log("Erreur loadChantiersList", j.error);
        return;
      }
      CHANTIERS_CACHE = Array.isArray(j.data) ? j.data : [];
      renderChantiersTable(CHANTIERS_CACHE);
    }

    function renderChantiersTable(rows){
      const tbody = document.querySelector('#chantiers-table tbody');
      const label = document.getElementById('chantiers-count-label');
      if(!tbody) return;
      tbody.innerHTML = '';

      if(!rows || rows.length === 0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.textContent = "Aucun chantier trouv√©.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        if(label) label.textContent = "0 chantier";
        return;
      }

      if(label) label.textContent = rows.length + (rows.length>1 ? " chantiers" : " chantier");

      rows.forEach(ch=>{
        const tr     = document.createElement('tr');
        const ref    = ch.ref_chantier || ch.id_chantier || '‚Äî';
        const client = ch.client || '‚Äî';
        const ville  = ch.ville || '‚Äî';
        const statut = (ch.statut || '').toString().trim() || '‚Äî';

        tr.dataset.chantierRef = String(ref);

        const tdRef = document.createElement('td');
        tdRef.textContent = ref;

        const tdCli = document.createElement('td');
        tdCli.textContent = client;

        const tdVille = document.createElement('td');
        tdVille.textContent = ville;

        const tdStat = document.createElement('td');
        const span   = document.createElement('span');
        span.className = 'badge-status ' + (
          statut === 'en_cours' ? 'en-cours' :
          statut === 'termine'  ? 'termine'  : 'attente'
        );
        span.textContent = statut || '‚Äî';
        tdStat.appendChild(span);

        tr.appendChild(tdRef);
        tr.appendChild(tdCli);
        tr.appendChild(tdVille);
        tr.appendChild(tdStat);

        tr.addEventListener('click', ()=>{
          tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));
          tr.classList.add('selected');

          const refClick = tr.dataset.chantierRef;
          const c = CHANTIERS_CACHE.find(x =>
            String(x.ref_chantier || x.id_chantier || '') === refClick
          );
          if(c) showChantierDetails(c);
        });

        tbody.appendChild(tr);
      });
    }

    function showChantierDetails(c){
      if(!chantierDetails) return;

      const ref    = c.ref_chantier || c.id_chantier || '‚Äî';
      const client = c.client || '‚Äî';
      const ville  = c.ville || '';
      const statutRaw = (c.statut || '').toString().trim();
      const statut    = statutRaw || '‚Äî';
      const statutCls  = (
        statutRaw === 'en_cours' ? 'en-cours' :
        statutRaw === 'termine'  ? 'termine'  : 'attente'
      );
      const dateDebut = c.date_debut ? formatDateFr(c.date_debut) : '‚Äî';
      const dateFin   = c.date_fin_prevue ? formatDateFr(c.date_fin_prevue) : '‚Äî';
      const notes     = c.notes || '';

      chantierDetails.innerHTML = `
        <h3>${client} ‚Äì ${ref}</h3>
        <div class="details-grid" style="margin-top:0.4rem;">
          <div>
            <h4>Chantier</h4>
            <p>
              R√©f√©rence : ${ref}<br>
              Ville : ${ville || '‚Äî'}<br>
              Statut :
              <span class="badge-status ${statutCls}">
                ${statut}
              </span><br>
              D√©but : ${dateDebut}<br>
              Fin pr√©vue : ${dateFin}
            </p>
          </div>
          <div>
            <h4>Notes chantier</h4>
            <p>${notes ? notes.replace(/\n/g,'<br>') : '‚Äî'}</p>
          </div>
        </div>
      `;
    }

    const selectChStatus = document.getElementById('filter-chantiers-status');
    const inputChMonth   = document.getElementById('filter-chantiers-month');

    function applyChantiersFilters(){
      let rows = CHANTIERS_CACHE.slice();
      const statut = (selectChStatus?.value || '').toLowerCase();
      const mois   = (inputChMonth?.value || '').trim();

      if(statut){
        rows = rows.filter(ch => String(ch.statut || '').toLowerCase() === statut);
      }
      if(mois){
        rows = rows.filter(ch=>{
          if(!ch.date_debut) return false;
          try{
            const dte = new Date(ch.date_debut);
            const y = dte.getFullYear();
            const m = String(dte.getMonth()+1).padStart(2,'0');
            return `${y}-${m}` === mois;
          }catch(e){
            return false;
          }
        });
      }

      renderChantiersTable(rows);
    }

    if(selectChStatus){
      selectChStatus.addEventListener('change', applyChantiersFilters);
    }
    if(inputChMonth){
      inputChMonth.addEventListener('change', applyChantiersFilters);
    }

    // Modal "Nouveau chantier"
    const btnNewChantier       = document.getElementById('btn-new-chantier');
    const modalNewChantier     = document.getElementById('modal-new-chantier');
    const formNewChantier      = document.getElementById('form-new-chantier');
    const btnCancelNewChantier = document.getElementById('btn-cancel-new-chantier');
    const btnCloseNewChantier  = document.getElementById('btn-close-new-chantier');
    const newChantierError     = document.getElementById('new-chantier-error');

    function openNewChantierModal(){
      if(modalNewChantier) modalNewChantier.classList.add('active');
      if(newChantierError) newChantierError.textContent = "";
      if(formNewChantier) formNewChantier.reset();
    }
    function closeNewChantierModal(){
      if(modalNewChantier) modalNewChantier.classList.remove('active');
    }

    if(btnNewChantier){
      btnNewChantier.addEventListener('click', openNewChantierModal);
    }
    if(btnCancelNewChantier){
      btnCancelNewChantier.addEventListener('click', closeNewChantierModal);
    }
    if(btnCloseNewChantier){
      btnCloseNewChantier.addEventListener('click', closeNewChantierModal);
    }

    if(formNewChantier){
      formNewChantier.addEventListener('submit', async (e)=>{
        e.preventDefault();
        newChantierError.textContent = "";

        const fd = new FormData(formNewChantier);
        const ref = (fd.get('ref_chantier') || '').toString().trim();
        if(!ref){
          newChantierError.textContent = "Merci de renseigner une r√©f√©rence.";
          return;
        }

        try{
          const params = new URLSearchParams();
          params.append('path','bo');
          params.append('action','create_chantier');
          for(const [k,v] of fd.entries()){
            params.append(k, v.toString());
          }

          const resp = await fetch(WEB_APP_URL, {
            method:'POST',
            body: params
          });
          const json = await resp.json();
          if(!json.ok){
            console.log('create_chantier error', json);
            newChantierError.textContent = "Erreur lors de l‚Äôenregistrement.";
            return;
          }

          closeNewChantierModal();
          await loadChantiersList();
          await loadDashboardKpis();
        }catch(err){
          console.log('create_chantier exception', err);
          newChantierError.textContent = "Erreur r√©seau, impossible d‚Äôenregistrer.";
        }
      });
    }

    // =========================
    // DOCUMENTS
    // =========================
    async function loadDocsList(){
      const j = await fetchJson(`${WEB_APP_URL}?path=bo&resource=documents`, {cache:'no-store'});
      if(!j.ok) return;
      DOCS_CACHE = Array.isArray(j.data) ? j.data : [];
      renderDocsList(DOCS_CACHE);
    }

    function renderDocsList(rows){
      const list  = document.getElementById('docs-list');
      const label = document.getElementById('docs-count-label');
      if(!list) return;
      list.innerHTML = '';

      if(!rows || rows.length === 0){
        const div = document.createElement('div');
        div.style.fontSize = '0.78rem';
        div.style.color = 'var(--text-soft)';
        div.textContent = "Aucun document enregistr√©.";
        list.appendChild(div);
        if(label) label.textContent = "0 document";
        return;
      }

      if(label) label.textContent = rows.length + (rows.length>1 ? " documents" : " document");

      rows.forEach(d=>{
        const item = document.createElement('div');
        item.className = 'pill-item';

        const top = document.createElement('div');
        top.className = 'pill-top';

        const cat = document.createElement('strong');
        cat.textContent = d.categorie || '‚Äî';

        const link = document.createElement('a');
        link.href = d.lien || '#';
        link.target = "_blank";
        link.rel    = "noopener";
        link.textContent = d.libelle || d.lien || 'Ouvrir';

        top.appendChild(cat);
        top.appendChild(link);

        const meta = document.createElement('div');
        meta.className = 'pill-meta';
        if(d.commentaire){
          const span = document.createElement('span');
          span.textContent = d.commentaire;
          meta.appendChild(span);
        }

        item.appendChild(top);
        item.appendChild(meta);

        list.appendChild(item);
      });
    }

    // Modal doc
    const btnNewDoc       = document.getElementById('btn-new-doc');
    const modalNewDoc     = document.getElementById('modal-new-doc');
    const formNewDoc      = document.getElementById('form-new-doc');
    const btnCancelNewDoc = document.getElementById('btn-cancel-new-doc');
    const btnCloseNewDoc  = document.getElementById('btn-close-new-doc');
    const newDocError     = document.getElementById('new-doc-error');

    function openNewDocModal(){
      if(modalNewDoc) modalNewDoc.classList.add('active');
      if(newDocError) newDocError.textContent = "";
      if(formNewDoc) formNewDoc.reset();
    }
    function closeNewDocModal(){
      if(modalNewDoc) modalNewDoc.classList.remove('active');
    }

    if(btnNewDoc){
      btnNewDoc.addEventListener('click', openNewDocModal);
    }
    if(btnCancelNewDoc){
      btnCancelNewDoc.addEventListener('click', closeNewDocModal);
    }
    if(btnCloseNewDoc){
      btnCloseNewDoc.addEventListener('click', closeNewDocModal);
    }

    if(formNewDoc){
      formNewDoc.addEventListener('submit', async (e)=>{
        e.preventDefault();
        newDocError.textContent = "";

        const fd = new FormData(formNewDoc);
        const libelle = (fd.get('libelle') || '').toString().trim();
        if(!libelle){
          newDocError.textContent = "Merci de renseigner un libell√©.";
          return;
        }

        try{
          const params = new URLSearchParams();
          params.append('path','bo');
          params.append('action','create_document');
          for(const [k,v] of fd.entries()){
            params.append(k, v.toString());
          }

          const resp = await fetch(WEB_APP_URL, {
            method:'POST',
            body: params
          });
          const json = await resp.json();
          if(!json.ok){
            console.log('create_document error', json);
            newDocError.textContent = "Erreur lors de l‚Äôenregistrement.";
            return;
          }

          closeNewDocModal();
          await loadDocsList();
          await loadDashboardKpis();
        }catch(err){
          console.log('create_document exception', err);
          newDocError.textContent = "Erreur r√©seau, impossible d‚Äôenregistrer.";
        }
      });
    }

    // =========================
    // NOTES
    // =========================
    async function loadNotesList(){
      const j = await fetchJson(`${WEB_APP_URL}?path=bo&resource=notes`, {cache:'no-store'});
      if(!j.ok) return;
      NOTES_CACHE = Array.isArray(j.data) ? j.data : [];
      renderNotesList(NOTES_CACHE);
    }

    function renderNotesList(rows){
      const list  = document.getElementById('notes-list');
      const label = document.getElementById('notes-count-label');
      if(!list) return;
      list.innerHTML = '';

      if(!rows || rows.length === 0){
        const p = document.createElement('p');
        p.style.fontSize = '0.78rem';
        p.style.color = 'var(--text-soft)';
        p.textContent = "Aucune note enregistr√©e.";
        list.appendChild(p);
        if(label) label.textContent = "0 note";
        return;
      }

      if(label) label.textContent = rows.length + (rows.length>1 ? " notes" : " note");

      rows.forEach(n=>{
        const item = document.createElement('div');
        item.className = 'note-item';

        const meta = document.createElement('div');
        meta.className = 'note-meta';

        const left = document.createElement('span');
        left.textContent = n.titre || 'Sans titre';

        const right = document.createElement('span');
        const tag = n.tag || '';
        const date = n.date_note ? formatDateFr(n.date_note) : '';
        right.textContent = [tag,date].filter(Boolean).join(" ¬∑ ");

        meta.appendChild(left);
        meta.appendChild(right);

        const body = document.createElement('div');
        body.innerHTML = (n.contenu || '').toString().replace(/\n/g,'<br>');

        item.appendChild(meta);
        item.appendChild(body);

        list.appendChild(item);
      });
    }

    // Modal note
    const btnNewNote       = document.getElementById('btn-new-note');
    const modalNewNote     = document.getElementById('modal-new-note');
    const formNewNote      = document.getElementById('form-new-note');
    const btnCancelNewNote = document.getElementById('btn-cancel-new-note');
    const btnCloseNewNote  = document.getElementById('btn-close-new-note');
    const newNoteError     = document.getElementById('new-note-error');

    function openNewNoteModal(){
      if(modalNewNote) modalNewNote.classList.add('active');
      if(newNoteError) newNoteError.textContent = "";
      if(formNewNote) formNewNote.reset();
    }
    function closeNewNoteModal(){
      if(modalNewNote) modalNewNote.classList.remove('active');
    }

    if(btnNewNote){
      btnNewNote.addEventListener('click', openNewNoteModal);
    }
    if(btnCancelNewNote){
      btnCancelNewNote.addEventListener('click', closeNewNoteModal);
    }
    if(btnCloseNewNote){
      btnCloseNewNote.addEventListener('click', closeNewNoteModal);
    }

    if(formNewNote){
      formNewNote.addEventListener('submit', async (e)=>{
        e.preventDefault();
        newNoteError.textContent = "";

        const fd = new FormData(formNewNote);
        const titre   = (fd.get('titre') || '').toString().trim();
        const contenu = (fd.get('contenu') || '').toString().trim();

        if(!titre && !contenu){
          newNoteError.textContent = "Merci de saisir au moins un titre ou un contenu.";
          return;
        }

        try{
          const params = new URLSearchParams();
          params.append('path', 'bo');
          params.append('action', 'create_note');
          for(const [k,v] of fd.entries()){
            params.append(k, v.toString());
          }

          const resp = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: params
          });
          const json = await resp.json();
          if (!json.ok) {
            console.log('create_note error', json);
            newNoteError.textContent = "Erreur lors de l‚Äôenregistrement.";
            return;
          }

          closeNewNoteModal();
          await loadNotesList();
          await loadDashboardKpis();
        } catch (err) {
          console.log('create_note exception', err);
          newNoteError.textContent = "Erreur r√©seau, impossible d‚Äôenregistrer.";
        }
      });
    }

    // =========================
    // PARTENAIRES
    // =========================
    async function loadPartenairesList(){
      const j = await fetchJson(`${WEB_APP_URL}?path=bo&resource=partenaires`, {cache:'no-store'});
      if(!j.ok) return;
      PARTENAIRES_CACHE = Array.isArray(j.data) ? j.data : [];
      renderPartenairesList(PARTENAIRES_CACHE);
    }

    function renderPartenairesList(rows){
      const list  = document.getElementById('partenaires-list');
      const label = document.getElementById('partenaires-count-label');
      if(!list) return;
      list.innerHTML = '';

      if(!rows || rows.length === 0){
        const div = document.createElement('div');
        div.style.fontSize = '0.78rem';
        div.style.color = 'var(--text-soft)';
        div.textContent = "Aucun partenaire enregistr√©.";
        list.appendChild(div);
        if(label) label.textContent = "0 partenaire";
        return;
      }

      if(label) label.textContent = rows.length + (rows.length>1 ? " partenaires" : " partenaire");

      rows.forEach(p=>{
        const item = document.createElement('div');
        item.className = 'pill-item';

        const top = document.createElement('div');
        top.className = 'pill-top';

        const name = document.createElement('strong');
        name.textContent = p.nom || '‚Äî';

        const coord = document.createElement('span');
        coord.style.fontSize = '0.78rem';
        coord.style.color = 'var(--text-soft)';
        const tel  = p.telephone || '';
        const mail = p.email || '';
        coord.textContent = [tel,mail].filter(Boolean).join(" ¬∑ ");

        top.appendChild(name);
        top.appendChild(coord);

        const meta = document.createElement('div');
        meta.className = 'pill-meta';

        if(p.specialite){
          const s = document.createElement('span');
          s.textContent = "Sp√©cialit√© : " + p.specialite;
          meta.appendChild(s);
        }
        if(p.ville){
          const s = document.createElement('span');
          s.textContent = p.ville;
          meta.appendChild(s);
        }

        item.appendChild(top);
        item.appendChild(meta);

        list.appendChild(item);
      });
    }

    // =========================
    // TEST CONNEXION (PING)
    // =========================
    const btnTestConnexion = document.getElementById('btn-test-connexion');
    if(btnTestConnexion){
      btnTestConnexion.addEventListener('click', async ()=>{
        statusConnexion.textContent = "Test de connexion en cours‚Ä¶";
        const j = await fetchJson(`${WEB_APP_URL}?path=ping`, { cache: 'no-store' });
        if(j.ok){
          statusConnexion.textContent = "Connexion OK ‚úî (ping)";
        }else{
          statusConnexion.textContent = "Erreur connexion ‚úñ : " + (j.error || "inconnue");
        }
      });
    }
  </script>
</body>
</html>
